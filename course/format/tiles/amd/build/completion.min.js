/**
 * Load the format_tiles JavaScript for the course edit settings page /course/edit.php?id=xxx
 *
 * @module      format_tiles/completion
 * @copyright   2018 David Watson {@link http://evolutioncode.uk}
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("format_tiles/completion",["jquery","core/templates","core/config","core/ajax"],(function($,Templates,config,ajax){var courseId,dataKeys_cmid="data-cmid",dataKeys_numberOutOf="data-numoutof",dataKeys_section="data-section",dataKeys_completionState="data-state",Selector_launchModuleModal='[data-action="launch-tiles-module-modal"]',Selector_launchResourceModal='[data-action="launch-tiles-resource-modal"]',Selector_activity="li.activity",Selector_section="li.section.main",Selector_togglecompletion='[data-action="change-completion-status"]',Selector_tileId="#tile-",Selector_progressIndicatorId="#tileprogress-",Selector_tile=".tile",Selector_spacer=".spacer",Selector_availabilityinfo=".availabilityinfo",progressTemplateData=function(tileId,numComplete,outOf,asPercent){var data={tileid:tileId,numComplete:numComplete,numOutOf:outOf,showAsPercent:asPercent,percent:outOf>0?Math.round(numComplete/outOf*100):0,percentCircumf:106.8,percentOffset:outOf>0?Math.round((outOf-numComplete)/outOf*106.8):0,isComplete:!1,isSingleDigit:!1,hastilephoto:$(Selector_tileId+tileId).hasClass("phototile")};return data.isOverall=0===tileId?1:0,outOf>0&&numComplete>=outOf&&(data.isComplete=!0),data.percent<10&&(data.isSingleDigit=!0),data};const triggerCompletionChangedEvent=function(sectionNum){$(document).trigger("format-tiles-completion-changed",{section:parseInt(sectionNum)})},updateSectionsInfo=function(sections,overallcomplete,overalloutof){sections.forEach((sec=>{const tile=$(Selector_tileId+sec.sectionnum);sec.isavailable&&tile.hasClass("tile-restricted")?tile.removeClass("tile-restricted"):sec.isavailable||tile.addClass("tile-restricted"),sec.isclickable&&!tile.hasClass("tile-clickable")?tile.addClass("tile-clickable"):!sec.isclickable&&tile.hasClass("tile-clickable")&&tile.removeClass("tile-clickable"),sec.iscomplete?tile.addClass("is-complete"):tile.removeClass("is-complete");const progressIndicator=$(Selector_progressIndicatorId+sec.sectionnum);var sectionNum,tileProgressIndicator,newTileProgressValue,newValue,outOf;sectionNum=sec.sectionnum,tileProgressIndicator=progressIndicator,(newTileProgressValue=sec.numcomplete)<0||newTileProgressValue>tileProgressIndicator.attr(dataKeys_numberOutOf)||sectionNum&&Templates.render("format_tiles/progress",progressTemplateData(sectionNum,newTileProgressValue,parseInt(tileProgressIndicator.attr(dataKeys_numberOutOf)),tileProgressIndicator.hasClass("percent"))).done((function(html){tileProgressIndicator.replaceWith(html)})),newValue=overallcomplete,outOf=overalloutof,Templates.render("format_tiles/progress",progressTemplateData(0,newValue,outOf,!0)).done((function(html){$("#tileprogress-0").replaceWith(html).fadeOut(0).animate({opacity:1},500)}));const availabilityInfoDiv=tile.find(Selector_availabilityinfo);availabilityInfoDiv.length>0&&sec.isavailable&&!sec.availabilitymessage?availabilityInfoDiv.fadeOut():!sec.isavailable&&sec.availabilitymessage&&(availabilityInfoDiv.length>0?(availabilityInfoDiv.html="NEW"+sec.availabilitymessage,availabilityInfoDiv.fadeIn()):Templates.render("format_tiles/availability_info",{availabilitymessage:sec.availabilitymessage,visible:!0}).done((function(html){progressIndicator.replaceWith(html)})))}))};return{init:function(courseIdInit){courseId=courseIdInit,$(document).ready((function(){$("body").on("click",Selector_togglecompletion,(function(e){e.preventDefault();const target=$(e.currentTarget);var cmid,completed;cmid=target.attr(dataKeys_cmid),completed="1"!==target.attr(dataKeys_completionState),ajax.call([{methodname:"format_tiles_update_activity_completion_status_manually",args:{cmid:cmid,completed:completed}}])[0].done((res=>{if(res.status){const section=$("#module-"+cmid).closest(Selector_section).attr(dataKeys_section);section&&triggerCompletionChangedEvent(section);const checkBox=$(Selector_togglecompletion+'[data-cmid="'+cmid+'"]');checkBox&&(checkBox.attr(dataKeys_completionState,completed?"1":"0"),completed?checkBox.addClass("complete"):checkBox.removeClass("complete"))}})).fail((err=>{require(["core/log"],(function(log){log.debug("Failed to set completion state"),log.debug(err)}))}))}));var pageContent=$("#page-content");0===pageContent.length&&(pageContent=$("#region-main")),pageContent.on("click",Selector_launchModuleModal+", "+Selector_launchResourceModal,(function(e){var clickedActivity=$(e.currentTarget).closest(Selector_activity);clickedActivity.hasClass("completeonview")&&triggerCompletionChangedEvent(clickedActivity.closest(Selector_section).attr(dataKeys_section))})),$(window).on("focus",(function(){const openSection=$("li.section.state-visible").attr("data-section");triggerCompletionChangedEvent(openSection)}))}))},triggerCompletionChangedEvent:function(sectionNum){triggerCompletionChangedEvent(sectionNum)},updateTileInformation:function(sectionNumbers){try{void 0===(sectionNums=sectionNumbers)&&(sectionNums=$(Selector_tile).not(Selector_spacer).map(((i,t)=>parseInt($(t).attr(dataKeys_section)))).toArray()),ajax.call([{methodname:"format_tiles_get_section_information",args:{courseid:courseId,sectionnums:sectionNums}}])[0].done((res=>{updateSectionsInfo(res.sections,res.overall.complete,res.overall.outof)})).fail((err=>{require(["core/log"],(function(log){log.debug("Failed to get section information to check completion status of section"),log.debug(err)}))}))}catch(err){require(["core/log"],(function(log){log.debug(err)}))}var sectionNums},updateSectionsInfo:function(sections,overallcomplete,overalloutof){updateSectionsInfo(sections,overallcomplete,overalloutof)}}}));

//# sourceMappingURL=completion.min.js.map