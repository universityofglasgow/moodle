# Introduction and Goals



## Requirements Overview 

This describes the requirements for the staff-facing side of the new GCAT development.

## General description

The code is organised as a conventional Moodle 'local' plugin. The facilities in lib.php are used to tie the plugin into the Moodle navigation. It appears in the 'More..' tab/menu of each Moodle course. This link maps to the index.php file which is located in the ui/dist folder (more about this later) with a single parameter - the course id. 

The user interface is coded in ['Vue.js'](https://vuejs.org/), in particular it utlises the [Vue CLI](https://cli.vuejs.org/) 'Vue standard tooling'.  See the [vue.md](vue.md) file for more details. 

The index.php file is quite simple. It contains the usual Moodle boilerplate - header, footer, login and capability checks, and so on. It loads a number of javascript libraries - these consist of both a Moodle AMD module defined in the plugin and the javascript generated by the Vue tooling. The actual page content contains only a div which will be controlled by Vue. 

As Vue runs entirely client-side, its interaction with Moodle is via web services. Normal Moodle web service calls are used. Each custom web service is given its own class in 'classes/external'. Most of the non-UI processing originates with these web services. 

The classes/ directory also contains a number of classes that contain static shared functions. These functions should be comprehensively commented. 

# Organisation of code

* The plugin is written as a Moodle "local plugin". See https://moodledev.io/docs/apis/plugintypes/local
* The basic organisation is to code the user interface in Javascript and the "business logic" in PHP.
* The user interface is primarily developed using the [Vue CLI](https://cli.vuejs.org/) javascript library and tooling
* The user interface access the backend using web services. This leverages Moodle's standard web service library. See https://moodledev.io/docs/apis/subsystems/external
* Some 'glue logic' is coded as a Moodle AMD module to allow the Vue code to access Moodle's javascript modules (e.g. strings, ajax, notifications). 

## Interfaces

In general, the plugin will access existing Moodle APIs and database tables. Some of these are as follows...

* The Gradebook tables and API are used to access a number of items:
    * Gradeable items (e.g. grades activities, manual grades)
    * Gradebook structure (grade category tree structure and containing grade items)
    * Grade category settings (aggregation schema)
    * Grade item settings (hidden, overridden and so on)
* The Moodle course module API to discover details about individual activities
* Moodle Assignment database tables / API. Assignment is a special case in that it we need to support hidden grading, workflow status and the activity manipulating its own grades. 
* Data will be uploaded through the UI both manually and by CSV upload
* The plugin has its own data structures and these will either be directly accessible and/or through an API (TBD) for student dashboard and/or reporting. 

### Linking to moodle

The plugin uses Moodle standard navigation APIs to add the link to 'UofG Grades' into each course's "More..." menu.

# Detailed code layout

## "Backend" implementation

The backend / business logic is written as PHP classes and is primarily exposed through normal Moodle external APIs (web services). These are supported by utility classes for commonly/repeatedly used functions. 

Each API function is accessible in two places. The parameters etc. are the same. They can all be accessed either as a static method in classes/api.php or by a Moodle web service. Note that Moodle web services are self-documenting (see developer docs)

The current web service functions are as follows:

| API Function         | Description
|----------------------|---------------------------------------------------------------------------- |
| [get_activities](../classes/external/get_activities.php) | Given the course id a tree-structured list of activities (organised by grade category structure) is returned. This is primarily used to structure selection UI to select current, active grade item. |
| [get_audit](../classes/external/get_audit.php) | Returns audit trail for given userid |
| [get_capture_page](../classes/external/get_capture_page.php)| Given the ID of the selected activity this returns all the data needed to display the current table of the grade capture page. This includes all the students who can access the selected activity. |
| [get_grade_item](../classes/external/get_grade_item.php)| Returns full details of the selected grad item. |
| [get_history] | (../classes/external/get_history.php) | Given a gradeitem and userid, the list of updates to that grade (for display as grade history) |
| [get_levelonecategories](../classes/external/get_levelonecategories.php) | Lists the top level grade categories for the initial selection (e.g. Summative / Formative) |
| [get_user_grades](../classes/external/get_user_grades.php) | Returns all the grades for a given user id - site wide |
| [get_user_picture_url](../classes/external/get_user_picture_url.php) | Return URL of user avatar/image |
| [import_grade](../classes/external/import_grade.php) | Import first grade for given itemid and userid |
| [import_grades_users](../classes/external/import_grades_users.php) | Import grade for list of userids given itemid |

## Activity classes

In order to interface with different activies (and grade) types, a set of classes have been created. These are implemented such that if a class exists for a specific activity (e.g. Assignment) then that class will be instantiated. If no class exists then a 'default' class is instantiated giving "lowest common demoninator" functionality. A special case is manual grades which have their own class. The classes implement an interface, [activity_interface](../classes/activities/activity_interface.php)

Current implemented classes are as follows

| Class name              | Description
|-------------------------|--------------------------------------|
| [assign_activity](../classes/activities/assign_activity.php) | Assign activity class |
| [manual](../classes/activities/manual.php) | Special case for handling manual grade items |
| [default_activity](../classes/activities/default_activity.php) | Used if no other class exists |


## User interface

The user interface is written entirely in Vue.js.  This is effectively allows new HTML elements to be created as what Vue calls "components". These contain all logic and presentation to render that element. 
Properties and events are fully supported.

This implies a hierarchy of functionality. The components leverage Moodle ajax calls to interact with the backend. 

The current Components are as follows:

| Component            | Description
|----------------------|--------------------------------------------------------------|
| [App](../ui/src/App.vue) | Top level of UI. Called from the plugin's index.php |
| [ActivitySelect](../ui/src/components/ActivitySelect.vue) | Parent of ActivityTree. Fetches the list of activities/grade and displays them using ActivityTree. Emits the resulting selection. |
| [ActivityTree](../ui/src/components/ActivityTree.vue) | Constructs a tree structure of grade categories and grade-items. User selects current item. View changes to the selected item until clicked again |
| [AddGradeButton](../ui/src/components/AddGradeButton.vue) | Displays the 'Add grade' button and processes what happens when it's clicked |
| [CaptureAggregation](../ui/src/views/CaptureAggregation.vue) | Container for the capture and aggregation screens |
| [CaptureGrades](../ui/src/components/CaptureGrades.vue) | Displays the first grade cell in the capture table |
| [CaptureTable](../ui/src/components/CaptureTable.vue) | Paginated table of users and grades during capture |
| [HistoryButton](../ui/src/components/HistoryButton.vue) | Displays the 'History' button on the capture table and processes it when clicked. |
| [ImportButton](../ui/src/components/ImportButton.vue) | Displays the 'Import' button above the capture table and processes it when clicked. |
| [InitialBar](../ui/src/components/InitialBar.vue) | Used by NameFilter - shows one line of letters |
| [LevelOneSelect](../ui/src/components/LevelOneSelect.vue) | Shows a drop down to select the top level grade category (Note that if there are none an error is displayed) |
| [ModalForm](../ui/src/components/ModalForm.vue) | Displays a general purpose modal popup |
| [MString](../ui/src/components/MString.vue) | Looks up a string in Moodle |
| [NameFilter](../ui/src/components/NameFilter.vue) | Replicates Moodle's standard initial letter name filter in Vue |
| [PagingBar](../ui/src/components/PagingBar.vue) | Allows page to be selected when sufficient students to paginate table |
| [TabsNav](../ui/src/components/TabsNav.vue) | Shows tabs to select Grade capture, Aggregation and Settings |
| [UserPicture](../ui/src/components/UserPicture.vue) | Displays user avatar |

# Logging

Standard Moodle event logging is used for critical functions. This records "Person X did Y" type events. 

| Event               | Description
|---------------------|--------------------|
| [import_grades_users](../classes/event/import_grades_users.php) | Grade import button has been pressed |
| [view_gugrades](../classes/event/view_gugrades.php) | Tool has been viewed |

# Audit

Somewhat similar to logging but this functionality stores specific audit data for actions performed within the tool. The user
can choose to display their audit and it will show a comprehensive list of operations undertaken, plus errors and warnings generated. 

This is implemented on the server/PHP side by a classes in the classes/audit directory. A class 'base.php' defines the basic functionality
and classes for each audit type extend this. Each class should define its own constructor to 'collect' the data that it requires pertinent
to that operation. The base class 'save' function writes the data to the databse.

Current audit classes are as follows...

| Audit              | Description
|--------------------|------------------------|
| [import_grades_users](../classes/audit/import_grades_users.php) | User has completed the import grades function |
| [nottoplevel] | Tool has detected that no grade categories have been defined, indicating that the Gradebook has not been configured |
