{"version":3,"file":"usedfiles.min.js","sources":["../src/usedfiles.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Media Manager usedfiles.\n *\n * @module      tiny_media/usedfiles\n * @copyright   2022, Stevani Andolo <stevani@hotmail.com.au>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Templates from 'core/templates';\nimport Config from 'core/config';\n\nclass UsedFileManager {\n    constructor(files, userContext, itemId, elementId) {\n        this.files = files;\n        this.userContext = userContext;\n        this.itemId = itemId;\n        this.elementId = elementId;\n    }\n\n    getElementId() {\n        return this.elementId;\n    }\n\n    getUsedFiles() {\n        const editor = window.parent.tinymce.EditorManager.get(this.getElementId());\n        if (!editor) {\n            window.console.error(`Editor not found for ${this.getElementId()}`);\n            return [];\n        }\n        const content = editor.getContent();\n        const baseUrl = `${Config.wwwroot}/draftfile.php/${this.userContext}/user/draft/${this.itemId}/`;\n        const pattern = new RegExp(\"[\\\"']\" + baseUrl.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&') + \"(?<filename>.+?)[\\\\?\\\"']\", 'gm');\n\n        const usedFiles = [...content.matchAll(pattern)].map((match) => decodeURIComponent(match.groups.filename));\n\n        return usedFiles;\n    }\n\n    // Return an array of unused files.\n    findUnusedFiles(usedFiles) {\n        return Object.entries(this.files)\n            .filter(([filename]) => !usedFiles.includes(filename))\n            .map(([filename]) => filename);\n    }\n\n    // Return an array of missing files.\n    findMissingFiles(usedFiles) {\n        return usedFiles.filter((filename) => !this.files.hasOwnProperty(filename));\n    }\n\n    updateFiles() {\n        const form = document.querySelector('form');\n        const usedFiles = this.getUsedFiles();\n        const unusedFiles = this.findUnusedFiles(usedFiles);\n        const missingFiles = this.findMissingFiles(usedFiles);\n\n        form.querySelectorAll('input[type=checkbox][name^=\"deletefile\"]').forEach((checkbox) => {\n            if (!unusedFiles.includes(checkbox.dataset.filename)) {\n                checkbox.closest('.fitem').remove();\n            }\n        });\n\n        form.classList.toggle('has-missing-files', !!missingFiles.length);\n        form.classList.toggle('has-unused-files', !!unusedFiles.length);\n\n        return Templates.renderForPromise('tiny_media/missingfiles', {\n            missingFiles,\n        }).then(({html, js}) => {\n            Templates.replaceNodeContents(form.querySelector('.missing-files'), html, js);\n            return;\n        });\n    }\n}\n\nexport const init = (files, usercontext, itemid, elementid) => {\n    const manager = new UsedFileManager(files, usercontext, itemid, elementid);\n    manager.updateFiles();\n\n    return manager;\n};\n"],"names":["obj","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","Templates","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_config","UsedFileManager","constructor","files","userContext","itemId","elementId","this","getElementId","getUsedFiles","editor","window","parent","tinymce","EditorManager","console","error","concat","content","getContent","baseUrl","Config","wwwroot","pattern","RegExp","replace","matchAll","map","match","decodeURIComponent","groups","filename","findUnusedFiles","usedFiles","entries","filter","_ref","includes","_ref2","findMissingFiles","updateFiles","form","document","querySelector","unusedFiles","missingFiles","querySelectorAll","forEach","checkbox","dataset","closest","remove","classList","toggle","length","renderForPromise","then","_ref3","html","js","replaceNodeContents","_exports","init","usercontext","itemid","elementid","manager"],"mappings":"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"}