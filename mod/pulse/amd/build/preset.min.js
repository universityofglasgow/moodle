define ("mod_pulse/preset",["jquery","core/modal_factory","mod_pulse/modal_preset","mod_pulse/events","core/str","core/fragment","core/ajax","core/templates","core/loadingicon","core/notification","core/modal_events"],function(a,b,c,d,e,f,g,h,i,j,k){var l={presetAvailability:".preset-config-params .availability-field"},m=function(a,b,c){this.contextId=a;this.courseid=b;this.section=c;this.loadPresetsList()};m.prototype.listElement={selector:"pulse-presets-data",loaded:"data-listloaded"};m.prototype.contextId=0;m.prototype.courseid=0;m.prototype.section=0;m.prototype.pageparams=[];m.prototype.loadIconElement=".modal-footer #loader-icon";m.prototype.actionbuttons=".modal-footer button";m.prototype.setupmodal=function(){var a=this,g=this,h=document.querySelectorAll(".pulse-usepreset"),m=document.createElement("div");m.classList.add("modal-preset");h.forEach(function(h){return h.addEventListener("click",function(){var n=h.getAttribute("data-presetid"),o=h.getAttribute("data-presettitle"),p={presetid:n,courseid:g.courseid,section:g.section};document.body.prepend(m);b.create({type:c.TYPE,title:e.get_string("presetmodaltitle","pulse",{title:o}),body:f.loadFragment("mod_pulse","get_preset_preview",g.contextId,p),large:!0}).then(function(b){b.attachmentPoint=m;b.show();b.getRoot().on(k.bodyRendered,function(){g.reinitAvailability(l.presetAvailability);g.fieldChangedEvent()});b.getRoot().on(k.hidden,function(){b.destroy.bind(b);g.reinitAvailability()});b.getRoot().on(d.customize,function(){var c=document.querySelector("#mod-pulse-form"),d=new FormData(c);b.getRoot().get(0).querySelectorAll("form").forEach(function(c){var e=new FormData(c);e=new URLSearchParams(e).toString();var f=new URLSearchParams(d).toString();p={formdata:e,pageparams:f};i.addIconToContainer(a.loadIconElement);g.disableButtons();g.applyCustomize(p,g.contextId,b)})});b.getRoot().on(d.save,function(c){c.preventDefault();i.addIconToContainer(a.loadIconElement);g.disableButtons();var d={};b.getRoot().get(0).querySelectorAll("form").forEach(function(b){d=new FormData(b);a.restorePreset(d,g.contextId)})});return!0}).catch(j.exception)})})};m.prototype.fieldChangedEvent=function(){var a=document.getElementById("preset-configurable-params"),b=["fixed","relative"],c,d,e,f,g;a.querySelectorAll("input, select, textarea").forEach(function(b){b.addEventListener("change",function(b){c=b.target.getAttribute("name");if(null!==a.querySelector("input[name=\""+c+"_changed\"]")){a.querySelector("input[name=\""+c+"_changed\"]").value=!0}})});["first","second","recurring"].forEach(function(c){a.querySelectorAll("[name=\""+c+"_schedule\"").forEach(function(b){b.addEventListener("change",function(b){f=b.target.getAttribute("name");d="input[name=\""+f+"_arr_changed\"]";a.querySelector(d).value=!0})});b.forEach(function(b){e=c+"_"+b+"date";a.querySelectorAll("[name*=\""+e+"\"]").forEach(function(b){b.addEventListener("change",function(b){g=b.target.getAttribute("name").split("[");f=g.hasOwnProperty(1)?g[0]:g;d="input[name=\""+f+"_changed\"]";a.querySelector(d).value=!0})})})})};m.prototype.reinitAvailability=function(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:".availability-field";if("undefined"!=typeof M.core_availability.form){this.resetRestrictPlugins();document.querySelectorAll(a).forEach(function(a){return a.parentNode.removeChild(a)});M.core_availability.form.init()}};m.prototype.resetRestrictPlugins=function(){if("undefined"!=typeof M.core_availability.form&&null!==document.getElementById("id_availabilityconditionsjson")){M.core_availability.form.restrictByGroup=null;var a="undefined"!=typeof M.core_availability.form.plugins?M.core_availability.form.plugins:{},b="";for(var c in a){b="availability_"+c;if(M.hasOwnProperty(b)){M[b].form.addedEvents=!1}}}};m.prototype.applyCustomize=function(a,b,c){var d=this;f.loadFragment("mod_pulse","apply_preset",b,a).done(function(a,b){c.destroy();d.resetRestrictPlugins();d.handleFormSubmissionResponse(a,b)})};m.prototype.disableButtons=function(){var a=document.querySelectorAll(this.actionbuttons);for(var b in a){a[b].disabled=!0}};m.prototype.handleFormSubmissionResponse=function(a,b){var c=document.createElement("div");c.innerHTML=a;h.replaceNode("[action=\"modedit.php\"]",a,b)};m.prototype.restorePreset=function(a,b){var c=new URLSearchParams(a).toString(),d=g.call([{methodname:"mod_pulse_apply_presets",args:{contextid:b,formdata:c}}]);d[0].done(function(a){a=JSON.parse(a);if("undefined"!=typeof a.url){window.location.href=a.url}})};m.prototype.loadPresetsList=function(){var a=this,b=document.getElementById(this.listElement.selector);if(null!==b){if("false"==b.getAttribute(this.listElement.loaded)){f.loadFragment("mod_pulse","get_presetslist",this.contextId,{courseid:this.courseid}).done(function(c,d){h.replaceNodeContents(b,c,d);b.setAttribute(a.listElement.loaded,"true");a.setupmodal()})}}};return{init:function init(a,b,c){new m(a,b,c)}}});
//# sourceMappingURL=preset.min.js.map
