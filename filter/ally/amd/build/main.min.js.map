{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * Main library.\n *\n * @package\n * @author    Guy Thomas\n * @copyright Copyright (c) 2016 Open LMS\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\ndefine(['jquery', 'core/templates', 'core/str', 'filter_ally/ally', 'filter_ally/imagecover', 'filter_ally/util'],\nfunction($, Templates, Strings, Ally, ImageCover, Util) {\n    return new function() {\n\n        var self = this;\n\n        self.canViewFeedback = false;\n        self.canDownload = false;\n        self.initialised = false;\n        self.params = {};\n\n        /**\n         * Get nodes by xpath.\n         * @param {string} xpath\n         * @returns {Array}\n         */\n        var getNodesByXpath = function(xpath) {\n            var expression = window.document.createExpression(xpath);\n            var result = expression.evaluate(window.document, XPathResult.ANY_TYPE);\n            var nodes = [];\n            do {\n                var node = result.iterateNext();\n                nodes.push(node);\n            } while (node);\n            return nodes;\n        };\n\n        /**\n         * Get single node by xpath.\n         * @param {string} xpath\n         * @returns {Node}\n         */\n        var getNodeByXpath = function(xpath) {\n            var expression = window.document.createExpression(xpath);\n            var result = expression.evaluate(window.document, XPathResult.FIRST_ORDERED_NODE_TYPE);\n            return result.singleNodeValue;\n        };\n\n        /**\n         * Render template and insert result in appropriate place.\n         * @param {object} data\n         * @param {string} pathHash\n         * @param {node} targetEl\n         * @return {promise}\n         */\n        var renderTemplate = function(data, pathHash, targetEl) {\n            var dfd = $.Deferred();\n\n            if ($(targetEl).parents('.filter-ally-wrapper').length) {\n                // This has already been processed.\n                dfd.resolve();\n                return dfd.promise();\n            }\n\n            // Too expensive to do at module level - this is a course level capability.\n            data.canviewfeedback = self.canViewFeedback;\n            data.candownload = self.canDownload;\n            data.html = '<span id=\"content-target-' + pathHash + '\"></span>';\n\n            Templates.render('filter_ally/wrapper', data)\n                .done(function(result) {\n                    var presentWrappers = $(targetEl).next().find('span[data-file-id=\"'+ pathHash +'\"]');\n                    if (presentWrappers.length == 0) {\n                        $(targetEl).after(result);\n\n                        // We are inserting the module element next to the target as opposed to replacing the\n                        // target as we want to ensure any listeners attributed to the module element persist.\n                        $('#content-target-' + pathHash).after(targetEl);\n                        $('#content-target-' + pathHash).remove();\n                    }\n                    dfd.resolve();\n                });\n\n            return dfd.promise();\n        };\n\n        /**\n         * Place holder items that are matched by selector.\n         * @param {string} selector\n         * @param {string} map\n         * @return {promise}\n         */\n        var placeHoldSelector = function(selector, map) {\n            var dfd = $.Deferred();\n\n            var c = 0;\n\n            var length = $(selector).length;\n            if (!length) {\n                dfd.resolve();\n            }\n            $(selector).each(function() {\n\n                /**\n                 * Check that all selectors have been processed.\n                 */\n                var checkComplete = function() {\n                    if (c === length) {\n                        dfd.resolve();\n                    }\n                };\n                var url,\n                    type;\n\n                if ($(this).prop(\"tagName\").toLowerCase() === 'a') {\n                    url = $(this).attr('href');\n                    type = 'a';\n                } else {\n                    url = $(this).attr('src');\n                    type = 'img';\n                }\n                var regex;\n                if (url.indexOf('?') > -1) {\n                    regex = /pluginfile.php\\/(\\d*)\\/(.*)(\\?)/;\n                } else {\n                    regex = /pluginfile.php\\/(\\d*)\\/(.*)/;\n                }\n                var match = url.match(regex);\n                var pathHash;\n                if (match) {\n                    var path = match[1] + '/' + match[2];\n                    path = decodeURIComponent(path);\n                    pathHash = map[path];\n                }\n\n                if (pathHash === undefined) {\n                    // Maybe 'slasharguments' setting is disabled for this host.\n                    // Let's see if the file URI is found in the URL query.\n                    var query = Util.getQuery(url);\n                    if (query.file) {\n                        var filePath = decodeURIComponent(query.file);\n                        regex = /\\/(\\d*)\\/(.*)/;\n\n                        match = filePath.match(regex);\n                        if (match) {\n                            path = match[1] + '/' + match[2];\n                            path = decodeURIComponent(path);\n                            pathHash = map[path];\n                        }\n                    }\n                }\n\n                // Pathhash was definitely not found :( .\n                if (pathHash === undefined) {\n                    c++;\n                    checkComplete();\n                    return;\n                }\n\n                var data = {\n                    isimage: type === 'img',\n                    fileid: pathHash,\n                    url: url\n                };\n\n                renderTemplate(data, pathHash, $(this))\n                    .done(function(){\n                        c++;\n                        checkComplete();\n                    });\n            });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for forum module image attachments (note, regular files are covered by php).\n         * @param {array} forumFileMapping\n         * @return {promise}\n         */\n        var placeHoldForumModule = function(forumFileMapping) {\n            var dfd = $.Deferred();\n            placeHoldSelector('.forumpost .attachedimages img[src*=\"pluginfile.php\"], ' +\n                '.forumpost .body-content-container a[href*=\"pluginfile.php\"]', forumFileMapping)\n                .done(function(){\n                    dfd.resolve();\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for assign module additional files.\n         * @param {array} assignFileMapping\n         * @return {promise}\n         */\n        var placeHoldAssignModule = function(assignFileMapping) {\n            var dfd = $.Deferred();\n            Util.whenTrue(function() {\n                return $('div[id*=\"assign_files_tree\"] .ygtvitem').length > 0;\n            }, 10)\n                .done(function() {\n                    placeHoldSelector('div[id*=\"assign_files_tree\"] a[href*=\"pluginfile.php\"]', assignFileMapping);\n                    dfd.resolve();\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for folder module files.\n         * @param {array} folderFileMapping\n         * @return {promise}\n         */\n        var placeHoldFolderModule = function(folderFileMapping) {\n            var dfd = $.Deferred();\n            Util.whenTrue(function() {\n                return $('.foldertree > .filemanager .ygtvitem').length > 0;\n            }, 10)\n                .done(function() {\n                    var unwrappedlinks = '.foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*=\"pluginfile.php\"]';\n                    placeHoldSelector(unwrappedlinks, folderFileMapping)\n                        .done(function() {\n                            dfd.resolve();\n                        });\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for glossary module files.\n         * @param {array} glossaryFileMapping\n         * @return {promise}\n         */\n        var placeHoldGlossaryModule = function(glossaryFileMapping) {\n            var dfd = $.Deferred();\n\n            // Glossary attachment markup is terrible!\n            // The first thing we need to do is rewrite the glossary attachments so that they are encapsulated.\n            $('.entry .attachments > br').each(function() {\n                var mainAnchor = $(this).prev('a[href*=\"pluginfile.php\"]');\n                mainAnchor.addClass('ally-glossary-attachment');\n                var iconAnchor = $(mainAnchor).prev('a[href*=\"pluginfile.php\"]');\n                $(this).after('<div class=\"ally-glossary-attachment-row\"></div>');\n                var container = $(this).next('.ally-glossary-attachment-row');\n                container.append(iconAnchor);\n                container.append(mainAnchor);\n                $(this).remove();\n            });\n\n            var unwrappedlinks = '.entry .attachments .ally-glossary-attachment';\n            placeHoldSelector(unwrappedlinks, glossaryFileMapping)\n                .done(function() {\n                    dfd.resolve();\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Encode a file path so that it can be used to find things by uri.\n         * @param {string} filePath\n         * @returns {string}\n         */\n        var urlEncodeFilePath = function(filePath) {\n            var parts = filePath.split('/');\n            for (var p in parts) {\n                parts[p] = encodeURIComponent(parts[p]);\n            }\n            var encoded = parts.join('/');\n            return encoded;\n        };\n\n        /**\n         * General function for finding lesson component file elements and then add mapping.\n         * @param {array} map\n         * @param {string} selectorPrefix\n         * @return promise\n         */\n        var placeHoldLessonGeneral = function(map, selectorPrefix) {\n            var dfd = $.Deferred();\n            if (map.length === 0) {\n                dfd.resolve();\n            } else {\n                for (var c in map) {\n                    var path = urlEncodeFilePath(c);\n                    var sel = selectorPrefix + 'img[src*=\"' + path + '\"], ' + selectorPrefix + 'a[href*=\"' + path + '\"]';\n                    placeHoldSelector(sel, map).done(function() {\n                        dfd.resolve();\n                    });\n                }\n            }\n            return dfd.promise();\n        };\n\n        /**\n         * Placehold lesson page contents.\n         * @param {array} pageContentsMap\n         * @returns promise\n         */\n        var placeHoldLessonPageContents = function(pageContentsMap) {\n            return placeHoldLessonGeneral(pageContentsMap, '');\n        };\n\n        /**\n         * Placehold lesson answers.\n         * @param {array} pageAnswersMap\n         * @returns promise\n         */\n        var placeHoldLessonAnswersContent = function(pageAnswersMap) {\n            return placeHoldLessonGeneral(pageAnswersMap,\n                '.studentanswer table tr:nth-child(1) '); // Space at end of selector intended.\n        };\n\n        /**\n         * Placehold lesson responses.\n         * @param {array} pageResponsesMap\n         * @returns promise\n         */\n        var placeHoldLessonResponsesContent = function(pageResponsesMap) {\n            return placeHoldLessonGeneral(pageResponsesMap,\n                '.studentanswer table tr.lastrow '); // Space at end of selector intended.\n        };\n\n        /**\n         * Add place holders for lesson module files.\n         * @param {array} lessonFileMapping\n         * @return {promise}\n         */\n        var placeHoldLessonModule = function(lessonFileMapping) {\n            var dfd = $.Deferred();\n\n            var pageContentsMap = lessonFileMapping.page_contents;\n            var pageAnswersMap = lessonFileMapping.page_answers;\n            var pageResponsesMap = lessonFileMapping.page_responses;\n\n            placeHoldLessonPageContents(pageContentsMap)\n                .then(function() {\n                    return placeHoldLessonAnswersContent(pageAnswersMap);\n                })\n                .then(function() {\n                    return placeHoldLessonResponsesContent(pageResponsesMap);\n                })\n                .then(function() {\n                    dfd.resolve();\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for resource module.\n         * @param {object} moduleFileMapping\n         * @return {promise}\n         */\n        var placeHoldResourceModule = function(moduleFileMapping) {\n            var dfd = $.Deferred();\n            var c = 0;\n\n            /**\n             * Once all modules processed, resolve promise for this function.\n             */\n            var checkAllProcessed = function() {\n                c++;\n                // All resource modules have been dealt with.\n                if (c >= Object.keys(moduleFileMapping).length) {\n                    dfd.resolve();\n                }\n            };\n            for (var moduleId in moduleFileMapping) {\n                var pathHash = moduleFileMapping[moduleId]['content'];\n                if ($('body').hasClass('theme-snap') && !$('body').hasClass('format-tiles')) {\n                    var moduleEl = $('#module-' + moduleId + ':not(.snap-native) .activityinstance ' +\n                        '.snap-asset-link a:first-of-type:not(.clickable-region)');\n                } else if ($('body').hasClass('format-tiles')) {\n                    var moduleEl = $('#module-' + moduleId + ' .activityinstance ' +\n                        'a:first-of-type:not(.clickable-region,.editing_move)');\n                } else {\n                    var moduleEl = $('#module-' + moduleId + ' .activity-instance ' +\n                        'a:first-of-type:not(.clickable-region,.editing_move)');\n                }\n                var processed = moduleEl.find('.filter-ally-wrapper');\n                if (processed.length > 0) {\n                    checkAllProcessed(); // Already processed.\n                    continue;\n                }\n                var data = {\n                    isimage: false,\n                    fileid: pathHash,\n                    url: $(moduleEl).attr('href')\n                };\n                renderTemplate(data, pathHash, moduleEl)\n                    .done(checkAllProcessed);\n            }\n            return dfd.promise();\n        };\n\n        var buildContentIdent = function(component, table, field, id) {\n            return [component, table, field, id].join(':');\n        };\n\n        /**\n         * Add annotations to sections content.\n         * @param {array} sectionMapping\n         */\n        var annotateSections = function(sectionMapping) {\n            var dfd = $.Deferred();\n\n            for (var s in sectionMapping) {\n                var sectionId = sectionMapping[s];\n                var ident = buildContentIdent('course', 'course_sections', 'summary', sectionId);\n\n                var selectors = [\n                    '#' + s + ' > .content div[class*=\"summarytext\"] .no-overflow',\n                    'body.theme-snap #' + s + ' > .content > .summary > div > .no-overflow' // Snap.\n                ];\n                $(selectors.join(',')).attr('data-ally-richcontent', ident);\n            }\n\n            dfd.resolve();\n            return dfd.promise();\n        };\n\n        /**\n         * Annotate module introductions.\n         * @param {array} introMapping\n         * @param {string} module\n         * @param {array} additionalSelectors\n         */\n        var annotateModuleIntros = function(introMapping, module, additionalSelectors) {\n            for (var i in introMapping) {\n                var annotation = introMapping[i];\n                var selectors = [\n                    'body.path-mod-' + module + '.cmid-' + i + ' #intro > .no-overflow',\n                    // We need to be specific here for non course pages to skip this.\n                    'li.activity.modtype_' + module + '#module-' + i + ' .description .no-overflow > .no-overflow',\n                    'li.snap-activity.modtype_' + module + '#module-' + i + ' .contentafterlink > .no-overflow'\n                ];\n                if (additionalSelectors) {\n                    for (var a in additionalSelectors) {\n                        selectors.push(additionalSelectors[a].replace('{{i}}', i));\n                    }\n                }\n                $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to forums.\n         * @param {array} forumMapping\n         */\n        var annotateForums = function(forumMapping) {\n            // Annotate introductions.\n            var intros = forumMapping['intros'];\n            annotateModuleIntros(intros, 'forum');\n\n            // Annotate discussions.\n            var discussions = forumMapping['posts'];\n            for (var d in discussions) {\n                var post = 'p' + d;\n                var annotation = discussions[d];\n                var selectors = [\n                    \"#page-mod-forum-discuss #\" + post +\n                    ' div.forumpost div.no-overflow'\n                ];\n                $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to Open Forums.\n         * @param {array} forumMapping\n         */\n        var annotateMRForums = function(forumMapping) {\n\n            // Annotate introductions.\n            var intros = forumMapping['intros'];\n            annotateModuleIntros(intros, 'hsuforum', ['#hsuforum-header .hsuforum_introduction > .no-overflow']);\n\n            var discussions = forumMapping['posts'];\n            for (var d in discussions) {\n                var annotation = discussions[d];\n                var postSelector = 'article[id=\"p' + d + '\"] div.posting';\n                $(postSelector).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to glossary.\n         * @param {array} mapping\n         */\n        var annotateGlossary = function(mapping) {\n            // Annotate introductions.\n            var intros = mapping['intros'];\n            annotateModuleIntros(intros, 'glossary');\n\n            // Annotate entries.\n            var entries = mapping['entries'];\n            for (var e in entries) {\n                var annotation = entries[e];\n                var entryFooter = $('.entrylowersection .commands a[href*=\"id=' + e + '\"]');\n                var entry = $(entryFooter).parents('.glossarypost').find('.entry .no-overflow');\n                $(entry).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to page.\n         * @param {array} mapping\n         */\n        var annotatePage = function(mapping) {\n            var intros = mapping['intros'];\n            annotateModuleIntros(intros, 'page', ['li.snap-native.modtype_page#module-{{i}} .contentafterlink > .summary-text']);\n\n            // Annotate content.\n            var content = mapping['content'];\n            for (var c in content) {\n                var annotation = content[c];\n                var selectors = [\n                    '#page-mod-page-view #region-main .box.generalbox > .no-overflow',\n                    'li.snap-native.modtype_page#module-' + c + ' .pagemod-content'\n                ];\n                $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to book.\n         * @param {array} mapping\n         */\n        var annotateBook = function(mapping) {\n            var intros = mapping['intros'];\n\n            // For book, the only place the intro shows is on the course page when you select \"display description on course page\"\n            // in the module settings.\n            annotateModuleIntros(intros, 'book',\n                ['li.snap-native.modtype_book#module-{{i}} .contentafterlink > .summary-text .no-overflow']);\n\n            // Annotate content.\n            var content = mapping['chapters'], chapterId;\n\n            if (self.params.chapterid) {\n                chapterId = self.params.chapterid;\n            } else {\n                var urlParams = new URLSearchParams(window.location.search);\n                chapterId = urlParams.get('chapterid');\n            }\n\n            $.each(content, function(ch, annotation) {\n                if (chapterId != ch) {\n                    return;\n                }\n                var selectors = [\n                    '#page-mod-book-view #region-main .box.generalbox.book_content > .no-overflow',\n                    'li.snap-native.modtype_page#module-' + ch + ' .pagemod-content'\n                ];\n                $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n            });\n        };\n\n        /**\n         * Add annotations to lesson.\n         * @param {array} mapping\n         */\n        var annotateLesson = function(mapping) {\n            var intros = mapping['intros'];\n\n            // For lesson, the only place the intro shows is on the course page when you select \"display description on course page\"\n            // in the module settings.\n            annotateModuleIntros(intros, 'lesson',\n                ['li.snap-native.modtype_lesson#module-{{i}} .contentafterlink > .summary-text .no-overflow']);\n\n            // Annotate content.\n            var content = mapping['lesson_pages'];\n            for (var p in content) {\n                if (document.body.id === \"page-mod-lesson-edit\") {\n                    var xpath = '//a[@id=\"lesson-' + p + '\"]//ancestor::table//tbody/tr/td/div[contains(@class, \"no-overflow\")]';\n                    var annotation = content[p];\n                    var node = getNodeByXpath(xpath);\n                    $(node).attr('data-ally-richcontent', annotation);\n                } else {\n                    // Try get page from form.\n                    var node = getNodeByXpath('//form[contains(@action, \"continue.php\")]//input[@name=\"pageid\"]');\n                    if (node) {\n                        var pageId = $(node).val();\n                    } else {\n                        var urlParams = new URLSearchParams(window.location.search);\n                        var pageId = urlParams.get('pageid');\n                    }\n\n                    if (pageId != p) {\n                        continue;\n                    }\n                    var annotation = content[p];\n                    var selectors = [\n                        // Regular page.\n                        '#page-mod-lesson-view #region-main .box.contents > .no-overflow',\n                        // Question page.\n                        '#page-mod-lesson-view #region-main form > fieldset > .fcontainer > .contents .no-overflow',\n                        // Lesson page.\n                        'li.snap-native.modtype_page#module-' + p + ' .pagemod-content'\n                    ];\n\n                    $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n                }\n            }\n\n            // Annotate answer answers.\n            Strings.get_strings([\n                {key:'answer', component:'mod_lesson'},\n                {key:'response', component:'mod_lesson'}\n            ]).then(function(strings) {\n                var answerLabel = strings[0];\n                var responseLabel = strings[1];\n                var answers = mapping['lesson_answers'];\n\n                var processAnswerResponse = function(pageId, i, label, annotation) {\n                    var xpath = '//a[@id=\"lesson-' + pageId + '\"]//ancestor::table' +\n                        '//td/label[contains(text(),\"' + label + ' ' + i + '\")]/ancestor::tr/td[2]';\n                    var nodes = getNodesByXpath(xpath);\n                    for (var n in nodes) {\n                        var node = nodes[n];\n                        $(node).attr('data-ally-richcontent', annotation);\n                    }\n                };\n\n                for (var a in answers) {\n                    // increment anum so that we can get the answer number.\n                    // Note, we can trust that this is correct because you can't order answers and the code in the lesson component\n                    // orders answers by id.\n                    var annotation = answers[a];\n\n                    var tmpArr = a.split('_');\n                    var pageId = tmpArr[0];\n                    var ansId = tmpArr[1];\n                    var anum = tmpArr[2];\n\n                    // Process answers when on lesson edit page.\n                    if (document.body.id === \"page-mod-lesson-edit\") {\n                        processAnswerResponse(pageId, anum, answerLabel, annotation);\n                    } else {\n                        // Wrap answers in labels.\n                        $('#page-mod-lesson-view label[for=\"id_answerid_' + ansId + '\"]').attr('data-ally-richcontent', annotation);\n\n                        if (self.params.answerid && self.params.answerid == ansId) {\n                            $('.studentanswer tr:nth-of-type(1) > td div').attr('data-ally-richcontent', annotation);\n                        } else {\n                            var answerWrapperId = 'answer_wrapper_' + ansId;\n                            var answerEl = $('#id_answerid_' + ansId);\n                            if (answerEl.data('annotated') != 1) {\n                                // We only want to wrap this once.\n                                var contentEls = answerEl.nextAll();\n                                answerEl.parent('label').append('<span id=\"answer_wrapper_' + ansId + '\"></span>');\n                                $('#' + answerWrapperId).append(contentEls);\n                            }\n                            answerEl.data('annotated', 1);\n                        }\n                        $('#answer_wrapper_' + a).attr('data-ally-richcontent', annotation);\n                    }\n                }\n\n                // Annotate answer responses.\n                var responses = mapping['lesson_answers_response'];\n                for (var r in responses) {\n                    var annotation = responses[r];\n\n                    var tmpArr = r.split('_');\n                    var pageId = tmpArr[0];\n                    var respId = tmpArr[1];\n                    var rnum = tmpArr[2];\n\n                    if (document.body.id === \"page-mod-lesson-edit\") {\n                        processAnswerResponse(pageId, rnum, responseLabel, annotation);\n                    } else if (self.params.answerid && self.params.answerid == respId) {\n                        // Just incase you are wondering, yes answer ids ^ are the same as response ids ;-).\n                        var responseWrapperId = 'response_wrapper_' + respId;\n                        if (!$('.studentanswer tr.lastrow > td #' + responseWrapperId).length) {\n                            // We only want to wrap this once, hence above ! length check.\n                            var contentEls = $('.studentanswer tr.lastrow > td > br').nextAll();\n                            $('.studentanswer tr.lastrow > td > br').after('<span id=\"' + responseWrapperId + '\"></span>');\n                            $('#' + responseWrapperId).append(contentEls);\n                        }\n\n                        $('#' + responseWrapperId).attr('data-ally-richcontent', annotation);\n                    }\n\n                }\n            });\n        };\n\n        /**\n         * Annotate supported modules\n         * @param {array} moduleMapping\n         */\n        var annotateModules = function(moduleMapping) {\n            var dfd = $.Deferred();\n            if (moduleMapping['mod_forum'] !== undefined) {\n                annotateForums(moduleMapping['mod_forum']);\n            }\n            if (moduleMapping['mod_hsuforum'] !== undefined) {\n                annotateMRForums(moduleMapping['mod_hsuforum']);\n            }\n            if (moduleMapping['mod_glossary'] !== undefined) {\n                annotateGlossary(moduleMapping['mod_glossary']);\n            }\n            if (moduleMapping['mod_page'] !== undefined) {\n                annotatePage(moduleMapping['mod_page']);\n            }\n            if (moduleMapping['mod_book'] !== undefined) {\n                annotateBook(moduleMapping['mod_book']);\n            }\n            if (moduleMapping['mod_lesson'] !== undefined) {\n                annotateLesson(moduleMapping['mod_lesson']);\n            }\n            dfd.resolve();\n            return dfd.promise();\n        };\n\n        /**\n         * Annotates course summary if found on footer.\n         * @param {object} mapping\n         */\n        var annotateSnapCourseSummary = function(mapping) {\n            var dfd = $.Deferred();\n            var snapFooterCourseSummary = $('#snap-course-footer-summary > div.no-overflow');\n            if (snapFooterCourseSummary.length) {\n                var ident = buildContentIdent('course', 'course', 'summary', mapping.courseId);\n                snapFooterCourseSummary.attr('data-ally-richcontent', ident);\n            }\n            dfd.resolve();\n            return dfd.promise();\n        };\n\n        /**\n         * Annotate html block.\n         * @param {object} mapping\n         */\n        var annotateHtmlBlock = function(mapping) {\n            var dfd = $.Deferred();\n\n            var items = mapping.block_html;\n            for (var i in items) {\n                var ident = items[i];\n                var selectors = [\n                    '#inst' + i + '.block_html > .card-body > .card-text > .no-overflow',\n                    '#inst' + i + '.block_html > .content > .no-overflow'\n                ];\n                var selector = selectors.join(',');\n                $(selector).attr('data-ally-richcontent', ident);\n            }\n            dfd.resolve();\n            return dfd.promise();\n        };\n\n        /**\n         * Apply place holders and add annotations to content.\n         * @return {promise}\n         */\n        var applyPlaceHolders = function() {\n            M.util.js_pending('filter_ally_applyPlaceHolders');\n            var dfd = $.Deferred();\n\n            if (ally_module_maps === undefined || ally_section_maps === undefined) {\n                dfd.resolve();\n                return dfd.promise();\n            }\n\n            var tasks = [{\n                mapVar: ally_module_maps.file_resources,\n                method: placeHoldResourceModule\n            },\n            {\n                mapVar: ally_module_maps.assignment_files,\n                method: placeHoldAssignModule\n            },\n            {\n                mapVar: ally_module_maps.folder_files,\n                method: placeHoldFolderModule\n            },\n            {\n                mapVar: ally_module_maps.forum_files,\n                method: placeHoldForumModule\n            },\n            {\n                mapVar: ally_module_maps.glossary_files,\n                method: placeHoldGlossaryModule\n            },\n            {\n                mapVar: ally_module_maps.lesson_files,\n                method: placeHoldLessonModule\n            },\n            {\n                mapVar: ally_section_maps,\n                method: annotateSections\n            },\n            {\n                mapVar: ally_annotation_maps,\n                method: annotateModules\n            },\n            {\n                mapVar: {courseId: self.courseId},\n                method: annotateSnapCourseSummary\n            },\n            {\n                mapVar: ally_annotation_maps,\n                method: annotateHtmlBlock\n            }];\n\n            $(document).ready(function() {\n                var completed = 0;\n                /**\n                 * Run this once a task has resolved.\n                 */\n                var onTaskComplete = function() {\n                    completed++;\n                    if (completed === tasks.length) {\n                        // All tasks completed.\n                        M.util.js_complete('filter_ally_applyPlaceHolders');\n                        dfd.resolve();\n                    }\n                };\n\n                for (var t in tasks) {\n                    var task = tasks[t];\n                    if (Object.keys(task.mapVar).length > 0) {\n                        task.method(task.mapVar)\n                            .done(onTaskComplete);\n                    } else {\n                        // Skipped this task because mappings are empty.\n                        onTaskComplete();\n                    }\n                }\n            });\n            return dfd.promise();\n        };\n\n        var debounceApplyPlaceHolders = Util.debounce(function() {\n            return applyPlaceHolders();\n        }, 1000);\n\n        /**\n         * Initialise JS stage two.\n         * @param {string} jwt\n         * @param {object} config\n         */\n        this.initStageTwo = function(jwt, config) {\n            if (self.canViewFeedback || self.canDownload) {\n                debounceApplyPlaceHolders()\n                    .done(function() {\n                        ImageCover.init();\n                        Ally.init(jwt, config);\n                        try {\n                            var selector = $('.foldertree > .filemanager');\n                            var targetNode = selector[0];\n                            if (targetNode) {\n                                var observerConfig = { attributes: true, childList: true, subtree: true };\n                                var callback = function(mutationsList) {\n                                    mutationsList.filter( function (mutation) {\n                                        return mutation.type === 'childList';\n                                    }).forEach( function () {\n                                        placeHoldFolderModule(ally_module_maps.folder_files);\n                                    });\n                                };\n                                var observer = new MutationObserver(callback);\n                                observer.observe(targetNode, observerConfig);\n                            }\n                        } catch (error) {\n                            setInterval(function() {\n                                placeHoldFolderModule(ally_module_maps.folder_files);\n                            }, 5000);\n                        }\n                        self.initialised = true;\n                    });\n\n                $(document).ajaxComplete(function() {\n                    if (!self.initialised) {\n                        return;\n                    }\n                    debounceApplyPlaceHolders();\n                });\n            }\n        };\n\n        /**\n         * Init function.\n         * @param {string} jwt\n         * @param {object} config\n         * @param {boolean} canViewFeedback\n         * @param {boolean} canDownload\n         * @param {int} courseId\n         * @param {object} params\n         */\n        this.init = function(jwt, config, canViewFeedback, canDownload, courseId, params) {\n\n            self.canViewFeedback = canViewFeedback;\n            self.canDownload = canDownload;\n            self.courseId = courseId;\n            self.params = params;\n\n            var pluginJSURL = function(path) {\n                return M.cfg.wwwroot + \"/pluginfile.php/\" + M.cfg.contextid + \"/filter_ally/\" + path;\n            };\n\n            var polyfills = {};\n            if (!document.evaluate) {\n                polyfills['filter_ally/wgxpath'] = pluginJSURL(\"vendorjs/wgxpath.install\");\n            }\n            if (typeof(URLSearchParams) === 'undefined') {\n                polyfills['filter_ally/urlsearchparams'] = [\n                    'https://cdnjs.cloudflare.com/ajax/libs/url-search-params/1.1.0/url-search-params.amd.js',\n                    pluginJSURL('vendorjs/url-search-params.amd') // CDN fallback.\n                ];\n            }\n            if (polyfills !== {}) {\n                // Polyfill document.evaluate.\n                require.config(\n                    {\n                        enforceDefine: false,\n                        paths: polyfills\n                    }\n                );\n                var requires = Object.keys(polyfills);\n\n                require(requires, function() {\n                    if (typeof(URLSearchParams) === 'undefined') {\n                        window.URLSearchParams = arguments[1]; // second arg in require (which is URLSearchParams)\n                    }\n                    self.initStageTwo(jwt, config);\n                });\n\n                return;\n            }\n            self.initStageTwo(jwt, config);\n        };\n    };\n});\n"],"names":["define","$","Templates","Strings","Ally","ImageCover","Util","self","this","canViewFeedback","canDownload","initialised","params","getNodeByXpath","xpath","window","document","createExpression","evaluate","XPathResult","FIRST_ORDERED_NODE_TYPE","singleNodeValue","renderTemplate","data","pathHash","targetEl","dfd","Deferred","parents","length","resolve","promise","canviewfeedback","candownload","html","render","done","result","next","find","after","remove","placeHoldSelector","selector","map","c","each","url","type","regex","checkComplete","prop","toLowerCase","attr","indexOf","match","path","decodeURIComponent","undefined","query","getQuery","file","isimage","fileid","placeHoldForumModule","forumFileMapping","placeHoldAssignModule","assignFileMapping","whenTrue","placeHoldFolderModule","folderFileMapping","placeHoldGlossaryModule","glossaryFileMapping","mainAnchor","prev","addClass","iconAnchor","container","append","urlEncodeFilePath","filePath","parts","split","p","encodeURIComponent","join","placeHoldLessonGeneral","selectorPrefix","placeHoldLessonModule","lessonFileMapping","pageContentsMap","page_contents","pageAnswersMap","page_answers","pageResponsesMap","page_responses","placeHoldLessonPageContents","then","placeHoldLessonAnswersContent","placeHoldLessonResponsesContent","placeHoldResourceModule","moduleFileMapping","checkAllProcessed","Object","keys","moduleId","hasClass","moduleEl","buildContentIdent","component","table","field","id","annotateSections","sectionMapping","s","sectionId","ident","annotateModuleIntros","introMapping","module","additionalSelectors","i","annotation","selectors","a","push","replace","annotateLesson","mapping","intros","content","body","node","pageId","val","URLSearchParams","location","search","get","get_strings","key","strings","answerLabel","responseLabel","answers","processAnswerResponse","label","nodes","ANY_TYPE","iterateNext","getNodesByXpath","n","tmpArr","ansId","anum","answerid","answerWrapperId","answerEl","contentEls","nextAll","parent","responses","r","respId","rnum","responseWrapperId","annotateModules","moduleMapping","forumMapping","discussions","d","post","annotateForums","annotateMRForums","entries","e","entryFooter","entry","annotateGlossary","annotatePage","chapterId","chapterid","urlParams","ch","annotateBook","annotateSnapCourseSummary","snapFooterCourseSummary","courseId","annotateHtmlBlock","items","block_html","debounceApplyPlaceHolders","debounce","M","util","js_pending","ally_module_maps","ally_section_maps","tasks","mapVar","file_resources","method","assignment_files","folder_files","forum_files","glossary_files","lesson_files","ally_annotation_maps","ready","completed","onTaskComplete","js_complete","t","task","applyPlaceHolders","initStageTwo","jwt","config","init","targetNode","MutationObserver","mutationsList","filter","mutation","forEach","observe","attributes","childList","subtree","error","setInterval","ajaxComplete","pluginJSURL","cfg","wwwroot","contextid","polyfills","require","enforceDefine","paths","requires","arguments"],"mappings":"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"}