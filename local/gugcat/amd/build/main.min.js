define(["jquery","core/str","core/modal_factory","local_gugcat/modal_gcat","core/sessionstorage","core/ajax"],function(e,t,n,a,l,r){const o=e=>{return window.location.pathname.match(e)},c=e=>{document.querySelectorAll(".input-reason").forEach(t=>t.value=e)},i=()=>{var e=document.getElementById("btn-identities"),n=document.querySelectorAll(".blind-marking");if(e&&n.length>0){e.textContent="...",n.forEach(e=>e.classList.add("hide-names"));var a="true"==l.get("blind-marking");t.get_strings([{key:"showidentities",component:"local_gugcat"},{key:"hideidentities",component:"local_gugcat"}]).then(function(t){e.textContent=a?t[0]:t[1],n.forEach(e=>{a?e.classList.add("hide-names"):e.classList.remove("hide-names")})})}},d=e=>{var t,n,a,l,r,o,c,i,d=0;for(t=document.getElementById("gcat-table"),a=!0,i="asc";a;){for(a=!1,n=t.rows,l=1;l<n.length-1;l++)if(c=!1,r=n[l].getElementsByTagName("TD")[e],o=n[l+1].getElementsByTagName("TD")[e],"asc"==i){if(r.innerHTML.toLowerCase()>o.innerHTML.toLowerCase()){c=!0;break}}else if("desc"==i&&r.innerHTML.toLowerCase()<o.innerHTML.toLowerCase()){c=!0;break}c?(n[l].parentNode.insertBefore(n[l+1],n[l]),a=!0,d++):0==d&&"asc"==i&&(i="desc",a=!0)}},s=(e,l,r,o="cancelmodal")=>{var c=[{key:l,component:"local_gugcat"},{key:o,component:"local_gugcat"},{key:r,component:"local_gugcat"}];t.get_strings(c).then(function(t){var l={bodycontent:t[0],strcancel:t[1],strconfirm:t[2],dataaction:e};n.create({type:a.TYPE,templateContext:l}).done(e=>e.show())})},g=e=>{var t=new URLSearchParams(window.location.search),n=document.getElementById("select-category"),a=document.getElementById("select-activity"),l=document.getElementById("select-grade-reason"),r=document.getElementById("input-reason"),i=document.getElementById("id_reasons");switch(e.target){case n:if(t.delete("activityid"),t.delete("page"),"null"===n.value?t.delete("categoryid"):t.set("categoryid",n.value),o("gugcat/add")){t.delete("studentid");var d=window.location.pathname;return d=d.replace("gugcat/add","gugcat")+"?"+t,void window.location.replace(d)}window.location.search=t;break;case a:t.set("activityid",a.value),t.delete("page"),window.location.search=t;break;case l:var s=e.target.value;c(s),"Other"===s?(c(""),r.style.display="block"):r.style.display="none";break;case i:var g=e.target.value,u=document.getElementById("id_otherreason");u.value=g,(g="8")?(u.value="",u.required=!0):u.required=!1,u.focus()}},u=n=>{var a=document.getElementById("btn-saveadd"),o=document.getElementById("btn-release"),c=document.getElementById("btn-import"),d=document.getElementById("btn-identities"),g=document.getElementById("btn-coursegradeform"),u=document.getElementById("btn-download"),m=document.getElementById("btn-finalrelease"),y=document.getElementById("btn-switch-display");switch(n.target){case a:a.classList.toggle("togglebtn"),a.style.display="none",t.get_string("saveallnewgrade","local_gugcat").then(function(e){a.style.display="inline-block",a.classList.contains("togglebtn")?a.textContent=e:document.getElementById("multiadd-submit").click()}),e(".togglemultigrd").show();break;case o:s("release","modalreleaseprovisionalgrade","confirmreleaseprovisionalgrade");break;case c:e(".gradeitems").text().includes("Moodle Grade[Date]")?document.getElementById("importgrades-submit").click():s("importgrades","modalimportgrades","confirmimport");break;case g:var v=document.querySelectorAll(".input-percent"),f=0;v.length>0&&v.forEach(e=>{var t=e.querySelector("input");f+=parseInt(t.value),null!=e.querySelector("input.is-invalid")?e.querySelector("div.felement").classList.add("no-after"):e.querySelector("div.felement").classList.remove("no-after")}),100!=f?s("adjustweight","modaladjustweights","confirmchanges"):document.getElementById("coursegradeform-submit").click();break;case m:s("finalrelease","modalreleasefinalgrades","confirmfinalrelease");break;case u:document.getElementById("downloadcsv-submit").click();break;case d:var h="true"==l.get("blind-marking");l.set("blind-marking",!h),i();break;case y:(()=>{var e=document.getElementById("btn-switch-display"),n=new URLSearchParams(window.location.search).get("id");e&&(e.textContent="...",r.call([{methodname:"local_gugcat_display_assessments",args:{courseid:n}}])[0].done(function(n){var a=n.result;t.get_strings([{key:"switchoffdisplay",component:"local_gugcat"},{key:"switchondisplay",component:"local_gugcat"}]).then(function(t){e.textContent=a?t[0]:t[1]})}).fail(function(){e.style.display="none"}))})()}};return{init:function(){const n=document.querySelector(".gcat-container");if(n){n.addEventListener("change",g),n.addEventListener("click",u),document.getElementById("btn-identities")&&!l.get("blind-marking")&&l.set("blind-marking",!1),i();var a=document.getElementById("input-reason");a&&a.addEventListener("input",e=>{c(e.target.value)});var r=document.querySelectorAll(".input-search");r.length>0&&r.forEach(e=>{e.addEventListener("keydown",e=>{13===(e.keyCode?e.keyCode:e.which)&&document.getElementById("search-submit").click()})});var s=document.querySelectorAll(".input-percent");if(s.length>0){var m=0,y=document.querySelector("#fitem_id_totalweight .form-inline");s.forEach(e=>{var t=e.querySelector("input");m+=parseInt(t.value),t.addEventListener("input",e=>{let t=0;s.forEach(e=>t+=parseInt(e.querySelector("input").value)),y.innerHTML=`${t}%`}),t.addEventListener("focus",t=>{var n=t.target.value;""!==n&&null===n.match(/^[0-9]+$/)?e.querySelector("div.felement").classList.add("no-after"):e.querySelector("div.felement").classList.remove("no-after")}),t.addEventListener("blur",t=>{var n=t.target.value;""!==n&&null===n.match(/^[0-9]+$/)?e.querySelector("div.felement").classList.add("no-after"):e.querySelector("div.felement").classList.remove("no-after")})}),y.innerHTML=`${m}%`}var v=document.querySelectorAll(".sortable");if(v.length>0)for(const[e,t]of v.entries())t.addEventListener("click",()=>d(e));var f=document.querySelectorAll(".fa-search");if(f.length>0&&f.forEach(e=>{e.addEventListener("click",e=>{e.currentTarget.blur();var t=e.target.nextSibling;t.classList.toggle("visible"),t.classList.contains("visible")?t.style.display="block":t.style.display="none"})}),document.querySelectorAll("td .grade-discrepancy").length>0&&(document.getElementById("btn-grddisc").style.display="inline-block"),o("gugcat/overview"))document.querySelector("#btn-overviewtab").classList.add("active"),document.querySelector("#btn-assessmenttab").classList.remove("active"),(p=document.getElementById("id_notes"))&&(async()=>{p.placeholder=await t.get_string("specifyreason","local_gugcat"),p.required=!0})();else if(o("gugcat/index")){if(document.getElementById("btn-release").style.display=e(".gradeitems").text().includes("Moodle Grade[Date]")?"none":"inline-block",Array.from(document.querySelectorAll(".gradeitems")).find(e=>"Moodle Grade<br>[Date]"!==e.innerHTML))document.getElementById("btn-saveadd").style.display="inline-block",document.querySelectorAll(".addnewgrade").forEach(e=>{e.style.display="block"}),document.querySelectorAll(".hide-show-grade").forEach(e=>{e.style.display="block"})}else if(o("gugcat/add")||o("gugcat/edit")){var h=document.getElementById("id_otherreason"),p=document.getElementById("id_notes");(async()=>{h.placeholder=await t.get_string("pleasespecify","local_gugcat"),p.placeholder=await t.get_string("specifyreason","local_gugcat"),p.required=!0})()}}}}});