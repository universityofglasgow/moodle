define("tiny_generico/widget_selector",["exports","core/log","./options","core/modal_factory","core/templates","core/prefetch","./modal","core/modal_registry","./common"],(function(_exports,_log,_options,ModalFactory,Templates,_prefetch,_modal,_modal_registry,_common){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_log=_interopRequireDefault(_log),ModalFactory=_interopRequireWildcard(ModalFactory),Templates=_interopRequireWildcard(Templates),_modal=_interopRequireDefault(_modal),_modal_registry=_interopRequireDefault(_modal_registry);return _exports.default=class{constructor(editor,elementid,modal,config){this.ready=!1,this.editor=editor,this.elementid=elementid,this.config=config,this.modal=modal,this.modalRoot=modal.getRoot()[0]}init(){this.registerEvents(),this.ready=!0}close(){this.modal.hide()}getElement(component){return this.modalRoot.querySelector("#"+this.elementid+"_"+component)}registerEvents(){var that=this;this.modal.getRoot()[0].addEventListener("click",(function(e){var widgetchosen=e.target.closest(".tiny_generico_widgetchoosebutton"),widgetinserted=e.target.closest(".tiny_generico_widgetinsertbutton"),widgetcancelled=e.target.closest(".tiny_generico_widgetcancelledbutton");if(widgetchosen){e.preventDefault();var templateindex=e.target.getAttribute("data-templateindex");if(null===(widget=that.getWidget(templateindex)))return _log.default.debug("That template not found: "+templateindex),void _log.default.debug(that.config);that.showOptionsPanel(e,widget)}if(widgetinserted){e.preventDefault();var widget;templateindex=e.target.getAttribute("data-templateindex");if(null===(widget=that.getWidget(templateindex)))return _log.default.debug("That template not found: "+templateindex),void _log.default.debug(that.config);var filterstring=that.getFilterString(widget);that.editor.insertContent(filterstring),that.close()}widgetcancelled&&(e.preventDefault(),that.hideOptionsPanel(e,widget))}))}getWidget(templateindex){for(var widget=null,i=0;i<this.config.widgets.length;i++)if(this.config.widgets[i].templateindex==templateindex){widget=this.config.widgets[i];break}return widget}showOptionsPanel(e,widget){var that=this;_log.default.debug("showing the template form for: "+widget.name),that.modalRoot.querySelector("#tiny_generico_widgets_optionspanel"),Templates.render("tiny_generico/widgetoptions",widget).then((function(html,js){var optionspanel=that.modalRoot.querySelector("#tiny_generico_widgets_optionspanel"),selectorpanel=that.modalRoot.querySelector("#tiny_generico_widgets_selectorpanel");_log.default.debug("replacing contents of options panel"),optionspanel.innerHTML=html,selectorpanel.classList.add("tiny_generico_hidden"),optionspanel.classList.remove("tiny_generico_hidden"),optionspanel.style.left=0,selectorpanel.style.left=-1*selectorpanel.offsetWidth+"px"})).catch((function(e){_log.default.debug(e)}))}hideOptionsPanel(){_log.default.debug("hiding the template options form ");var optionspanel=this.modalRoot.querySelector("#tiny_generico_widgets_optionspanel"),selectorpanel=this.modalRoot.querySelector("#tiny_generico_widgets_selectorpanel");selectorpanel.classList.remove("tiny_generico_hidden"),optionspanel.classList.add("tiny_generico_hidden"),optionspanel.style.left=optionspanel.offsetWidth+"px",selectorpanel.style.left=0}getFilterString(widget){var retstring="{GENERICO:type=",widgetkey=widget.key,thevariables=widget.variables,theend=(widget.defaults,widget.end);retstring+='"'+widgetkey+'"';for(var i=0;i<thevariables.length;i++){var thevalue=null,elements=null;(elements=thevariables[i].isarray?this.modalRoot.querySelectorAll('select[data-type="'+thevariables[i].key+'"]'):this.modalRoot.querySelectorAll('input[data-type="'+thevariables[i].key+'"]')).length>0&&(thevalue=elements[0].value),null!==thevalue&&(retstring+=","+thevariables[i].key+'="'+thevalue+'"')}return retstring+="}",theend&&(retstring+='<br/>{GENERICO:type="'+widgetkey+'_end"}'),retstring}static generateRandomString(){for(var characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",result="",i=0;i<8;i++){var randomIndex=Math.floor(Math.random()*characters.length);result+=characters.charAt(randomIndex)}return result}static getModalClass(){var _class;const modalType="".concat(_common.component,"/widgetselector"),registration=_modal_registry.default.get(modalType);if(registration)return registration.module;const WidgetModal=(_defineProperty(_class=class extends _modal.default{},"TYPE",modalType),_defineProperty(_class,"TEMPLATE","".concat(_common.component,"/widgetselector")),_class);return _modal_registry.default.register(WidgetModal.TYPE,WidgetModal,WidgetModal.TEMPLATE),WidgetModal}static getModalContext(editor){var context={},config=(0,_options.getConfig)(editor);return _log.default.debug(config),context.CSS=_common.CSS,context.widgets=config.widgets,context}static async display(editor){const ModalClass=this.getModalClass(),templatecontext=this.getModalContext(editor),elementid=this.generateRandomString(),modal=await ModalFactory.create({type:ModalClass.TYPE,templateContext:templatecontext,large:!0});return new this(editor,elementid,modal,templatecontext).init(),modal.show(),modal}},_exports.default}));

//# sourceMappingURL=widget_selector.min.js.map