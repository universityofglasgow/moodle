YUI.add("moodle-atto_echo360attoplugin-button",function(e,t){var n="atto_echo360attoplugin",r="atto_echo360attoplugin",i="",s="echo360",o="echoIcon",u={},a={};e.namespace("M.atto_echo360attoplugin").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){if(this.get("disabled")){this.get("error")&&console.error(this.get("error"));return}i=this.editor._yuid,this.addButton({icon:"ed/"+o,iconComponent:"atto_echo360attoplugin",buttonName:o,callback:this._doOpen,callbackArgs:null,name:s,tooltip:s})},_doOpen:function(t){t.preventDefault(),this._resetEditorInstance(),a={host:this.get("host"),editor:this.editor,dialogue:this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),focusAfterHide:this.editor,height:580,width:800})},a.dialogue.show(),u[i]||window.addEventListener("message",function(e){return e.stopPropagation(),this._receiveMessage(e)}.bind(this),!0),u[i]=!0;var r=e.io(M.cfg.wwwroot+"/lib/editor/atto/plugins/echo360attoplugin/ajax.php",{context:this,method:"post",data:{sesskey:M.cfg.sesskey,contextcourseid:echo360_context_course_id,pagetype:moodle_page_type},timeout:500,on:{complete:function(e,t){if(t.status===200){var n="echo360-library-"+i,r=document.getElementById(n);r!=null&&r.parentNode.removeChild(r);var s=JSON.parse(t.responseText),o="echo360-form-"+i,u=document.createElement("form");u.setAttribute("method","post"),u.setAttribute("id",o),u.setAttribute("target",n),u.setAttribute("hidden","true"),u.action=s.launch_url;for(var a in s)if(s.hasOwnProperty(a)){var f=document.createElement("input");f.setAttribute("type","text"),f.setAttribute("value",s[a]),f.id=f.name=a,u.appendChild(f)}document.body.appendChild(u);var l=document.createElement("iframe");l.id=n,l.name=n,l.setAttribute("height","500px"),l.setAttribute("width","100%");var c=this.getDialogue();c.render(),c.bodyNode.appendChild(l),u.submit(),u.parentNode.removeChild(u)}else if(t.status==404){var c=this.getDialogue();c.render(),c.bodyNode.appendChild(t.responseText)}}}});this.markUpdated()},_receiveMessage:function(e){if(e.data){var t=null,n=this._getQueryParams(e.data);if(n){switch(n.return_type){case"iframe":t='<iframe src="'+n.url+'" height="'+n.height+'" width="'+n.width+'" title="'+n.title+'" allowfullscreen="allowfullscreen'+'" webkitallowfullscreen="webkitallowfullscreen'+'" mozallowfullscreen="mozallowfullscreen'+'"></iframe> ';break;case"url":t='<a href="'+n.url+'" target="_blank">'+n.title+"</a> ";break;case"lti_launch_url":if(n.link_type==="link"){var r=echo360_filter_lti_launch_url+"?url="+encodeURIComponent(n.url)+"&cmid="+echo360_context_module_id;t='<a href="'+r+'" target="_blank">'+n.title+"</a> "}else{var r=echo360_filter_lti_launch_url+"?url="+encodeURIComponent(n.url)+"&cmid="+echo360_context_module_id+"&width="+n.width+"&height="+n.height;t='<a href="'+r+'" target="_blank">'+n.title+"</a> "}break;case"homework":var r=echo360_filter_lti_launch_url+"?url="+encodeURIComponent(n.url)+"&cmid="+echo360_context_module_id+"&width=640"+"&height=360";t='<a href="'+r+'" target="_blank">'+n.title+"</a> ";break;default:console.error("Return type: "+n.return_type+" invalid"),this._resetEditorInstance()}t!=null&&t!=""&&this._doInsert(t)}else console.warn("No parameters returned from parsed message yet: "+JSON.stringify(e.data))}else console.error("No data returned from message: "+e),this._resetEditorInstance()},_getQueryParams:function(e){try{if(e!=null&&typeof e=="string"){var t=decodeURI(e.split("?")[1]).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"').replace(/\\/g,"\\\\"),n=JSON.parse('{"'+t+'"}');return n.hasOwnProperty("url")?(n.url=decodeURIComponent(n.url),n.title=n.title||n.url,n):(console.error('Required parameter "url" missing from message: '+e),null)}}catch(r){return console.error("Error caught while attempting to parse query parameters in message: "+e+"\n"+r.message),null}},_doInsert:function(e){if(a!=null){a.dialogue.hide();if(!e)return;a.editor.focus(),a.host.insertContentAtFocusPoint(e),this._resetEditorInstance(),this.markUpdated()}},_resetEditorInstance:function(){a={}},_browserIsIE:function(){return navigator.appName==="Microsoft Internet Explorer"||!!navigator.userAgent.match(/Trident/)||!!navigator.userAgent.match(/rv:11/)||!!document.documentMode==1||navigator.userAgent.indexOf("MSIE")!==-1}},{ATTRS:{disabled:{value:!1},usercontextid:{value:null},ltiConfiguration:{value:""}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
