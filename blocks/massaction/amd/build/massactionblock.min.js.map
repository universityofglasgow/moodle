{"version":3,"file":"massactionblock.min.js","sources":["../src/massactionblock.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main module for the massaction block.\n *\n * @module     block_massaction/massactionblock\n * @copyright  2022 ISB Bayern\n * @author     Philipp Memmel\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as checkboxmanager from 'block_massaction/checkboxmanager';\nimport * as Str from 'core/str';\nimport Log from 'core/log';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\nimport events from \"core_course/events\";\n\nexport const usedMoodleCssClasses = {\n    ACTIVITY_ITEM: '.activity-item',\n    SECTION_NAME: 'sectionname',\n    MODULE_ID_PREFIX: 'module-',\n    BOX_ID_PREFIX: 'cmCheckbox'\n};\n\nexport const cssIds = {\n    BLOCK_CONTENT: 'block-massaction',\n    BULK_EDITING_DISABLED: 'block-massaction-bulk-editing-disabled',\n    SELECT_ALL_LINK: 'block-massaction-control-selectall',\n    DESELECT_ALL_LINK: 'block-massaction-control-deselectall',\n    HIDE_LINK: 'block-massaction-action-hide',\n    SHOW_LINK: 'block-massaction-action-show',\n    MAKE_AVAILABLE_LINK: 'block-massaction-action-makeavailable',\n    DUPLICATE_LINK: 'block-massaction-action-duplicate',\n    DELETE_LINK: 'block-massaction-action-delete',\n    SHOW_DESCRIPTION_LINK: 'block-massaction-action-showdescription',\n    HIDE_DESCRIPTION_LINK: 'block-massaction-action-hidedescription',\n    CONTENT_CHANGED_NOTIFICATION_LINK: 'block-massaction-action-contentchangednotification',\n    MOVELEFT_LINK: 'block-massaction-action-moveleft',\n    MOVERIGHT_LINK: 'block-massaction-action-moveright',\n    MOVETO_ICON_LINK: 'block-massaction-action-moveto',\n    DUPLICATETO_ICON_LINK: 'block-massaction-action-duplicateto',\n    DUPLICATE_TO_COURSE_ICON_LINK: 'block-massaction-action-duplicatetocourse',\n    SECTION_SELECT: 'block-massaction-control-section-list-select',\n    MOVETO_SELECT: 'block-massaction-control-section-list-moveto',\n    DUPLICATETO_SELECT: 'block-massaction-control-section-list-duplicateto',\n    HIDDEN_FIELD_REQUEST_INFORMATION: 'block-massaction-control-request',\n    ACTION_FORM: 'block-massaction-control-form',\n    SECTION_FILTER_DATA: `[data-block-massaction-data=\"availabletargetsections\"]`\n};\n\nexport const constants = {\n    SECTION_SELECT_DESCRIPTION_VALUE: 'description',\n    SECTION_NUMBER_ALL_PLACEHOLDER: 'all',\n};\n\nconst actions = {\n    HIDE: 'hide',\n    SHOW: 'show',\n    MAKE_AVAILABLE: 'makeavailable',\n    DUPLICATE: 'duplicate',\n    DELETE: 'delete',\n    SHOW_DESCRIPTION: 'showdescription',\n    HIDE_DESCRIPTION: 'hidedescription',\n    MOVE_LEFT: 'moveleft',\n    MOVE_RIGHT: 'moveright',\n    CONTENT_CHANGED_NOTIFICATION: 'contentchangednotification',\n    MOVE_TO: 'moveto',\n    DUPLICATE_TO: 'duplicateto',\n    DUPLICATE_TO_COURSE: 'duplicatetocourse',\n};\n\n/**\n * Initialize the mass-action block.\n */\nexport const init = async() => {\n    const pendingPromise = new Pending('block_massaction/init');\n\n    const editor = getCurrentCourseEditor();\n    // As soon as courseeditor is available, do some initial setup.\n    editor.stateManager.getInitialPromise()\n        .then(() => {\n            // Initialize the checkbox manager.\n            checkboxmanager.initCheckboxManager();\n\n            // Show block depending on if the moodle bulk editing util has been activated.\n            editor.stateManager.target.addEventListener(events.stateChanged, (event) => {\n                // Listen to the event that bulk editing mode has been enabled/disabled.\n                if (event.detail.action === 'bulk.enabled:updated') {\n                    // Hide/show block content depending on the bulk editing enabled state.\n                    document.getElementById(cssIds.BLOCK_CONTENT)?.classList.toggle('d-none');\n                    document.getElementById(cssIds.BULK_EDITING_DISABLED)?.classList.toggle('d-none');\n                }\n            });\n\n            // Register click handler for the button in the placeholder text if bulk editing is still disabled.\n            const enableBulkButton = document.getElementById('block-massaction-enable-bulk-editing');\n            // Remove the initial disabled attribute which is there to avoid too early clicks by users.\n            enableBulkButton.disabled = false;\n            enableBulkButton?.addEventListener('click', () => editor.dispatch('bulkEnable', true));\n            return true;\n        })\n        .catch(error => Log.debug(error));\n\n    document.getElementById(cssIds.SELECT_ALL_LINK)?.addEventListener('click',\n        () => checkboxmanager.setSectionSelection(true, constants.SECTION_NUMBER_ALL_PLACEHOLDER), false);\n\n    document.getElementById(cssIds.DESELECT_ALL_LINK)?.addEventListener('click',\n        () => checkboxmanager.setSectionSelection(false, constants.SECTION_NUMBER_ALL_PLACEHOLDER), false);\n\n    document.getElementById(cssIds.HIDE_LINK)?.addEventListener('click',\n        () => submitAction(actions.HIDE), false);\n\n    document.getElementById(cssIds.SHOW_LINK)?.addEventListener('click',\n        () => submitAction(actions.SHOW), false);\n\n    document.getElementById(cssIds.MAKE_AVAILABLE_LINK)?.addEventListener('click',\n        () => submitAction(actions.MAKE_AVAILABLE), false);\n\n    document.getElementById(cssIds.DUPLICATE_LINK)?.addEventListener('click',\n        () => submitAction(actions.DUPLICATE), false);\n\n    document.getElementById(cssIds.DELETE_LINK)?.addEventListener('click',\n        () => submitAction(actions.DELETE), false);\n\n    document.getElementById(cssIds.SHOW_DESCRIPTION_LINK)?.addEventListener('click',\n        () => submitAction(actions.SHOW_DESCRIPTION), false);\n\n    document.getElementById(cssIds.HIDE_DESCRIPTION_LINK)?.addEventListener('click',\n        () => submitAction(actions.HIDE_DESCRIPTION), false);\n\n    document.getElementById(cssIds.CONTENT_CHANGED_NOTIFICATION_LINK)?.addEventListener('click',\n        () => submitAction(actions.CONTENT_CHANGED_NOTIFICATION), false);\n\n    document.getElementById(cssIds.MOVELEFT_LINK)?.addEventListener('click',\n        () => submitAction(actions.MOVE_LEFT), false);\n\n    document.getElementById(cssIds.MOVERIGHT_LINK)?.addEventListener('click',\n        () => submitAction(actions.MOVE_RIGHT), false);\n\n    document.getElementById(cssIds.MOVETO_ICON_LINK)?.addEventListener('click',\n        () => submitAction(actions.MOVE_TO), false);\n\n    document.getElementById(cssIds.DUPLICATETO_ICON_LINK)?.addEventListener('click',\n        () => submitAction(actions.DUPLICATE_TO), false);\n\n    document.getElementById(cssIds.DUPLICATE_TO_COURSE_ICON_LINK)?.addEventListener('click',\n        () => submitAction(actions.DUPLICATE_TO_COURSE), false);\n\n    pendingPromise.resolve();\n};\n\n/**\n * Submit the selected action to server.\n *\n * @param {string} action\n * @return {boolean} true if action was successful, false otherwise\n */\nconst submitAction = (action) => {\n    const submitData = {\n        'action': action,\n        'moduleIds': []\n    };\n\n    submitData.moduleIds = checkboxmanager.getSelectedModIds();\n\n    // Verify that at least one checkbox is checked.\n    if (submitData.moduleIds.length === 0) {\n        displayError(Str.get_string('noitemselected', 'block_massaction'));\n        return false;\n    }\n\n    // Prep the submission.\n    switch (action) {\n        case actions.HIDE:\n        case actions.SHOW:\n        case actions.MAKE_AVAILABLE:\n        case actions.DUPLICATE:\n        case actions.DUPLICATE_TO_COURSE:\n        case actions.CONTENT_CHANGED_NOTIFICATION:\n        case actions.MOVE_LEFT:\n        case actions.MOVE_RIGHT:\n        case actions.DELETE:\n        case actions.SHOW_DESCRIPTION:\n        case actions.HIDE_DESCRIPTION:\n            break;\n\n        case actions.MOVE_TO:\n            // Get the target section.\n            submitData.moveToTarget = document.getElementById(cssIds.MOVETO_SELECT).value;\n            if (submitData.moveToTarget.trim() === '') {\n                displayError(Str.get_string('nomovingtargetselected', 'block_massaction'));\n                return false;\n            }\n            break;\n\n        case actions.DUPLICATE_TO:\n            // Get the target section.\n            submitData.duplicateToTarget = document.getElementById(cssIds.DUPLICATETO_SELECT).value;\n            if (submitData.duplicateToTarget.trim() === '') {\n                displayError(Str.get_string('nomovingtargetselected', 'block_massaction'));\n                return false;\n            }\n            break;\n        default:\n            displayError('Unknown action: ' + action + '. Coding error.');\n            return false;\n    }\n    // Set the form value and submit.\n    document.getElementById(cssIds.HIDDEN_FIELD_REQUEST_INFORMATION).value = JSON.stringify(submitData);\n    document.getElementById(cssIds.ACTION_FORM).submit();\n    return true;\n};\n\nconst displayError = (errorText) => {\n    Promise.resolve([Str.get_string('error', 'core'), errorText, Str.get_string('back', 'core')])\n        .then(text => Notification.alert(text[0], text[1], text[2]))\n        .catch(error => Log.debug(error));\n};\n"],"names":["ACTIVITY_ITEM","SECTION_NAME","MODULE_ID_PREFIX","BOX_ID_PREFIX","cssIds","BLOCK_CONTENT","BULK_EDITING_DISABLED","SELECT_ALL_LINK","DESELECT_ALL_LINK","HIDE_LINK","SHOW_LINK","MAKE_AVAILABLE_LINK","DUPLICATE_LINK","DELETE_LINK","SHOW_DESCRIPTION_LINK","HIDE_DESCRIPTION_LINK","CONTENT_CHANGED_NOTIFICATION_LINK","MOVELEFT_LINK","MOVERIGHT_LINK","MOVETO_ICON_LINK","DUPLICATETO_ICON_LINK","DUPLICATE_TO_COURSE_ICON_LINK","SECTION_SELECT","MOVETO_SELECT","DUPLICATETO_SELECT","HIDDEN_FIELD_REQUEST_INFORMATION","ACTION_FORM","SECTION_FILTER_DATA","constants","SECTION_SELECT_DESCRIPTION_VALUE","SECTION_NUMBER_ALL_PLACEHOLDER","actions","async","pendingPromise","Pending","editor","stateManager","getInitialPromise","then","checkboxmanager","initCheckboxManager","target","addEventListener","events","stateChanged","event","detail","action","document","getElementById","classList","toggle","enableBulkButton","disabled","dispatch","catch","error","Log","debug","setSectionSelection","submitAction","resolve","submitData","moduleIds","getSelectedModIds","length","displayError","Str","get_string","moveToTarget","value","trim","duplicateToTarget","JSON","stringify","submit","errorText","Promise","text","Notification","alert"],"mappings":";;;;;;;;mbAgCoC,CAChCA,cAAe,iBACfC,aAAc,cACdC,iBAAkB,UAClBC,cAAe,oBAGNC,OAAS,CAClBC,cAAe,mBACfC,sBAAuB,yCACvBC,gBAAiB,qCACjBC,kBAAmB,uCACnBC,UAAW,+BACXC,UAAW,+BACXC,oBAAqB,wCACrBC,eAAgB,oCAChBC,YAAa,iCACbC,sBAAuB,0CACvBC,sBAAuB,0CACvBC,kCAAmC,qDACnCC,cAAe,mCACfC,eAAgB,oCAChBC,iBAAkB,iCAClBC,sBAAuB,sCACvBC,8BAA+B,4CAC/BC,eAAgB,+CAChBC,cAAe,+CACfC,mBAAoB,oDACpBC,iCAAkC,mCAClCC,YAAa,gCACbC,2GAGSC,UAAY,CACrBC,iCAAkC,cAClCC,+BAAgC,0CAG9BC,aACI,OADJA,aAEI,OAFJA,uBAGc,gBAHdA,kBAIS,YAJTA,eAKM,SALNA,yBAMgB,kBANhBA,yBAOgB,kBAPhBA,kBAQS,WARTA,mBASU,YATVA,qCAU4B,6BAV5BA,gBAWO,SAXPA,qBAYY,cAZZA,4BAamB,kCAMLC,qXACVC,eAAiB,IAAIC,iBAAQ,yBAE7BC,QAAS,0CAEfA,OAAOC,aAAaC,oBACfC,MAAK,KAEFC,gBAAgBC,sBAGhBL,OAAOC,aAAaK,OAAOC,iBAAiBC,gBAAOC,cAAeC,yDAElC,yBAAxBA,MAAMC,OAAOC,uCAEbC,SAASC,eAAe7C,OAAOC,uEAAgB6C,UAAUC,OAAO,yCAChEH,SAASC,eAAe7C,OAAOE,iFAAwB4C,UAAUC,OAAO,oBAK1EC,iBAAmBJ,SAASC,eAAe,+CAEjDG,iBAAiBC,UAAW,EAC5BD,MAAAA,kBAAAA,iBAAkBV,iBAAiB,SAAS,IAAMP,OAAOmB,SAAS,cAAc,MACzE,KAEVC,OAAMC,OAASC,aAAIC,MAAMF,wCAE9BR,SAASC,eAAe7C,OAAOG,2EAAkBmC,iBAAiB,SAC9D,IAAMH,gBAAgBoB,qBAAoB,EAAM/B,UAAUE,kCAAiC,kCAE/FkB,SAASC,eAAe7C,OAAOI,6EAAoBkC,iBAAiB,SAChE,IAAMH,gBAAgBoB,qBAAoB,EAAO/B,UAAUE,kCAAiC,kCAEhGkB,SAASC,eAAe7C,OAAOK,qEAAYiC,iBAAiB,SACxD,IAAMkB,aAAa7B,gBAAe,kCAEtCiB,SAASC,eAAe7C,OAAOM,qEAAYgC,iBAAiB,SACxD,IAAMkB,aAAa7B,gBAAe,kCAEtCiB,SAASC,eAAe7C,OAAOO,+EAAsB+B,iBAAiB,SAClE,IAAMkB,aAAa7B,0BAAyB,kCAEhDiB,SAASC,eAAe7C,OAAOQ,0EAAiB8B,iBAAiB,SAC7D,IAAMkB,aAAa7B,qBAAoB,kCAE3CiB,SAASC,eAAe7C,OAAOS,uEAAc6B,iBAAiB,SAC1D,IAAMkB,aAAa7B,kBAAiB,mCAExCiB,SAASC,eAAe7C,OAAOU,mFAAwB4B,iBAAiB,SACpE,IAAMkB,aAAa7B,4BAA2B,mCAElDiB,SAASC,eAAe7C,OAAOW,mFAAwB2B,iBAAiB,SACpE,IAAMkB,aAAa7B,4BAA2B,mCAElDiB,SAASC,eAAe7C,OAAOY,+FAAoC0B,iBAAiB,SAChF,IAAMkB,aAAa7B,wCAAuC,mCAE9DiB,SAASC,eAAe7C,OAAOa,2EAAgByB,iBAAiB,SAC5D,IAAMkB,aAAa7B,qBAAoB,mCAE3CiB,SAASC,eAAe7C,OAAOc,4EAAiBwB,iBAAiB,SAC7D,IAAMkB,aAAa7B,sBAAqB,mCAE5CiB,SAASC,eAAe7C,OAAOe,8EAAmBuB,iBAAiB,SAC/D,IAAMkB,aAAa7B,mBAAkB,mCAEzCiB,SAASC,eAAe7C,OAAOgB,mFAAwBsB,iBAAiB,SACpE,IAAMkB,aAAa7B,wBAAuB,mCAE9CiB,SAASC,eAAe7C,OAAOiB,2FAAgCqB,iBAAiB,SAC5E,IAAMkB,aAAa7B,+BAA8B,GAErDE,eAAe4B,iBASbD,aAAgBb,eACZe,WAAa,QACLf,iBACG,OAGjBe,WAAWC,UAAYxB,gBAAgByB,oBAGH,IAAhCF,WAAWC,UAAUE,cACrBC,aAAaC,IAAIC,WAAW,iBAAkB,sBACvC,SAIHrB,aACChB,kBACAA,kBACAA,4BACAA,uBACAA,iCACAA,0CACAA,uBACAA,wBACAA,oBACAA,8BACAA,oCAGAA,mBAED+B,WAAWO,aAAerB,SAASC,eAAe7C,OAAOmB,eAAe+C,MACjC,KAAnCR,WAAWO,aAAaE,cACxBL,aAAaC,IAAIC,WAAW,yBAA0B,sBAC/C,aAIVrC,wBAED+B,WAAWU,kBAAoBxB,SAASC,eAAe7C,OAAOoB,oBAAoB8C,MACtC,KAAxCR,WAAWU,kBAAkBD,cAC7BL,aAAaC,IAAIC,WAAW,yBAA0B,sBAC/C,uBAIXF,aAAa,mBAAqBnB,OAAS,oBACpC,SAGfC,SAASC,eAAe7C,OAAOqB,kCAAkC6C,MAAQG,KAAKC,UAAUZ,YACxFd,SAASC,eAAe7C,OAAOsB,aAAaiD,UACrC,GAGLT,aAAgBU,YAClBC,QAAQhB,QAAQ,CAACM,IAAIC,WAAW,QAAS,QAASQ,UAAWT,IAAIC,WAAW,OAAQ,UAC/E9B,MAAKwC,MAAQC,sBAAaC,MAAMF,KAAK,GAAIA,KAAK,GAAIA,KAAK,MACvDvB,OAAMC,OAASC,aAAIC,MAAMF"}