YUI.add("moodle-qtype_musictheory-musictheorykeyboardui",function(e,t){M.qtype_musictheory=M.qtype_musictheory||{},M.qtype_musictheory.musictheorykeyboardui={init:function(){}},KeyboardInput=function(e,t,n,r){this.callBack=function(e){return function(t){e(t)}},this.UI=new KeyboardInput.Control.Controller(e,t,this.callBack(n),r)},KeyboardInput.GUIState={},KeyboardInput.Render={},KeyboardInput.Render.Renderer=function(e,t,n){this.can=e,this.state=t,this.coordMgr=n},KeyboardInput.Render.Renderer.prototype.draw=function(){var t=this,n;e.Array.each(this.state.keyboard.getKeys("white"),function(e){n=new KeyboardInput.Render.KeyRend(t.can,t.coordMgr,e),n.draw()}),e.Array.each(this.state.keyboard.getKeys("black"),function(e){n=new KeyboardInput.Render.KeyRend(t.can,t.coordMgr,e),n.draw()})},KeyboardInput.Control={},KeyboardInput.Control.Controller=function(t,n,r){this.canID=t,this.canNode=e.one("#"+t),this.html5Can=this.canNode.getDOMNode(),this.ctx=this.html5Can.getContext("2d"),this.stateXML=e.XML.parse(n),this.state=new KeyboardInput.GUIState.State,this.state.setState(this.stateXML),this.coordMgr=new KeyboardInput.Render.CoordManager(this.state),this.html5Can.width=this.coordMgr.CANVAS_WIDTH,this.html5Can.height=this.coordMgr.CANVAS_HEIGHT,this.callBack=r,this.bindEventListeners(),this.ghostKey=null,this.renderer=new KeyboardInput.Render.Renderer(this.html5Can,this.state,this.coordMgr),this.drawState()},KeyboardInput.Control.Controller.prototype.getLocalCoord=function(e){var t={x:this.canNode.getXY()[0],y:this.canNode.getXY()[1]};return{x:e.pageX-t.x,y:e.pageY-t.y}},KeyboardInput.Control.Controller.prototype.bindEventListeners=function(){if(!this.state.editable)return;var e=this;this.canNode.detachAll(),this.canNode.on("click",function(t){var n=e.getLocalCoord(t);e.onMouseClick({x:n.x,y:n.y})}),this.canNode.on("mousemove",function(t){var n=e.getLocalCoord(t);e.onMouseMove({x:n.x,y:n.y})}),this.canNode.on("mouseleave",function(){e.removeGhostKey(),e.drawState()})},KeyboardInput.Control.Controller.prototype.onMouseClick=function(e){var t=this.coordMgr.getElementFromPoint(e);if(t!==null){var n=this.state.keyboard.getKey(t.register,t.pitchClass);if(n.editable){var r=this.state.keyboard.getKeys("selected").length;!n.selected&&r<this.state.keyboard.maxKeys?(n.selected=!0,this.drawState(),this.callBack(this.state.getState())):n.selected&&(n.selected=!1,this.drawState(),this.callBack(this.state.getState()))}}},KeyboardInput.Control.Controller.prototype.onMouseMove=function(e){var t=this.coordMgr.getElementFromPoint(e);if(t!==null){var n=this.state.keyboard.getKey(t.register,t.pitchClass);n.selected||(this.ghostKey!==null&&(this.ghostKey.isGhost=!1),n.isGhost=!0,this.ghostKey=n,this.drawState())}else this.removeGhostKey(),this.drawState()},KeyboardInput.Control.Controller.prototype.removeGhostKey=function(){this.ghostKey!==null&&typeof (this.ghostKey!=="undefined")&&(this.ghostKey.isGhost=!1,this.ghostKey=null)},KeyboardInput.Control.Controller.prototype.drawState=function(){typeof this.renderer!="undefined"&&this.renderer!==null&&(this.ctx.fillStyle="white",this.ctx.fillRect(0,0,this.coordMgr.canvasWidth,this.coordMgr.canvasHeight),this.renderer.draw())},KeyboardInput.Render.CoordManager=function(e){this.state=e,this.CANVAS_PADDING=15,this.WHITE_KEY_WIDTH=14,this.WHITE_KEY_HEIGHT=80,this.BLACK_KEY_WIDTH=7,this.BLACK_KEY_HEIGHT=60,this.CANVAS_WIDTH=this.CANVAS_PADDING*2+this.WHITE_KEY_WIDTH*52,this.CANVAS_HEIGHT=this.CANVAS_PADDING*2+this.WHITE_KEY_HEIGHT},KeyboardInput.Render.CoordManager.prototype.getElementFromPoint=function(e){return this.isKeyboardPoint(e)?this.getKeyFromPoint(e):null},KeyboardInput.Render.CoordManager.prototype.isKeyboardPoint=function(e){var t={x:this.CANVAS_PADDING,y:this.CANVAS_PADDING},n={x:this.CANVAS_PADDING+this.WHITE_KEY_WIDTH*52,y:this.CANVAS_PADDING+this.WHITE_KEY_HEIGHT};return this.pointWithin(e,t,n)?!0:!1},KeyboardInput.Render.CoordManager.prototype.getKeyFromPoint=function(e){var t={x:e.x-this.CANVAS_PADDING-this.WHITE_KEY_WIDTH*2,y:e.y-this.CANVAS_PADDING},n=Math.floor(t.x/(this.WHITE_KEY_WIDTH*7)+1),r={x:t.x+ -(n-1)*this.WHITE_KEY_WIDTH*7,y:t.y},i=[1,2,4,5,6],s;for(s=0;s<i.length;s++){var o={x:i[s]*this.WHITE_KEY_WIDTH-this.BLACK_KEY_WIDTH/2,y:0},u={x:i[s]*this.WHITE_KEY_WIDTH+this.BLACK_KEY_WIDTH/2,y:this.BLACK_KEY_HEIGHT};if(this.pointWithin(r,o,u))switch(i[s]){case 1:if(n===8)return{register:n,pitchClass:0};return{register:n,pitchClass:1};case 2:return{register:n,pitchClass:3};case 4:return{register:n,pitchClass:6};case 5:if(n===0)return{register:n,pitchClass:9};return{register:n,pitchClass:8};case 6:return{register:n,pitchClass:10}}}var a=Math.floor(r.x/this.WHITE_KEY_WIDTH)+1;switch(a){case 1:return{register:n,pitchClass:0};case 2:if(n===8)return{register:n,pitchClass:0};return{register:n,pitchClass:2};case 3:return{register:n,pitchClass:4};case 4:return{register:n,pitchClass:5};case 5:if(n===0)return{register:n,pitchClass:9};return{register:n,pitchClass:7};case 6:return{register:n,pitchClass:9};case 7:return{register:n,pitchClass:11}}},KeyboardInput.Render.CoordManager.prototype.pointWithin=function(e,t,n){return e.x>=t.x&&e.x<=n.x&&e.y>=t.y&&e.y<=n.y?!0:!1},KeyboardInput.GUIState.Keyboard=function(){this.keys=[],this.maxKeys=0;var e,t;for(e=0;e<=8;e++)this.keys[e]=[];this.keys[0][9]=new KeyboardInput.GUIState.Key(9,0,!0,!1,!1),this.keys[0][10]=new KeyboardInput.GUIState.Key(10,0,!0,!1,!1),this.keys[0][11]=new KeyboardInput.GUIState.Key(11,0,!0,!1,!1);for(e=1;e<=7;e++)for(t=0;t<12;t++)this.keys[e][t]=new KeyboardInput.GUIState.Key(t,e,!0,!1,!1);this.keys[8][0]=new KeyboardInput.GUIState.Key(0,8,!0,!1,!1)},KeyboardInput.GUIState.Keyboard.prototype.getKeys=function(t){var n=[];return e.Array.each(this.keys,function(r){e.Array.each(r,function(e){(t==="all"||t==="white"&&e.isWhiteKey||t==="black"&&!e.isWhiteKey||t==="selected"&&e.selected||t==="givenkeys"&&!e.editable)&&n.push(e)})}),n},KeyboardInput.GUIState.Keyboard.prototype.getKey=function(e,t){return this.keys
[e][t]},KeyboardInput.GUIState.Key=function(e,t,n,r,i){this.pitchClass=e,this.register=parseInt(t,10),this.editable=n,this.selected=r,this.isGhost=i;switch(e){case 0:case 2:case 4:case 5:case 7:case 9:case 11:this.isWhiteKey=!0;break;default:this.isWhiteKey=!1}},KeyboardInput.GUIState.Key.prototype.getSubsetIDWithinRegister=function(){if(this.isWhiteKey)switch(this.pitchClass){case 0:return 0;case 2:return 1;case 4:return 2;case 5:return 3;case 7:return 4;case 9:return 5;case 11:return 6;default:return null}else switch(this.pitchClass){case 1:return 0;case 3:return 1;case 6:return 2;case 8:return 3;case 10:return 4;default:return null}},KeyboardInput.GUIState.State=function(){this.keyboard=new KeyboardInput.GUIState.Keyboard},KeyboardInput.GUIState.State.prototype.setState=function(e){this.stateXML=e;var t=this.stateXML.getElementsByTagName("keyboardinput"),n=parseInt(t[0].getAttribute("maxkeys"),10);this.editable=t[0].getAttribute("canvasEditable")==="true",this.keyboard.maxKeys=n;var r=this.stateXML.getElementsByTagName("givenkey"),i=this.stateXML.getElementsByTagName("selectedkey"),s,o,u,a;for(s=0;s<r.length;s++)u=parseInt(r[s].getAttribute("register"),10),a=parseInt(r[s].getAttribute("pitchclass"),10),o=this.keyboard.getKey(u,a),o.editable=!1;for(s=0;s<i.length;s++)u=parseInt(i[s].getAttribute("register"),10),a=parseInt(i[s].getAttribute("pitchclass"),10),o=this.keyboard.getKey(u,a),o.selected=!0,o.editable=!0},KeyboardInput.GUIState.State.prototype.getState=function(){var e="<keyboardinput>\n",t=this.keyboard.getKeys("givenkeys"),n=this.keyboard.getKeys("selected"),r;e+="  <givenkeys>\n";for(r=0;r<t.length;r++)e+='    <givenkey pitchclass = "'+t[r].pitchClass+'" register = "'+t[r].register+'" />\n';e+="  </givenkeys>\n",e+="  <selectedkeys>\n";for(r=0;r<n.length;r++)e+='    <selectedkey pitchclass = "'+n[r].pitchClass+'" register = "'+n[r].register+'" />\n';return e+="  </selectedkeys>\n",e+="</keyboardinput>",e},KeyboardInput.Render.KeyRend=function(e,t,n){this.can=e,this.coordMgr=t,this.key=n},KeyboardInput.Render.KeyRend.prototype.draw=function(){var e=this.can.getContext("2d"),t=5*this.coordMgr.WHITE_KEY_WIDTH;if(this.key.isWhiteKey){var n=this.key.register*7*this.coordMgr.WHITE_KEY_WIDTH+this.key.getSubsetIDWithinRegister()*this.coordMgr.WHITE_KEY_WIDTH;e.beginPath(),e.rect(this.coordMgr.CANVAS_PADDING+n-t,this.coordMgr.CANVAS_PADDING,this.coordMgr.WHITE_KEY_WIDTH,this.coordMgr.WHITE_KEY_HEIGHT),this.key.editable?this.key.selected?e.fillStyle="#415ded":this.key.isGhost?e.fillStyle="grey":e.fillStyle="white":e.fillStyle="red",e.fill(),e.lineWidth=1,e.strokeStyle="black",e.stroke()}else{var r;switch(this.key.getSubsetIDWithinRegister()){case 0:r=1*this.coordMgr.WHITE_KEY_WIDTH-this.coordMgr.BLACK_KEY_WIDTH/2;break;case 1:r=2*this.coordMgr.WHITE_KEY_WIDTH-this.coordMgr.BLACK_KEY_WIDTH/2;break;case 2:r=4*this.coordMgr.WHITE_KEY_WIDTH-this.coordMgr.BLACK_KEY_WIDTH/2;break;case 3:r=5*this.coordMgr.WHITE_KEY_WIDTH-this.coordMgr.BLACK_KEY_WIDTH/2;break;case 4:r=6*this.coordMgr.WHITE_KEY_WIDTH-this.coordMgr.BLACK_KEY_WIDTH/2;break;default:r=0}var i=this.key.register*7*this.coordMgr.WHITE_KEY_WIDTH+r;e.beginPath(),e.rect(this.coordMgr.CANVAS_PADDING+i-t,this.coordMgr.CANVAS_PADDING,this.coordMgr.BLACK_KEY_WIDTH,this.coordMgr.BLACK_KEY_HEIGHT),this.key.editable?this.key.selected?e.fillStyle="#415ded":this.key.isGhost?e.fillStyle="grey":e.fillStyle="black":e.fillStyle="red",e.fill(),e.lineWidth=1,e.strokeStyle="black",e.stroke()}}},"@VERSION@",{requires:["base","node","datatype"]});
