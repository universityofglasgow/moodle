{"version":3,"file":"manage_subscriptions.min.js","sources":["../src/manage_subscriptions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A module to handle Delete/Update operations of the manage subscription page.\n *\n * @module core_calendar/manage_subscriptions\n * @copyright 2021 Huong Nguyen <huongnv13@gmail.com>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 4.0\n */\n\nimport * as CalendarSelectors from 'core_calendar/selectors';\nimport * as CalendarRepository from 'core_calendar/repository';\nimport * as Modal from 'core/modal_factory';\nimport * as ModalEvents from 'core/modal_events';\nimport {displayException, addNotification, fetchNotifications} from 'core/notification';\nimport Prefetch from 'core/prefetch';\nimport {get_string as getString} from 'core/str';\nimport {eventTypes} from 'core/local/inplace_editable/events';\n\n/**\n * Get subscription id for given element.\n *\n * @param {HTMLElement} element update/delete link\n * @return {Number}\n */\nconst getSubscriptionId = element => {\n    return parseInt(element.closest('tr').dataset.subid);\n};\n\n/**\n * Get subscription name for given element.\n *\n * @param {HTMLElement} element update/delete link\n * @return {String}\n */\nconst getSubscriptionName = element => {\n    return element.closest('tr').dataset.subname;\n};\n\n/**\n * Get subscription table row for subscription id.\n *\n * @param {string} subscriptionId Subscription id\n * @return {Element}\n */\nconst getSubscriptionRow = subscriptionId => {\n    return document.querySelector(`tr[data-subid=\"${subscriptionId}\"]`);\n};\n\n/**\n * Create modal.\n *\n * @param {HTMLElement} element\n * @param {string} messageCode Message code.\n * @return {promise} Promise for modal\n */\nconst createModal = (element, messageCode) => {\n    const subscriptionName = getSubscriptionName(element);\n    return Modal.create({\n        type: Modal.types.SAVE_CANCEL,\n        title: getString('confirmation', 'admin'),\n        body: getString(messageCode, 'calendar', subscriptionName),\n        buttons: {\n            save: getString('yes')\n        },\n    }).then(modal => {\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            element.focus();\n        });\n        modal.show();\n        return modal;\n    });\n};\n\n/**\n * Response handler for delete action.\n *\n * @param {HTMLElement} element\n * @param {Object} data\n * @return {Promise}\n */\nconst responseHandlerForDelete = async(element, data) => {\n    const subscriptionName = getSubscriptionName(element);\n    const message = data.status ? await getString('subscriptionremoved', 'calendar', subscriptionName) : data.warnings[0].message;\n    const type = data.status ? 'info' : 'error';\n    return addNotification({message, type});\n};\n\n/**\n * Register events for update/delete links.\n */\nconst registerEventListeners = () => {\n    document.addEventListener('click', e => {\n        const deleteAction = e.target.closest(CalendarSelectors.actions.deleteSubscription);\n        if (deleteAction) {\n            e.preventDefault();\n            const modalPromise = createModal(deleteAction, 'confirmsubscriptiondelete');\n            modalPromise.then(modal => {\n                modal.getRoot().on(ModalEvents.save, () => {\n                    const subscriptionId = getSubscriptionId(deleteAction);\n                    CalendarRepository.deleteSubscription(subscriptionId).then(data => {\n                        const response = responseHandlerForDelete(deleteAction, data);\n                        return response.then(() => {\n                            const subscriptionRow = getSubscriptionRow(subscriptionId);\n                            return subscriptionRow.remove();\n                        });\n                    }).catch(displayException);\n                });\n\n                return modal;\n            }).catch(displayException);\n        }\n    });\n\n    document.addEventListener(eventTypes.elementUpdated, e => {\n        const inplaceEditable = e.target;\n        if (inplaceEditable.getAttribute('data-component') == 'core_calendar') {\n            fetchNotifications();\n        }\n    });\n};\n\n/**\n * Initialises.\n */\nexport const init = () => {\n    Prefetch.prefetchStrings('moodle', ['yes']);\n    Prefetch.prefetchStrings('core_admin', ['confirmation']);\n    Prefetch.prefetchStrings('core_calendar', ['confirmsubscriptiondelete', 'subscriptionremoved']);\n    registerEventListeners();\n};\n"],"names":["obj","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireWildcard","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","CalendarSelectors","CalendarRepository","Modal","ModalEvents","_prefetch","getSubscriptionName","element","closest","dataset","subname","registerEventListeners","document","addEventListener","e","deleteAction","target","actions","deleteSubscription","preventDefault","createModal","messageCode","subscriptionName","create","type","types","SAVE_CANCEL","title","getString","body","get_string","buttons","save","then","modal","getRoot","on","hidden","focus","show","subscriptionId","parseInt","subid","data","response","async","message","status","warnings","addNotification","responseHandlerForDelete","subscriptionRow","querySelector","concat","getSubscriptionRow","remove","catch","displayException","eventTypes","elementUpdated","getAttribute","fetchNotifications","_exports","init","Prefetch","prefetchStrings"],"mappings":"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"}