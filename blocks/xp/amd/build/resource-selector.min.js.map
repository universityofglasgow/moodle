{"version":3,"file":"resource-selector.min.js","sources":["../src/resource-selector.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Resource selector.\n *\n * @copyright  2018 Frédéric Massart\n * @author     Frédéric Massart <fred@branchup.tech>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'block_xp/throttler'], function($, Ajax, Throttler) {\n    /**\n     * Resource selector.\n     *\n     * @param {String|jQuery} container The container of the contents.\n     * @param {Function} searchFunction The search function.\n     * @param {jQuery} searchTermFieldNode The input field in which the use searches.\n    */\n    function ResourceSelector(container, searchFunction, searchTermFieldNode) {\n        this._eventNode = $('<div>');\n        this.container = $(container);\n\n        this.searchId = 0;\n        this.searchTermNode = searchTermFieldNode;\n\n        this.resultsContainer = container.find('tbody');\n        this.emptyResultsNode = container.find('.results-empty');\n        this.searchingResultsNode = container.find('.searching-results');\n        this.searchResultsNode = container.find('.search-results');\n\n        this.resourceTemplateNode = container.find('.resource-template');\n        this.resourceTemplateNode.hide();\n        this.resourceTemplate = this.resourceTemplateNode.clone();\n        this.resourceTemplate.removeClass('resource-template');\n        this.resourceTemplate.show();\n\n        this.throttler = new Throttler(300);\n        this.searchFunction = searchFunction;\n        this._setEventListeners();\n        this.minChars = 3;\n    }\n\n    ResourceSelector.prototype.clear = function() {\n        this.resultsContainer.empty();\n    };\n\n    ResourceSelector.prototype.displayEmptyResults = function() {\n        this.searchingResultsNode.hide();\n        this.emptyResultsNode.show();\n        this.searchResultsNode.hide();\n    };\n\n    ResourceSelector.prototype.displayNothing = function() {\n        this.searchingResultsNode.hide();\n        this.emptyResultsNode.hide();\n        this.searchResultsNode.hide();\n    };\n\n    ResourceSelector.prototype.displayResults = function(resources) {\n        if (!resources || !resources.length) {\n            this.displayEmptyResults();\n            return;\n        }\n\n        this._publishResults(resources);\n        this.searchingResultsNode.hide();\n        this.emptyResultsNode.hide();\n        this.searchResultsNode.show();\n    };\n\n    ResourceSelector.prototype.displaySearching = function() {\n        this.searchingResultsNode.show();\n        this.emptyResultsNode.hide();\n        this.searchResultsNode.hide();\n    };\n\n    /**\n   * Get resources.\n   *\n   * @param {String} term The term to get the results from.\n   * @return {Promise}\n   */\n    ResourceSelector.prototype.getResources = function(term) {\n        return $.when(this.searchFunction(term));\n    };\n\n    ResourceSelector.prototype.onResourceSelected = function(callback) {\n        this._eventNode.on('resource-selected', callback);\n    };\n\n    ResourceSelector.prototype.search = function(term) {\n        this.searchId += 1;\n        this._performSearch(term, this.searchId);\n    };\n\n    ResourceSelector.prototype.setMinChars = function(minChars) {\n        this.minChars = minChars;\n    };\n\n    ResourceSelector.prototype._onSearchTermKeyUp = function(e) {\n        var term = e.target.value;\n        if (typeof term !== 'string' || term.length < this.minChars) {\n            this.searchingResultsNode.hide();\n            this.throttler.cancel();\n            return;\n        }\n\n        this.displaySearching();\n        this.searchId += 1;\n        this.throttler.schedule(this._performSearchFactory(term, this.searchId));\n    };\n\n    ResourceSelector.prototype._onSelect = function(e) {\n        e.preventDefault();\n        var resource = $(e.target)\n            .closest('.resource-node')\n            .data('resource');\n        if (!resource) {\n            return;\n        }\n        this._eventNode.trigger('resource-selected', resource);\n    };\n\n    ResourceSelector.prototype._performSearchFactory = function(term, searchId) {\n        return function() {\n            this._performSearch(term, searchId);\n        }.bind(this);\n    };\n\n    ResourceSelector.prototype._performSearch = function(term, scheduledSearchId) {\n        return this.getResources(term)\n            .then(\n                function(data) {\n                    if (this.searchId != scheduledSearchId) {\n                        return;\n                    }\n                    this.displayResults(data);\n                }.bind(this)\n            )\n            .fail(\n                function() {\n                    this.displayEmptyResults();\n                }.bind(this)\n            );\n    };\n\n    ResourceSelector.prototype._publishResults = function(resources) {\n        this.clear();\n\n        resources.forEach(\n            function(resource) {\n                var node = this.resourceTemplate.clone();\n                node.find('.resource-name').text(resource.name);\n                if (resource.subname) {\n                    node.find('.resource-subname').text(resource.subname);\n                } else {\n                    node.find('.resource-subname').hide();\n                }\n                node.data('resource', resource);\n                this.resultsContainer.append(node);\n            }.bind(this)\n        );\n    };\n\n    ResourceSelector.prototype._setEventListeners = function() {\n        this.searchTermNode.on('keyup', this._onSearchTermKeyUp.bind(this));\n        this.searchResultsNode.on('click', 'button', this._onSelect.bind(this));\n    };\n\n    return ResourceSelector;\n});\n"],"names":["define","$","Ajax","Throttler","ResourceSelector","container","searchFunction","searchTermFieldNode","_eventNode","searchId","searchTermNode","resultsContainer","find","emptyResultsNode","searchingResultsNode","searchResultsNode","resourceTemplateNode","hide","resourceTemplate","this","clone","removeClass","show","throttler","_setEventListeners","minChars","prototype","clear","empty","displayEmptyResults","displayNothing","displayResults","resources","length","_publishResults","displaySearching","getResources","term","when","onResourceSelected","callback","on","search","_performSearch","setMinChars","_onSearchTermKeyUp","e","target","value","cancel","schedule","_performSearchFactory","_onSelect","preventDefault","resource","closest","data","trigger","bind","scheduledSearchId","then","fail","forEach","node","text","name","subname","append"],"mappings":"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"}