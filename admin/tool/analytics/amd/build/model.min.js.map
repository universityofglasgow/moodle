{"version":3,"file":"model.min.js","sources":["../src/model.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for model actions confirmation.\n *\n * @module     tool_analytics/model\n * @copyright  2017 David Monllao\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'core/log', 'core/notification', 'core/modal_factory', 'core/modal_events', 'core/templates'],\n    function($, Str, log, Notification, ModalFactory, ModalEvents, Templates) {\n\n    /**\n     * List of actions that require confirmation and confirmation message.\n     */\n    var actionsList = {\n        clear: {\n            title: {\n                key: 'clearpredictions',\n                component: 'tool_analytics'\n            }, body: {\n                key: 'clearmodelpredictions',\n                component: 'tool_analytics'\n            }\n\n        },\n        'delete': {\n            title: {\n                key: 'delete',\n                component: 'tool_analytics'\n            }, body: {\n                key: 'deletemodelconfirmation',\n                component: 'tool_analytics'\n            }\n        }\n    };\n\n    /**\n     * Returns the model name.\n     *\n     * @param {Object} actionItem The action item DOM node.\n     * @return {String}\n     */\n    var getModelName = function(actionItem) {\n        var wrap = $(actionItem).closest('[data-model-name]');\n\n        if (wrap.length) {\n            return wrap.attr('data-model-name');\n\n        } else {\n            log.error('Unexpected DOM error - unable to obtain the model name');\n            return '';\n        }\n    };\n\n    /** @alias module:tool_analytics/model */\n    return {\n\n        /**\n         * Displays a confirm modal window before executing the action.\n         *\n         * @param {String} actionId\n         * @param {String} actionType\n         */\n        confirmAction: function(actionId, actionType) {\n            $('[data-action-id=\"' + actionId + '\"]').on('click', function(ev) {\n                ev.preventDefault();\n\n                var a = $(ev.currentTarget);\n\n                if (typeof actionsList[actionType] === \"undefined\") {\n                    log.error('Action \"' + actionType + '\" is not allowed.');\n                    return;\n                }\n\n                var reqStrings = [\n                    actionsList[actionType].title,\n                    actionsList[actionType].body\n                ];\n                reqStrings[1].param = getModelName(a);\n\n                var stringsPromise = Str.get_strings(reqStrings);\n                var modalPromise = ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL});\n\n                $.when(stringsPromise, modalPromise).then(function(strings, modal) {\n                    modal.setTitle(strings[0]);\n                    modal.setBody(strings[1]);\n                    modal.setSaveButtonText(strings[0]);\n                    modal.getRoot().on(ModalEvents.save, function() {\n                        window.location.href = a.attr('href');\n                    });\n                    modal.show();\n                    return modal;\n                }).fail(Notification.exception);\n            });\n        },\n\n        /**\n         * Displays evaluation mode and time-splitting method choices.\n         *\n         * @param  {String}  actionId\n         * @param  {Boolean} trainedOnlyExternally\n         */\n        selectEvaluationOptions: function(actionId, trainedOnlyExternally) {\n            $('[data-action-id=\"' + actionId + '\"]').on('click', function(ev) {\n                ev.preventDefault();\n\n                var a = $(ev.currentTarget);\n\n                var timeSplittingMethods = $(this).attr('data-timesplitting-methods');\n\n                var stringsPromise = Str.get_strings([\n                    {\n                        key: 'evaluatemodel',\n                        component: 'tool_analytics'\n                    }, {\n                        key: 'evaluate',\n                        component: 'tool_analytics'\n                    }\n                ]);\n                var modalPromise = ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL});\n                var bodyPromise = Templates.render('tool_analytics/evaluation_options', {\n                    trainedexternally: trainedOnlyExternally,\n                    timesplittingmethods: JSON.parse(timeSplittingMethods)\n                });\n\n                $.when(stringsPromise, modalPromise).then(function(strings, modal) {\n\n\n                    modal.getRoot().on(ModalEvents.hidden, modal.destroy.bind(modal));\n\n                    modal.setTitle(strings[0]);\n                    modal.setSaveButtonText(strings[1]);\n                    modal.setBody(bodyPromise);\n\n                    modal.getRoot().on(ModalEvents.save, function() {\n\n                        // Evaluation mode.\n                        var evaluationMode = $(\"input[name='evaluationmode']:checked\").val();\n                        if (evaluationMode == 'trainedmodel') {\n                            a.attr('href', a.attr('href') + '&mode=trainedmodel');\n                        }\n\n                        // Selected time-splitting id.\n                        var timeSplittingMethod = $(\"#id-evaluation-timesplitting\").val();\n                        a.attr('href', a.attr('href') + '&timesplitting=' + timeSplittingMethod);\n\n                        window.location.href = a.attr('href');\n                        return;\n                    });\n\n                    modal.show();\n                    return modal;\n                }).fail(Notification.exception);\n            });\n        },\n\n        /**\n         * Displays export options.\n         *\n         * We have two main options: export training data and export configuration.\n         * The 2nd option has an extra option: include the trained algorithm weights.\n         *\n         * @param  {String}  actionId\n         * @param  {Boolean} isTrained\n         */\n        selectExportOptions: function(actionId, isTrained) {\n            $('[data-action-id=\"' + actionId + '\"]').on('click', function(ev) {\n                ev.preventDefault();\n\n                var a = $(ev.currentTarget);\n\n                if (!isTrained) {\n                    // Export the model configuration if the model is not trained. We can't export anything else.\n                    a.attr('href', a.attr('href') + '&action=exportmodel&includeweights=0');\n                    window.location.href = a.attr('href');\n                    return;\n                }\n\n                var stringsPromise = Str.get_strings([\n                    {\n                        key: 'export',\n                        component: 'tool_analytics'\n                    }\n                ]);\n                var modalPromise = ModalFactory.create({type: ModalFactory.types.SAVE_CANCEL});\n                var bodyPromise = Templates.render('tool_analytics/export_options', {});\n\n                $.when(stringsPromise, modalPromise).then(function(strings, modal) {\n\n                    modal.getRoot().on(ModalEvents.hidden, modal.destroy.bind(modal));\n\n                    modal.setTitle(strings[0]);\n                    modal.setSaveButtonText(strings[0]);\n                    modal.setBody(bodyPromise);\n\n                    modal.getRoot().on(ModalEvents.save, function() {\n\n                        var exportOption = $(\"input[name='exportoption']:checked\").val();\n\n                        if (exportOption == 'exportdata') {\n                            a.attr('href', a.attr('href') + '&action=exportdata');\n\n                        } else {\n                            a.attr('href', a.attr('href') + '&action=exportmodel');\n                            if ($(\"#id-includeweights\").is(':checked')) {\n                                a.attr('href', a.attr('href') + '&includeweights=1');\n                            } else {\n                                a.attr('href', a.attr('href') + '&includeweights=0');\n                            }\n                        }\n\n                        window.location.href = a.attr('href');\n                        return;\n                    });\n\n                    modal.show();\n                    return modal;\n                }).fail(Notification.exception);\n            });\n        }\n    };\n});\n"],"names":["define","$","Str","log","Notification","ModalFactory","ModalEvents","Templates","actionsList","clear","title","key","component","body","delete","confirmAction","actionId","actionType","on","ev","preventDefault","a","currentTarget","wrap","reqStrings","param","closest","length","attr","error","stringsPromise","get_strings","modalPromise","create","type","types","SAVE_CANCEL","when","then","strings","modal","setTitle","setBody","setSaveButtonText","getRoot","save","window","location","href","show","fail","exception","selectEvaluationOptions","trainedOnlyExternally","timeSplittingMethods","this","bodyPromise","render","trainedexternally","timesplittingmethods","JSON","parse","hidden","destroy","bind","val","timeSplittingMethod","selectExportOptions","isTrained","is"],"mappings":"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"}