define("plagiarism_turnitin/open_viewer",["jquery"],function($){return{origreport_open:function(){var that=this;$(document).on("click",".pp_origreport_open",function(){for(var classList=$(this).attr("class").replace(/\s+/," ").split(" "),i=0;i<classList.length;i++)if(-1!==classList[i].indexOf("origreport_")&&"pp_origreport_open"!=classList[i]){var classStr=classList[i].split("_");that.openDV("origreport",classStr[1],classStr[2])}})},grademark_open:function(){var that=this;$(document).on("click",".pp_grademark_open",function(){for(var classList=$(this).attr("class").replace(/\s+/," ").split(" "),i=0;i<classList.length;i++)if(-1!==classList[i].indexOf("grademark_")&&"pp_grademark_open"!=classList[i]){var classStr=classList[i].split("_");that.openDV("grademark",classStr[1],classStr[2])}})},openDV:function(dvtype,submissionid,coursemoduleid){var that=this,dvWindow=window.open("","turnitin_viewer"),loading='<div class="tii_dv_loading" style="text-align:center;">';loading+='<img src="'+M.cfg.wwwroot+'/plagiarism/turnitin/pix/turnitin-icon.png" style="width:100px; height: 100px">',loading+='<p style="font-family: Arial, Helvetica, sans-serif;">'+M.str.plagiarism_turnitin.loadingdv+"</p>",loading+="</div>",$(dvWindow.document.body).html(loading),$.ajax({type:"POST",url:M.cfg.wwwroot+"/plagiarism/turnitin/ajax.php",dataType:"json",data:{action:"get_dv_html",submissionid:submissionid,dvtype:dvtype,cmid:coursemoduleid,sesskey:M.cfg.sesskey},success:function(data){$(dvWindow.document.body).html(loading+data),dvWindow.document.forms[0].submit(),dvWindow.document.close(),that.checkDVClosed(submissionid,coursemoduleid,dvWindow)}})},checkDVClosed:function(submissionid,coursemoduleid,dvWindow){var that=this;dvWindow.closed?that.refreshScores(submissionid,coursemoduleid):setTimeout(function(){that.checkDVClosed(submissionid,coursemoduleid,dvWindow)},500)},refreshScores:function(submission_id,coursemoduleid){var refreshStartTime=(new Date).getTime();$.ajax({type:"POST",url:M.cfg.wwwroot+"/plagiarism/turnitin/ajax.php",dataType:"json",data:{action:"update_grade",submission:submission_id,cmid:coursemoduleid,sesskey:M.cfg.sesskey},success:function(){(new Date).getTime()-refreshStartTime<3e3||!$(".turnitin_score_refresh_alert").length?window.location=window.location+"":$(".turnitin_score_refresh_alert").show()}})}}});