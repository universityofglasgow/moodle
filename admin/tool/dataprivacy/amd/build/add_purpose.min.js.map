{"version":3,"file":"add_purpose.min.js","sources":["../src/add_purpose.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to add purposes.\n *\n * @module     tool_dataprivacy/add_purpose\n * @copyright  2018 David Monllao\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/str',\n    'core/ajax',\n    'core/notification',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/fragment',\n    'core_form/changechecker',\n], function(\n    $,\n    Str,\n    Ajax,\n    Notification,\n    ModalFactory,\n    ModalEvents,\n    Fragment,\n    FormChangeChecker\n) {\n\n        var SELECTORS = {\n            PURPOSE_LINK: '[data-add-element=\"purpose\"]',\n        };\n\n        var AddPurpose = function(contextId) {\n            this.contextId = contextId;\n\n            var stringKeys = [\n                {\n                    key: 'addpurpose',\n                    component: 'tool_dataprivacy'\n                },\n                {\n                    key: 'save',\n                    component: 'admin'\n                }\n            ];\n            this.strings = Str.get_strings(stringKeys);\n\n            this.registerEventListeners();\n        };\n\n        /**\n         * @var {int} contextId\n         * @private\n         */\n        AddPurpose.prototype.contextId = 0;\n\n        /**\n         * @var {Promise}\n         * @private\n         */\n        AddPurpose.prototype.strings = 0;\n\n        AddPurpose.prototype.registerEventListeners = function() {\n\n            var trigger = $(SELECTORS.PURPOSE_LINK);\n            trigger.on('click', function() {\n                return this.strings.then(function(strings) {\n                    ModalFactory.create({\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        title: strings[0],\n                        body: '',\n                    }, trigger).done(function(modal) {\n                        this.setupFormModal(modal, strings[1]);\n                    }.bind(this));\n                }.bind(this))\n                .fail(Notification.exception);\n            }.bind(this));\n\n        };\n\n        /**\n         * @method getBody\n         * @param {Object} formdata\n         * @private\n         * @return {Promise}\n         */\n        AddPurpose.prototype.getBody = function(formdata) {\n\n            var params = null;\n            if (typeof formdata !== \"undefined\") {\n                params = {jsonformdata: JSON.stringify(formdata)};\n            }\n            // Get the content of the modal.\n            return Fragment.loadFragment('tool_dataprivacy', 'addpurpose_form', this.contextId, params);\n        };\n\n        AddPurpose.prototype.setupFormModal = function(modal, saveText) {\n            modal.setLarge();\n\n            modal.setSaveButtonText(saveText);\n\n            // We want to reset the form every time it is opened.\n            modal.getRoot().on(ModalEvents.hidden, this.destroy.bind(this));\n\n            modal.setBody(this.getBody());\n\n            // We catch the modal save event, and use it to submit the form inside the modal.\n            // Triggering a form submission will give JS validation scripts a chance to check for errors.\n            modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n            // We also catch the form submit event and use it to submit the form with ajax.\n            modal.getRoot().on('submit', 'form', this.submitFormAjax.bind(this));\n\n            this.modal = modal;\n\n            modal.show();\n        };\n\n        /**\n         * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\n         *\n         * @method submitForm\n         * @param {Event} e Form submission event.\n         * @private\n         */\n        AddPurpose.prototype.submitForm = function(e) {\n            e.preventDefault();\n            this.modal.getRoot().find('form').submit();\n        };\n\n        AddPurpose.prototype.submitFormAjax = function(e) {\n            // We don't want to do a real form submission.\n            e.preventDefault();\n\n            // Convert all the form elements values to a serialised string.\n            var formData = this.modal.getRoot().find('form').serialize();\n\n            Ajax.call([{\n                methodname: 'tool_dataprivacy_create_purpose_form',\n                args: {jsonformdata: JSON.stringify(formData)},\n                done: function(data) {\n                    if (data.validationerrors) {\n                        this.modal.setBody(this.getBody(formData));\n                    } else {\n                        this.close();\n                    }\n                }.bind(this),\n\n                fail: Notification.exception\n            }]);\n        };\n\n        AddPurpose.prototype.close = function() {\n            this.destroy();\n            document.location.reload();\n        };\n\n        AddPurpose.prototype.destroy = function() {\n            FormChangeChecker.resetAllFormDirtyStates();\n            this.modal.destroy();\n        };\n\n        AddPurpose.prototype.removeListeners = function() {\n            $(SELECTORS.PURPOSE_LINK).off('click');\n        };\n\n        return /** @alias module:tool_dataprivacy/add_purpose */ {\n            getInstance: function(contextId) {\n                return new AddPurpose(contextId);\n            }\n        };\n    }\n);\n\n"],"names":["define","$","Str","Ajax","Notification","ModalFactory","ModalEvents","Fragment","FormChangeChecker","SELECTORS","AddPurpose","contextId","this","strings","get_strings","key","component","registerEventListeners","prototype","trigger","on","then","create","type","types","SAVE_CANCEL","title","body","done","modal","setupFormModal","bind","fail","exception","getBody","formdata","params","jsonformdata","JSON","stringify","loadFragment","saveText","setLarge","setSaveButtonText","getRoot","hidden","destroy","setBody","save","submitForm","submitFormAjax","show","e","preventDefault","find","submit","formData","serialize","call","methodname","args","data","validationerrors","close","document","location","reload","resetAllFormDirtyStates","removeListeners","off","getInstance"],"mappings":";;;;;;;AAsBAA,OAAO,+BAAA,CACH,SACA,WACA,YACA,oBACA,qBACA,oBACA,gBACA,4BACD,SACCC,EACAC,IACAC,KACAC,aACAC,aACAC,YACAC,SACAC,mBAGI,IAAIC,uBACc,+BAGdC,WAAa,SAASC,WACtBC,KAAKD,UAAYA,UAYjBC,KAAKC,QAAUX,IAAIY,YAVF,CACb,CACIC,IAAK,aACLC,UAAW,oBAEf,CACID,IAAK,OACLC,UAAW,WAKnBJ,KAAKK,0BAsHT,OA/GAP,WAAWQ,UAAUP,UAAY,EAMjCD,WAAWQ,UAAUL,QAAU,EAE/BH,WAAWQ,UAAUD,uBAAyB,WAE1C,IAAIE,QAAUlB,EAAEQ,wBAChBU,QAAQC,GAAG,QAAS,WAChB,OAAOR,KAAKC,QAAQQ,KAAK,SAASR,SAC9BR,aAAaiB,OAAO,CAChBC,KAAMlB,aAAamB,MAAMC,YACzBC,MAAOb,QAAQ,GACfc,KAAM,IACPR,SAASS,KAAK,SAASC,OACtBjB,KAAKkB,eAAeD,MAAOhB,QAAQ,GACvC,EAAEkB,KAAKnB,MACX,EAAEmB,KAAKnB,OACNoB,KAAK5B,aAAa6B,UACvB,EAAEF,KAAKnB,QAUXF,WAAWQ,UAAUgB,QAAU,SAASC,UAEpC,IAAIC,OAAS,KAKb,YAJwB,IAAbD,WACPC,OAAS,CAACC,aAAcC,KAAKC,UAAUJ,YAGpC5B,SAASiC,aAAa,mBAAoB,kBAAmB5B,KAAKD,UAAWyB,SAGxF1B,WAAWQ,UAAUY,eAAiB,SAASD,MAAOY,UAClDZ,MAAMa,WAENb,MAAMc,kBAAkBF,UAGxBZ,MAAMe,UAAUxB,GAAGd,YAAYuC,OAAQjC,KAAKkC,QAAQf,KAAKnB,OAEzDiB,MAAMkB,QAAQnC,KAAKsB,WAInBL,MAAMe,UAAUxB,GAAGd,YAAY0C,KAAMpC,KAAKqC,WAAWlB,KAAKnB,OAE1DiB,MAAMe,UAAUxB,GAAG,SAAU,OAAQR,KAAKsC,eAAenB,KAAKnB,OAE9DA,KAAKiB,MAAQA,MAEbA,MAAMsB,QAUVzC,WAAWQ,UAAU+B,WAAa,SAASG,GACvCA,EAAEC,iBACFzC,KAAKiB,MAAMe,UAAUU,KAAK,QAAQC,UAGtC7C,WAAWQ,UAAUgC,eAAiB,SAASE,GAE3CA,EAAEC,iBAGF,IAAIG,SAAW5C,KAAKiB,MAAMe,UAAUU,KAAK,QAAQG,YAEjDtD,KAAKuD,KAAK,CAAC,CACPC,WAAY,uCACZC,KAAM,CAACvB,aAAcC,KAAKC,UAAUiB,WACpC5B,KAAM,SAASiC,MACPA,KAAKC,iBACLlD,KAAKiB,MAAMkB,QAAQnC,KAAKsB,QAAQsB,WAEhC5C,KAAKmD,OAEb,EAAEhC,KAAKnB,MAEPoB,KAAM5B,aAAa6B,cAI3BvB,WAAWQ,UAAU6C,MAAQ,WACzBnD,KAAKkC,UACLkB,SAASC,SAASC,UAGtBxD,WAAWQ,UAAU4B,QAAU,WAC3BtC,kBAAkB2D,0BAClBvD,KAAKiB,MAAMiB,WAGfpC,WAAWQ,UAAUkD,gBAAkB,WACnCnE,EAAEQ,wBAAwB4D,IAAI,UAGuB,CACrDC,YAAa,SAAS3D,WAClB,OAAO,IAAID,WAAWC,UAC1B,EAER"}