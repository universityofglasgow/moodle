YUI.add("moodle-block_xp-filters",function(e,t){var n="block_xp",r={ADDFILTER:"filter-add",FILTER:"filter",FILTERSLIST:"filters-list",PREFIX:"block_xp-filters",RULE:"rule",RULES:"rule-rules"},i={ADDFILTER:".filter-add",ADDFILTERBTN:".filter-add a",ADDRULE:".rule-add",ADDRULEBTN:".rule-add a",ADDRULEINRULES:"> .rule-add",CHILDRULESDEFINITIONS:".rule-rules .rule-definition",CONTAINER:".block-xp-filters",DELETEFILTERBTN:".filter-delete",DELETERULEBTN:".rule-delete",FILTER:".filter",FILTERMOVE:".filter-move",FILTERRULES:".filter-rules",FILTERSLIST:".filters-list",FILTERSLISTNODES:".filters-list > li",RULE:".rule",RULEDEFINITION:".rule-definition",RULEMOVE:".rule .rule-move",RULES:".rule-rules"},t="moodle-block_xp-filters",s=function(){s.superclass.constructor.apply(this,arguments)};e.namespace("M.block_xp").Filters=e.extend(s,e.Base,{addFilterLink:null,canAddFilter:!1,container:null,filterDnD:null,rulepicker:null,rulesDnD:null,rulesetTarget:null,initializer:function(){this.container=e.one(this.get("containerSelector")),this.container.delegate("click",this.addNewFilter,i.ADDFILTERBTN,this),this.container.delegate("click",this.addNewRule,i.ADDRULEBTN,this),this.container.delegate("click",this.deleteFilter,i.DELETEFILTERBTN,this),this.container.delegate("click",this.deleteRule,i.DELETERULEBTN,this);var t=this.container.one(i.ADDFILTER);t!==null&&(this.addFilterLink=this.container.one(i.ADDFILTER).cloneNode(!0),this.canAddFilter=!0),this.prepareRuleDialog(),this.filterDnD=e.namespace("M.block_xp.Filters.DnD").init({containerClass:r.FILTERSLIST,containerSelector:this.get("containerSelector")+" "+i.FILTERSLIST,groups:["filters_"+this.container.generateID()],handleSelector:i.FILTERMOVE,nodeClass:r.FILTER,nodeSelector:i.FILTER}),this.filterDnD.on("drag:end",function(){this.fixFilterSortorder()},this),this.filterDnD.on("drop:over",function(){this.fixAddFilterLink()},this),this.rulesDnD={},this.container.all(i.FILTER).each(function(e){this.setFilterRulesDnD(e)},this)},addNewFilter:function(e){var t=e.currentTarget.get("parentNode"),n=this.getNewFilterTemplate();e.preventDefault(),this.canAddFilter&&t.insert(this.addFilterLink.cloneNode(!0),"after"),t.insert(n,"after"),this.fixFilterSortorder(),this.filterDnD.syncTargets(),this.setFilterRulesDnD(n)},addNewRule:function(e){e.preventDefault(),this.rulepicker||this.prepareRuleDialog(),this.rulesetTarget=e.currentTarget.ancestor(i.RULE),this.rulepicker.display()},deleteFilter:function(e){e.preventDefault();var t=e.currentTarget.ancestor(i.FILTER);t.remove(),delete this.rulesDnD[t.generateID()],this.fixFilterSortorder(),this.fixAddFilterLink()},deleteRule:function(t){t.preventDefault();var n=t.currentTarget.ancestor(i.RULE),r=n.ancestor(i.RULE,!1,e.bind(function(e){return e==this.container},this));if(!r)return;n.remove(!0)},fixAddFilterLink:function(){if(!this.canAddFilter)return;var e=this.container.all(i.FILTERSLISTNODES),t,n=e.size();e.each(function(e,i){var s=e.hasClass(r.ADDFILTER),o=!t,u=e.getData("deleted"),a=!o&&t.hasClass(r.ADDFILTER),f=i-1==n;if(u)return;if(o&&!s)e.insert(this.addFilterLink.cloneNode(!0),"before");else{if(!o&&a&&s){e.remove();return}!o&&!a&&!s?e.insert(this.addFilterLink.cloneNode(!0),"before"):f&&!s&&e.insert(this.addFilterLink.cloneNode(!0),"after")}t=e},this)},fixFilterSortorder:function(){var e=this.container.all(i.FILTER),t=0;e.each(function(e){var n=e.getData("basename"),r=e.one('input[name="'+n+'[sortorder]"]');r&&(r.setAttribute("value",t),t++)},this)},generateFilterBasename:function(e){return"filters["+e+"]"},generateRuleBasename:function(e,t){return e+"["+t+"]"},getNewFilterIncrement:function(){var e=this.container.all(i.FILTER),t=0;return e.each(function(e){var n=e.getData("basename"),r=parseInt(/\[([0-9]+)\]$/.exec(n)[1]||0,10);t=t<r?r:t},this),t+1},getNewFilterTemplate:function(){var t=this.get("filter");return t=t.replace(this.get("filterTemplateBasename"),this.generateFilterBasename(this.getNewFilterIncrement())),e.Node.create(t)},getNewRuleIncrement:function(e){var t=e.all(i.CHILDRULESDEFINITIONS),n=0;return t.each(function(e){var t=e.getData("basename"),r=parseInt(/\[([0-9]+)\]$/.exec(t)[1]||0,10);n=n<r?r:n},this),n+1},newRulePicked:function(e,t){var n=this.get("rules")[t],r=n.template,s=this.rulesetTarget.one(i.RULES),o=this.generateRuleBasename(s.getData("basename"),this.getNewRuleIncrement(this.rulesetTarget));r=r.replace(this.get("ruleTemplateBasename"),o),s.insertBefore(r,s.one(i.ADDRULEINRULES)),this.rulesDnD[s.ancestor(i.FILTER).generateID()].syncTargets()},prepareRuleDialog:function(){var t=[];e.Object.each(this.get("rules"),function(e,n){t.push({id:n,name:e.name})},this),this.rulepicker=e.namespace("M.block_xp.RulePicker").init({rules:t}),this.rulepicker.on("picked",this.newRulePicked,this)},setFilterRulesDnD:function(t){if(!t.one(i.RULES))return;this.rulesDnD[t.generateID()]=e.namespace("M.block_xp.Filters.DnD").init({additionalDropsSelector:i.ADDRULE,dropBeforeSelector:i.ADDRULE,containerClass:r.RULES,containerSelector:"#"+t.generateID()+" "+i.RULES,groups:["rules_"+t.generateID()],handleSelector:i.RULEMOVE,nodeClass:r.RULE,nodeSelector:i.RULE}),this.rulesDnD[t.generateID()].on("drop:hit",function(e){var t=e.drag.get("node"),n=e.drop.get("node"),r=t.one(i.RULEDEFINITION).getData("basename"),s=n.ancestor(i.RULES,!0).getData("basename"),o=this.getNewRuleIncrement(n.ancestor(i.RULE)),u=s+"["+o+"]";t.all("[data-basename], [name]").each(function(e){e.hasAttribute("data-basename")&&e.setAttribute("data-basename",e.getAttribute("data-basename").replace(r,u)),e.hasAttribute("name")&&e.setAttribute("name",e.getAttribute("name").replace(r,u))},this)},this)}},{NAME:t,ATTRS:{containerSelector:{validator:e.Lang.isString,value:null},filter:{validator:e.Lang.isString,value:""},filterTemplateBasename:{value:/filters\[[0-9]+\]/g},rules:{validator:e.Lang.isObject,value:null},ruleTemplateBasename:{value:/XXXXX/g}}}),e.namespace("M.block_xp.Filters").init=function(e){return new s(e)};var o=function(){o.superclass.constructor
.apply(this,arguments)};e.namespace("M.block_xp.Filters").DnD=e.extend(o,M.core.dragdrop,{delegate:null,initializer:function(){this.groups=this.get("groups"),this.samenodeclass=this.get("nodeClass"),this.parentnodeclass=this.get("containerClass");var t=new e.DD.Delegate({container:this.get("containerSelector"),nodes:this.get("nodeSelector"),target:!0,handles:[this.get("handleSelector")],dragConfig:{groups:this.groups}});t.dd.plug(e.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),t.dd.plug(e.Plugin.DDConstrained,{constrain:this.get("containerSelector")}),t.dd.plug(e.Plugin.DDWinScroll);var n=e.one(this.get("containerSelector"));t.createDrop(n,this.groups),this.delegate=t,this.publish("drag:end"),this.publish("drop:hit"),this.publish("drop:over"),this.syncTargets()},global_drop_over:function(e){console.log(e);if(!e.drop||!e.drop.inGroup(this.groups))return;console.log(e,1);var t=e.drag.get("node"),n=e.drop.get("node");this.lastdroptarget=e.drop,this.get("dropBeforeSelector")&&n.test(this.get("dropBeforeSelector"))?(n.get("parentNode").insertBefore(t,n),this.drop_over(e),console.log(e,2)):(console.log(e,3),o.superclass.global_drop_over.apply(this,arguments))},drag_end:function(e){this.fire("drag:end",e)},drop_hit:function(e){this.fire("drop:hit",e)},drop_over:function(e){this.fire("drop:over",e)},syncTargets:function(){this.delegate.syncTargets(),this.get("additionalDropsSelector")&&e.one(this.get("containerSelector")).all(this.get("additionalDropsSelector")).each(function(e){this.delegate.createDrop(e,this.groups)},this)}},{NAME:"block_xp-filters-dnd",ATTRS:{additionalDropsSelector:{validator:e.Lang.isString,value:null},containerClass:{validator:e.Lang.isString,value:null},containerSelector:{validator:e.Lang.isString,value:null},dropBeforeSelector:{validator:e.Lang.isString,value:null},groups:{validator:e.Lang.isArray,value:[]},handleSelector:{validator:e.Lang.isString,value:""},nodeClass:{validator:e.Lang.isString,value:null},nodeSelector:{validator:e.Lang.isString,value:null}}}),e.namespace("M.block_xp.Filters.DnD").init=function(e){return new o(e)}},"@VERSION@",{requires:["base","node","moodle-core-dragdrop","moodle-block_xp-rulepicker"]});
