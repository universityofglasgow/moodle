function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}
/**
 * A javascript module to handle separation of author sourced scripts into
 * IFRAMES. All such scripts will have limited access to the actual document
 * on the VLE side and this script represents the VLE side endpoint for
 * message handling needed to give that access. When porting STACK onto VLEs
 * one needs to map this script to do the following:
 *
 *  1. Ensure that searches for target elements/inputs are limited to questions
 *     and do not return any elements outside them.
 *
 *  2. Map any identifiers needed to identify inputs by name.
 *
 *  3. Any change handling related to input value modifications through this
 *     logic gets connected to any such handling on the VLE side.
 *
 *
 * This script is intenttionally ordered so that the VLE specific bits should
 * be at the top.
 *
 *
 * This script assumes the following:
 *
 *  1. Each relevant IFRAME has an `id`-attribute that will be told to this
 *     script.
 *
 *  2. Each such IFRAME exists within the question itself, so that one can
 *     traverse up the DOM tree from that IFRAME to find the border of
 *     the question.
 *
 * @module     qtype_stack/stackjsvle
 * @copyright  2023 Aalto University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define("qtype_stack/stackjsvle",["core/event"],(function(CustomEvents){var IFRAMES={},INPUTS={},INPUTS_INPUT_EVENT={},DISABLE_CHANGES=!1;function vle_get_element(id){for(var candidate=document.getElementById(id),iter=candidate;iter&&!iter.classList.contains("formulation");)iter=iter.parentElement;return iter&&iter.classList.contains("formulation")?candidate:null}function vle_get_input_element(name,srciframe){for(var iter=document.getElementById(srciframe);iter&&!iter.classList.contains("formulation");)iter=iter.parentElement;if(iter&&iter.classList.contains("formulation")){var _possible=iter.querySelector('input[id$="_'+name+'"]');if(null!==_possible)return _possible;if(null!==(_possible=iter.querySelector('input[id$="_'+name+'_1"][type=radio]')))return _possible;if(null!==(_possible=iter.querySelector('select[id$="_'+name+'"]')))return _possible}var possible=document.querySelector('.formulation input[id$="_'+name+'"]');return null!==possible||null!==(possible=document.querySelector('.formulation input[id$="_'+name+'_1"][type=radio]'))?possible:possible=document.querySelector('.formulation select[id$="_'+name+'"]')}function vle_update_dom(modifiedsubtreerootelement){CustomEvents.notifyFilterContentUpdated(modifiedsubtreerootelement)}function is_evil_attribute(name,value){var lcname=name.toLowerCase();if(lcname.startsWith("on"))return!0;if("src"===lcname||lcname.endsWith("href")){var lcvalue=value.replace(/\s+/g,"").toLowerCase();if(lcvalue.includes("javascript:")||lcvalue.includes("data:text"))return!0}return!1}return window.addEventListener("message",(function(e){if("string"==typeof e.data||e.data instanceof String){var msg=null;try{msg=JSON.parse(e.data)}catch(e){return}if("version"in msg&&msg.version.startsWith("STACK-JS")&&"src"in msg&&"type"in msg&&msg.src in IFRAMES){var element=null,input=null,response={version:"STACK-JS:1.0.0"};switch(msg.type){case"register-input-listener":if(null===(input=vle_get_input_element(msg.name,msg.src)))return response.type="error",response.msg='Failed to connect to input: "'+msg.name+'"',response.tgt=msg.src,void IFRAMES[msg.src].contentWindow.postMessage(JSON.stringify(response),"*");if(response.type="initial-input",response.name=msg.name,response.tgt=msg.src,"select"===input.nodeName.toLowerCase()?(response.value=input.value,response["input-type"]="select"):"checkbox"===input.type?(response.value=input.checked,response["input-type"]="checkbox"):(response.value=input.value,response["input-type"]=input.type),"radio"===input.type){response.value="";var _step4,_iterator4=_createForOfIteratorHelper(document.querySelectorAll("input[type=radio][name="+CSS.escape(input.name)+"]"));try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var inp=_step4.value;inp.checked&&(response.value=inp.value)}}catch(err){_iterator4.e(err)}finally{_iterator4.f()}}if(input.id in INPUTS){if(msg.src in INPUTS[input.id])return;if("radio"!==input.type)INPUTS[input.id].push(msg.src);else{var _step5,_iterator5=_createForOfIteratorHelper(document.querySelectorAll("input[type=radio][name="+CSS.escape(input.name)+"]"));try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _inp=_step5.value;INPUTS[_inp.id].push(msg.src)}}catch(err){_iterator5.e(err)}finally{_iterator5.f()}}}else{if("radio"!==input.type)INPUTS[input.id]=[msg.src];else{var _step6,_iterator6=_createForOfIteratorHelper(document.querySelectorAll("input[type=radio][name="+CSS.escape(input.name)+"]"));try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var _inp2=_step6.value;INPUTS[_inp2.id]=[msg.src]}}catch(err){_iterator6.e(err)}finally{_iterator6.f()}}if("radio"!==input.type)input.addEventListener("change",(function(){if(!DISABLE_CHANGES){var resp={version:"STACK-JS:1.0.0",type:"changed-input",name:msg.name};"checkbox"===input.type?resp.value=input.checked:resp.value=input.value;var _step7,_iterator7=_createForOfIteratorHelper(INPUTS[input.id]);try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var tgt=_step7.value;resp.tgt=tgt,IFRAMES[tgt].contentWindow.postMessage(JSON.stringify(resp),"*")}}catch(err){_iterator7.e(err)}finally{_iterator7.f()}}}));else document.querySelectorAll("input[type=radio][name="+CSS.escape(input.name)+"]").forEach((function(inp){inp.addEventListener("change",(function(){if(!DISABLE_CHANGES){var resp={version:"STACK-JS:1.0.0",type:"changed-input",name:msg.name};if(inp.checked){resp.value=inp.value;var _step8,_iterator8=_createForOfIteratorHelper(INPUTS[inp.id]);try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var tgt=_step8.value;resp.tgt=tgt,IFRAMES[tgt].contentWindow.postMessage(JSON.stringify(resp),"*")}}catch(err){_iterator8.e(err)}finally{_iterator8.f()}}}}))}))}if("track-input"in msg&&msg["track-input"]&&"radio"!==input.type)if(input.id in INPUTS_INPUT_EVENT){if(msg.src in INPUTS_INPUT_EVENT[input.id])return;INPUTS_INPUT_EVENT[input.id].push(msg.src)}else INPUTS_INPUT_EVENT[input.id]=[msg.src],input.addEventListener("input",(function(){if(!DISABLE_CHANGES){var resp={version:"STACK-JS:1.0.0",type:"changed-input",name:msg.name};"checkbox"===input.type?resp.value=input.checked:resp.value=input.value;var _step9,_iterator9=_createForOfIteratorHelper(INPUTS_INPUT_EVENT[input.id]);try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var tgt=_step9.value;resp.tgt=tgt,IFRAMES[tgt].contentWindow.postMessage(JSON.stringify(resp),"*")}}catch(err){_iterator9.e(err)}finally{_iterator9.f()}}}));msg.src in INPUTS[input.id]||IFRAMES[msg.src].contentWindow.postMessage(JSON.stringify(response),"*");break;case"changed-input":if(null===(input=vle_get_input_element(msg.name,msg.src))){var ret={version:"STACK-JS:1.0.0",type:"error",msg:'Failed to modify input: "'+msg.name+'"',tgt:msg.src};return void IFRAMES[msg.src].contentWindow.postMessage(JSON.stringify(ret),"*")}DISABLE_CHANGES=!0,"checkbox"===input.type?input.checked=msg.value:input.value=msg.value,function(inputelement){var c=new Event("change");inputelement.dispatchEvent(c);var i=new Event("input");inputelement.dispatchEvent(i)}(input),DISABLE_CHANGES=!1,response.type="changed-input",response.name=msg.name,response.value=msg.value;var _step10,_iterator10=_createForOfIteratorHelper(INPUTS[input.id]);try{for(_iterator10.s();!(_step10=_iterator10.n()).done;){var tgt=_step10.value;tgt!==msg.src&&(response.tgt=tgt,IFRAMES[tgt].contentWindow.postMessage(JSON.stringify(response),"*"))}}catch(err){_iterator10.e(err)}finally{_iterator10.f()}break;case"toggle-visibility":if(null===(element=vle_get_element(msg.target))){var _ret={version:"STACK-JS:1.0.0",type:"error",msg:'Failed to find element: "'+msg.target+'"',tgt:msg.src};return void IFRAMES[msg.src].contentWindow.postMessage(JSON.stringify(_ret),"*")}"show"===msg.set?(element.style.display="block",vle_update_dom(element)):"hide"===msg.set&&(element.style.display="none");break;case"change-content":if(null===(element=vle_get_element(msg.target))){var _ret2={version:"STACK-JS:1.0.0",type:"error",msg:'Failed to find element: "'+msg.target+'"',tgt:msg.src};return void IFRAMES[msg.src].contentWindow.postMessage(JSON.stringify(_ret2),"*")}element.replaceChildren(function(src){var _step,doc=(new DOMParser).parseFromString(src),_iterator=_createForOfIteratorHelper(doc.querySelectorAll("script, style"));try{for(_iterator.s();!(_step=_iterator.n()).done;)_step.value.remove()}catch(err){_iterator.e(err)}finally{_iterator.f()}var _step2,_iterator2=_createForOfIteratorHelper(doc.querySelectorAll("*"));try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _step3,_el=_step2.value,_iterator3=_createForOfIteratorHelper(_el.attributes);try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _step3$value=_step3.value,name=_step3$value.name;is_evil_attribute(name,_step3$value.value)&&_el.removeAttribute(name)}}catch(err){_iterator3.e(err)}finally{_iterator3.f()}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}return doc.body}(msg.content)),vle_update_dom(element);break;case"resize-frame":(element=IFRAMES[msg.src].parentElement).style.width=msg.width,element.style.height=msg.height,IFRAMES[msg.src].style.width="100%",IFRAMES[msg.src].style.height="100%",vle_update_dom(element);break;case"ping":return response.type="ping",response.tgt=msg.src,void IFRAMES[msg.src].contentWindow.postMessage(JSON.stringify(response),"*");case"initial-input":case"error":break;default:response.type="error",response.msg='Unknown message-type: "'+msg.type+'"',response.tgt=msg.src,IFRAMES[msg.src].contentWindow.postMessage(JSON.stringify(response),"*")}}}})),{create_iframe:function(iframeid,content,targetdivid,title,scrolling){var frm=document.createElement("iframe");frm.id=iframeid,frm.style.width="100%",frm.style.height="100%",frm.style.border=0,!1===scrolling?(frm.scrolling="no",frm.style.overflow="hidden"):frm.scrolling="yes",frm.title=title,frm.referrerpolicy="no-referrer",frm.sandbox="allow-scripts allow-downloads",frm.csp="script-src: 'unsafe-inline' 'self' '*';",document.getElementById(targetdivid).replaceChildren(frm),IFRAMES[iframeid]=frm;var src=new Blob([content],{type:"text/html; charset=utf-8"});frm.src=URL.createObjectURL(src)}}}));

//# sourceMappingURL=stackjsvle.min.js.map