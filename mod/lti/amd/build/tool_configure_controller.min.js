define(["jquery","core/ajax","core/notification","core/templates","mod_lti/events","mod_lti/keys","mod_lti/tool_type"],function(a,b,c,d,e,f,g){var h={REGISTRATION_FEEDBACK_CONTAINER:"#registration-feedback-container",EXTERNAL_REGISTRATION_CONTAINER:"#external-registration-container",EXTERNAL_REGISTRATION_PAGE_CONTAINER:"#external-registration-page-container",CARTRIDGE_REGISTRATION_CONTAINER:"#cartridge-registration-container",CARTRIDGE_REGISTRATION_FORM:"#cartridge-registration-form",ADD_TOOL_FORM:"#add-tool-form",TOOL_LIST_CONTAINER:"#tool-list-container",TOOL_CREATE_BUTTON:"#tool-create-button",REGISTRATION_CHOICE_CONTAINER:"#registration-choice-container",TOOL_URL:"#tool-url"},i=function(){return a(h.TOOL_CREATE_BUTTON)},j=function(){return a(h.REGISTRATION_FEEDBACK_CONTAINER)},k=function(){return a(h.TOOL_LIST_CONTAINER)},l=function(){return a(h.EXTERNAL_REGISTRATION_CONTAINER)},m=function(){return a(h.CARTRIDGE_REGISTRATION_CONTAINER)},n=function(){return a(h.REGISTRATION_CHOICE_CONTAINER)},o=function(){return a(h.TOOL_URL).val()},p=function(){l().addClass("hidden")},q=function(){m().addClass("hidden")},r=function(){n().addClass("hidden")},s=function(a){q(),r(),l().removeClass("hidden"),l().find(h.EXTERNAL_REGISTRATION_PAGE_CONTAINER).attr("data-registration-url",a),u(l())},t=function(a){p(),r(),m().removeClass("hidden"),m().find(h.CARTRIDGE_REGISTRATION_FORM).attr("data-cartridge-url",a),u(m())},u=function(a){var b=a.children().clone(!0,!0);a.empty(),a.append(b)},v=function(){y()||(p(),q(),n().removeClass("hidden"),u(n()))},w=function(){k().addClass("hidden")},x=function(){k().removeClass("hidden")},y=function(){return a.trim(j().html())},z=function(a){d.render("mod_lti/registration_feedback",a).done(function(a){p(),q(),r();var b=j();b.append(a)}).fail(c.exception)},A=function(){var a=j();a.empty(),v()},B=function(a){a.addClass("loading")},C=function(a){a.removeClass("loading")},D=function(){var a=k();B(a),g.query().done(function(b){d.render("mod_lti/tool_list",{tools:b}).done(function(b,c){a.empty(),a.append(b),d.runTemplateJS(c)}).fail(c.exception)}).fail(c.exception).always(function(){C(a)})},E=function(){var b=o();if(""===b)return a.Deferred().resolve();var d=i();B(d);var f=g.isCartridge(b);return f.always(function(){C(d)}),f.done(function(c){c.iscartridge?(a(h.TOOL_URL).val(""),a(document).trigger(e.START_CARTRIDGE_REGISTRATION,b)):(s(b),a(h.TOOL_URL).val(""),a(document).trigger(e.START_EXTERNAL_REGISTRATION),w())}),f.fail(c.exception),f},F=function(){a(document).on(e.NEW_TOOL_TYPE,function(){D()}),a(document).on(e.STOP_EXTERNAL_REGISTRATION,function(){x(),v()}),a(document).on(e.START_CARTRIDGE_REGISTRATION,function(a,b){t(b)}),a(document).on(e.STOP_CARTRIDGE_REGISTRATION,function(){m().find(h.CARTRIDGE_REGISTRATION_FORM).removeAttr("data-cartridge-url"),v()}),a(document).on(e.REGISTRATION_FEEDBACK,function(a,b){z(b)});var b=a(h.ADD_TOOL_FORM);b.submit(function(a){a.preventDefault(),E()});var c=j();c.click(function(a){a.preventDefault(),A()}),c.keypress(function(a){a.metaKey||a.shiftKey||a.altKey||a.ctrlKey||(a.keyCode==f.ENTER||a.keyCode==f.SPACE)&&(a.preventDefault(),A())})};return{init:function(){F(),D()}}});