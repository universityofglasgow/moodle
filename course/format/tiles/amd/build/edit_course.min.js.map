{"version":3,"file":"edit_course.min.js","sources":["../src/edit_course.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main Javascript module for format_tiles for when user *IS* editing.\n * See course.js for if they are not editing.\n * Handles the UI changes when tiles are selected and anything else not\n * covered by the specific modules\n *\n * @module format_tiles/edit_course\n * @copyright 2019 David Watson {@link http://evolutioncode.uk}\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since Moodle 3.3\n */\n\n/* eslint space-before-function-paren: 0 */\n\ndefine(\n    [\"jquery\", \"core/config\", \"core/str\", \"core/ajax\", \"format_tiles/edit_browser_storage\"],\n    function($, config, str, ajax, browserStorageEdit) {\n        \"use strict\";\n        var Selector = {\n            EDITING_COLLAPSE_SECID: \"#collapse\",\n            EDITING_COLLAPSE_SEC: \".collapse-section\",\n            EDITING_EXPAND_SEC: \".expand-section\",\n            EDITING_EXPAND_SECID: \"#expand\",\n            ACTIVITY: \"li.activity\",\n            SECTION_ID: \"#section-\",\n            TILE_TITLE: \"li.section.main .tile_bar_text .inplaceeditable a:not(.quickeditlink)\",\n            TILE_BAR_TEXT: \".tile_bar_text\",\n            SECTION: \"ul.section\",\n            SECTION_MAIN: \"li.section.main\",\n            DNDUPLOAD_HIDDEN: \"dndupload-hidden\",\n            ACTIVITYACTION: 'a.cm-edit-action',\n            ACTIONAREA: '.actions',\n            EXPAND_ALL_BTNS: \".expand-collapse-all-btns a\",\n            EXPAND_COLLAPSE_SEC: \".expand-collapse-sec \",\n            EDIT_TITLE_PENCIL: \".quickeditlink\",\n            ICON_PICKER_BTN: \".tileiconcontainer\",\n            TILE_BAR: \".tile_bar\",\n            SECTIONACTIONMENU: '.section_action_menu',\n            MENU_ACTION: \".menu-action\"\n        };\n\n        var Keyboard = {\n            ESCAPE: 27,\n            TAB: 9,\n            RETURN: 13\n        };\n\n        var Event = {\n            CLICK: \"click\",\n            KEYDOWN: \"keydown\",\n            SCROLL: \"scroll\"\n        };\n\n        var DataAttributes = {\n            SECTION: \"data-section\",\n            ORIG_TITLE: \"data-original-title\"\n        };\n\n        var courseId;\n\n        /**\n         * Collapse a given section according to the collapse button pressed.\n         * @param {number} secNum\n         */\n        var collapseSectionFromSecNum = function(secNum) {\n            var section = $(Selector.SECTION_ID + secNum);\n            $(Selector.SECTION_ID + secNum + \"-content\").animate({opacity: 0}, 300);\n            section.find(Selector.ACTIVITY).slideUp(500);\n            section.find(\".section-modchooser\").slideUp(500);\n            section.addClass(\"collapsed\").removeClass(\"expanded\");\n            section.find(\".mod-chooser-outer\").fadeOut(500);\n            browserStorageEdit.setSectionStatus(secNum, false);\n        };\n\n        return {\n            // All args down to \"filttilestowidth\" are copied from course.js.\n            init: function(\n                courseIdInit,\n                useJavascriptNav, // Set by site admin see settings.php.\n                isMobile,\n                sectionNum,\n                useFilterButtons,\n                assumeDataStoreConsent, // Set by site admin see settings.php.\n                reopenLastSection, // Set by site admin see settings.php.\n                userId,\n                fitTilesToWidth,\n                enablecompletion,\n                pageType,\n                allowPhotoTiles,\n                useSubTiles,\n                documentationurl\n            ) {\n                courseId = courseIdInit;\n                // Some args are strings or ints but we prefer bool.  Change to bool now as they are passed on elsewhere.\n                assumeDataStoreConsent = assumeDataStoreConsent === \"1\";\n                // This is also called from lib.php, via edit_form_helper, if user is on course/edit.php or editsection.php.\n                require(['format_tiles/edit_icon_picker'], function(iconPicker) {\n                    iconPicker.init(courseId, pageType, allowPhotoTiles, documentationurl);\n                });\n\n                if (useSubTiles) {\n                    require(['format_tiles/edit_course_mod'], function (editCourseMod) {\n                        editCourseMod.init(courseId);\n                    });\n                }\n\n                $(document).ready(function() {\n                    $(Selector.TILE_BAR_TEXT).on(Event.KEYDOWN, function(e) {\n                        if (e.keyCode === Keyboard.RETURN && !$(e.target).hasClass('form-control')) {\n                            // Return key has been pressed and *not* while the user was inplace editing the title.\n                            window.location = config.wwwroot + '/course/view.php?id=' + courseId\n                                + '&section=' + $(e.currentTarget).parent().attr(DataAttributes.SECTION);\n                        }\n                    });\n\n                    // If the user preference is for JS off, or site admin has disabled, or user is mobile, no JS nav.\n                    if (useJavascriptNav && !isMobile) {\n                        var collapsingAllSectionFromURL = (window.location.search).indexOf(\"expanded=-1\") !== -1;\n                        var finalSectionInCourse = $(Selector.SECTION_MAIN).last().attr(\"data-section\");\n                        browserStorageEdit.init(\n                            userId,\n                            courseId,\n                            assumeDataStoreConsent,\n                            finalSectionInCourse,\n                            collapsingAllSectionFromURL\n                        );\n                    }\n\n                    if (!isMobile) {\n                        // Initialise tooltips shown for example when hover over tile icon \"Click to change icon\".\n                        // But not on mobile as they make clicks harder.\n                        var toolTips = $(\"[data-toggle=tooltip]\");\n                        if (toolTips.length !== 0 && typeof toolTips.tooltip == 'function') {\n                            try {\n                                toolTips.tooltip();\n                            } catch (err) {\n                                require([\"core/log\"], function(log) {\n                                    log.debug(err);\n                                });\n                            }\n                        }\n                    }\n\n                    // We don't want to re-implement show/hide sections, so we let core handle it.\n                    // Core will re-render all activities when it hides section, and they will be in non subtiles form.\n                    // So we just delete them and can add them back when we un-hide or expand.\n                    $('body').on('click keypress', Selector.SECTION_MAIN + ' ' +\n                        Selector.SECTIONACTIONMENU + '[data-true-sectionid] ' +\n                        'a[data-action]', function(e) {\n                            var target = $(e.target).closest(Selector.MENU_ACTION);\n                            var sectionMain = target.closest(Selector.SECTION_MAIN);\n                            if (target.attr(\"data-action\") === \"hide\" || target.attr(\"data-action\") === \"show\") {\n                                // If teacher has clicked \"show\" we still collapse sec to hide the core change - they can re-expand.\n                                collapseSectionFromSecNum(sectionMain.attr(\"data-section\"));\n                                sectionMain.find(Selector.SECTION).find(Selector.ACTIVITY).slideUp(300).remove();\n                            }\n                        });\n\n                    const anchor = window.location.hash;\n                    if (anchor) {\n                        const section = anchor.replace('#section-', '', anchor);\n                        const courseContent = $('#coursecontentcollapse' + section);\n                        if (courseContent && !courseContent.hasClass('show')) {\n                            courseContent.addClass('show');\n                            $('#collapssesection' + section).removeClass('collapsed').attr('aria-expanded', true);\n                        }\n                    }\n                });\n            }\n        };\n    }\n);"],"names":["define","$","config","str","ajax","browserStorageEdit","courseId","Selector","Keyboard","Event","DataAttributes","init","courseIdInit","useJavascriptNav","isMobile","sectionNum","useFilterButtons","assumeDataStoreConsent","reopenLastSection","userId","fitTilesToWidth","enablecompletion","pageType","allowPhotoTiles","useSubTiles","documentationurl","require","iconPicker","editCourseMod","document","ready","on","e","keyCode","target","hasClass","window","location","wwwroot","currentTarget","parent","attr","collapsingAllSectionFromURL","search","indexOf","finalSectionInCourse","last","toolTips","length","tooltip","err","log","debug","closest","sectionMain","secNum","section","animate","opacity","find","slideUp","addClass","removeClass","fadeOut","setSectionStatus","collapseSectionFromSecNum","remove","anchor","hash","replace","courseContent"],"mappings":";;;;;;;;;;;AA6BAA,kCACI,CAAC,SAAU,cAAe,WAAY,YAAa,sCACnD,SAASC,EAAGC,OAAQC,IAAKC,KAAMC,wBA0CvBC,SAxCAC,kBAKU,cALVA,oBAMY,YANZA,uBAQe,iBARfA,iBASS,aATTA,sBAUc,kBAVdA,2BAmBmB,uBAnBnBA,qBAoBa,eAGbC,gBAGQ,GAGRC,cAES,UAITC,uBACS,qBAoBN,CAEHC,KAAM,SACFC,aACAC,iBACAC,SACAC,WACAC,iBACAC,uBACAC,kBACAC,OACAC,gBACAC,iBACAC,SACAC,gBACAC,YACAC,kBAEAnB,SAAWM,aAEXK,uBAAoD,MAA3BA,uBAEzBS,QAAQ,CAAC,kCAAkC,SAASC,YAChDA,WAAWhB,KAAKL,SAAUgB,SAAUC,gBAAiBE,qBAGrDD,aACAE,QAAQ,CAAC,iCAAiC,SAAUE,eAChDA,cAAcjB,KAAKL,aAI3BL,EAAE4B,UAAUC,OAAM,cACd7B,EAAEM,wBAAwBwB,GAAGtB,eAAe,SAASuB,GAC7CA,EAAEC,UAAYzB,iBAAoBP,EAAE+B,EAAEE,QAAQC,SAAS,kBAEvDC,OAAOC,SAAWnC,OAAOoC,QAAU,uBAAyBhC,SACtD,YAAcL,EAAE+B,EAAEO,eAAeC,SAASC,KAAK/B,4BAKzDG,mBAAqBC,SAAU,KAC3B4B,6BAAmF,IAApDN,OAAOC,SAASM,OAAQC,QAAQ,eAC/DC,qBAAuB5C,EAAEM,uBAAuBuC,OAAOL,KAAK,gBAChEpC,mBAAmBM,KACfQ,OACAb,SACAW,uBACA4B,qBACAH,iCAIH5B,SAAU,KAGPiC,SAAW9C,EAAE,4BACO,IAApB8C,SAASC,QAA2C,mBAApBD,SAASE,YAErCF,SAASE,UACX,MAAOC,KACLxB,QAAQ,CAAC,aAAa,SAASyB,KAC3BA,IAAIC,MAAMF,SAS1BjD,EAAE,QAAQ8B,GAAG,iBAAkBxB,sBAAwB,IACnDA,2BAD2BA,wCAET,SAASyB,OACnBE,OAASjC,EAAE+B,EAAEE,QAAQmB,QAAQ9C,sBAC7B+C,YAAcpB,OAAOmB,QAAQ9C,uBACE,SAA/B2B,OAAOO,KAAK,gBAA4D,SAA/BP,OAAOO,KAAK,kBAvF7C,SAASc,YACjCC,QAAUvD,EAAEM,oBAAsBgD,QACtCtD,EAAEM,oBAAsBgD,OAAS,YAAYE,QAAQ,CAACC,QAAS,GAAI,KACnEF,QAAQG,KAAKpD,mBAAmBqD,QAAQ,KACxCJ,QAAQG,KAAK,uBAAuBC,QAAQ,KAC5CJ,QAAQK,SAAS,aAAaC,YAAY,YAC1CN,QAAQG,KAAK,sBAAsBI,QAAQ,KAC3C1D,mBAAmB2D,iBAAiBT,QAAQ,GAkFxBU,CAA0BX,YAAYb,KAAK,iBAC3Ca,YAAYK,KAAKpD,kBAAkBoD,KAAKpD,mBAAmBqD,QAAQ,KAAKM,iBAI9EC,OAAS/B,OAAOC,SAAS+B,QAC3BD,OAAQ,KACFX,QAAUW,OAAOE,QAAQ,YAAa,GAAIF,QAC1CG,cAAgBrE,EAAE,yBAA2BuD,SAC/Cc,gBAAkBA,cAAcnC,SAAS,UACzCmC,cAAcT,SAAS,QACvB5D,EAAE,oBAAsBuD,SAASM,YAAY,aAAarB,KAAK,iBAAiB"}