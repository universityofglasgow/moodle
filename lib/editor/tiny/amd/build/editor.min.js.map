{"version":3,"file":"editor.min.js","sources":["../src/editor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TinyMCE Editor Manager.\n *\n * @module editor_tiny/editor\n * @copyright  2022 Andrew Lyons <andrew@nicols.co.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport jQuery from 'jquery';\nimport Pending from 'core/pending';\nimport {getDefaultConfiguration} from './defaults';\nimport {getTinyMCE, baseUrl} from './loader';\nimport * as Options from './options';\nimport {addToolbarButton, addToolbarButtons, addToolbarSection,\n    removeToolbarButton, removeSubmenuItem} from './utils';\n\n/**\n * Storage for the TinyMCE instances on the page.\n * @type {Map}\n */\nconst instanceMap = new Map();\n\n/**\n * The default editor configuration.\n * @type {Object}\n */\nlet defaultOptions = {};\n\n/**\n * Require the modules for the named set of TinyMCE plugins.\n *\n * @param {string[]} pluginList The list of plugins\n * @return {Promise[]} A matching set of Promises relating to the requested plugins\n */\nconst importPluginList = async(pluginList) => {\n    // Fetch all of the plugins from the list of plugins.\n    // If a plugin contains a '/' then it is assumed to be a Moodle AMD module to import.\n    const pluginHandlers = await Promise.all(pluginList.map(pluginPath => {\n        if (pluginPath.indexOf('/') === -1) {\n            // A standard TinyMCE Plugin.\n            return Promise.resolve(pluginPath);\n        }\n\n        return import(pluginPath);\n    }));\n\n    // Normalise the plugin data to a list of plugin names.\n    // Two formats are supported:\n    // - a string; and\n    // - an array whose first element is the plugin name, and the second element is the plugin configuration.\n    const pluginNames = pluginHandlers.map((pluginConfig) => {\n        if (typeof pluginConfig === 'string') {\n            return pluginConfig;\n        }\n        if (Array.isArray(pluginConfig)) {\n            return pluginConfig[0];\n        }\n        return null;\n    }).filter((value) => value);\n\n    // Fetch the list of pluginConfig handlers.\n    const pluginConfig = pluginHandlers.map((pluginConfig) => {\n        if (Array.isArray(pluginConfig)) {\n            return pluginConfig[1];\n        }\n        return null;\n    }).filter((value) => value);\n\n    return {\n        pluginNames,\n        pluginConfig,\n    };\n};\n\n/**\n * Fetch the language data for the specified language.\n *\n * @param {string} language The language identifier\n * @returns {object}\n */\nconst fetchLanguage = (language) => fetch(\n    `${M.cfg.wwwroot}/lib/editor/tiny/lang.php/${M.cfg.langrev}/${language}`\n).then(response => response.json());\n\n/**\n * Get a list of all Editors in a Map, keyed by the DOM Node that the Editor is associated with.\n *\n * @returns {Map<Node, Editor>}\n */\nexport const getAllInstances = () => new Map(instanceMap.entries());\n\n/**\n * Get the TinyMCE instance for the specified Node ID.\n *\n * @param {string} elementId\n * @returns {TinyMCE|undefined}\n */\nexport const getInstanceForElementId = elementId => getInstanceForElement(document.getElementById(elementId));\n\n/*\n * Get the TinyMCE instance for the specified HTMLElement.\n *\n * @param {HTMLElement} element\n * @returns {TinyMCE|undefined}\n */\nexport const getInstanceForElement = element => {\n    const instance = instanceMap.get(element);\n    if (instance && instance.removed) {\n        instanceMap.remove(element);\n        return undefined;\n    }\n    return instance;\n};\n\n/**\n * Set up TinyMCE for the selector at the specified HTML Node id.\n *\n * @param {object} config The configuration required to setup the editor\n * @param {string} config.elementId The HTML Node ID\n * @param {Object} config.options The editor plugin configuration\n * @return {Promise<TinyMCE>} The TinyMCE instance\n */\nexport const setupForElementId = ({elementId, options}) => {\n    const target = document.getElementById(elementId);\n    return setupForTarget(target, options);\n};\n\n/**\n * Initialise the page with standard TinyMCE requirements.\n *\n * Currently this includes the language taken from the HTML lang property.\n */\nconst initialisePage = async() => {\n    const lang = document.querySelector('html').lang;\n\n    const [tinyMCE, langData] = await Promise.all([getTinyMCE(), fetchLanguage(lang)]);\n    tinyMCE.addI18n(lang, langData);\n};\ninitialisePage();\n\n/**\n * Get the list of plugins to load for the specified configuration.\n *\n * If the specified configuration does not include a plugin configuration, then return the default configuration.\n *\n * @param {object} options\n * @param {array} [options.plugins=null] The plugin list\n * @returns {object}\n */\nconst getPlugins = ({plugins = null} = {}) => {\n    if (plugins) {\n        return plugins;\n    }\n\n    if (defaultOptions.plugins) {\n        return defaultOptions.plugins;\n    }\n\n    return {};\n};\n\n/**\n * Nest the dropdown menu inside the parent DOM.\n *\n * The TinyMCE menu has a significant issue with the Overflow style,\n * and the Boost theme heavily uses Overflow for drawer navigation.\n * Moving the menu container into the parent editor container makes it work correctly.\n *\n * @param {object} editor\n */\n const nestMenu = (editor) => {\n    const container = editor.getContainer();\n    const menuContainer = document.querySelector('body > .tox.tox-tinymce-aux');\n    container.parentNode.appendChild(menuContainer);\n};\n\n/**\n * Get the standard configuration for the specified options.\n *\n * @param {Node} target\n * @param {tinyMCE} tinyMCE\n * @param {object} options\n * @param {Array} plugins\n * @returns {object}\n */\nconst getStandardConfig = (target, tinyMCE, options, plugins) => {\n    const lang = document.querySelector('html').lang;\n\n    const config = Object.assign({}, getDefaultConfiguration(), {\n        // eslint-disable-next-line camelcase\n        base_url: baseUrl,\n\n        // Set the editor target.\n        // https://www.tiny.cloud/docs/tinymce/6/editor-important-options/#target\n        target,\n\n        // Set the language.\n        // https://www.tiny.cloud/docs/tinymce/6/ui-localization/#language\n        // eslint-disable-next-line camelcase\n        language: lang,\n\n        // Load the editor stylesheet into the editor iframe.\n        // https://www.tiny.cloud/docs/tinymce/6/add-css-options/\n        // eslint-disable-next-line camelcase\n        content_css: [\n            options.css,\n        ],\n\n        // Do not convert URLs to relative URLs.\n        // https://www.tiny.cloud/docs/tinymce/6/url-handling/#convert_urls\n        // eslint-disable-next-line camelcase\n        convert_urls: false,\n\n        // Enabled 'advanced' a11y options.\n        // This includes allowing role=\"presentation\" from the image uploader.\n        // https://www.tiny.cloud/docs/tinymce/6/accessibility/\n        // eslint-disable-next-line camelcase\n        a11y_advanced_options: true,\n\n        // Disable quickbars entirely.\n        // The UI is not ideal and we'll wait for it to improve in future before we enable it in Moodle.\n        // eslint-disable-next-line camelcase\n        quickbars_insert_toolbar: '',\n\n        // Disable some of the standard paragraph levels.\n        // https://www.tiny.cloud/docs/tinymce/6/user-formatting-options/#block_formats\n        // eslint-disable-next-line camelcase\n        block_formats: 'Paragraph=p; Heading 3= h3; Heading 4= h4; Heading 5= h5; Heading 6= h6;',\n\n        // The list of plugins to include in the instance.\n        // https://www.tiny.cloud/docs/tinymce/6/editor-important-options/#plugins\n        plugins: [\n            ...plugins,\n        ],\n\n        // Skins\n        skin: 'oxide',\n\n        // Remove the \"Upgrade\" link for Tiny.\n        // https://www.tiny.cloud/docs/tinymce/6/editor-premium-upgrade-promotion/\n        promotion: false,\n\n        // Allow the administrator to disable branding.\n        // https://www.tiny.cloud/docs/tinymce/6/statusbar-configuration-options/#branding\n        branding: options.branding,\n\n        // Put th cells in a thead element.\n        // https://www.tiny.cloud/docs/tinymce/6/table-options/#table_header_type\n        // eslint-disable-next-line camelcase\n        table_header_type: 'sectionCells',\n\n        setup: (editor) => {\n            Options.register(editor, options);\n\n            editor.on('init', function() {\n                // Hide justify alignment sub-menu.\n                removeSubmenuItem(editor, 'align', 'tiny:justify');\n            });\n\n            editor.on('PostRender', function() {\n                // Nest menu if set.\n                if (options.nestedmenu) {\n                    nestMenu(editor);\n                }\n            });\n        },\n    });\n\n    config.toolbar = addToolbarSection(config.toolbar, 'content', 'formatting', true);\n    config.toolbar = addToolbarButton(config.toolbar, 'content', 'link');\n\n    // Add directionality plugins, always.\n    config.toolbar = addToolbarSection(config.toolbar, 'directionality', 'alignment', true);\n    config.toolbar = addToolbarButtons(config.toolbar, 'directionality', ['ltr', 'rtl']);\n\n    // Remove the align justify button from the toolbar.\n    config.toolbar = removeToolbarButton(config.toolbar, 'alignment', 'alignjustify');\n\n    return config;\n};\n\n/**\n * Fetch the TinyMCE configuration for this editor instance.\n *\n * @param {HTMLElement} target\n * @param {TinyMCE} tinyMCE The TinyMCE API\n * @param {Object} options The editor plugin configuration\n * @param {object} pluginValues\n * @param {object} pluginValues.pluginConfig The list of plugin configuration\n * @param {object} pluginValues.pluginNames The list of plugins to load\n * @returns {object} The TinyMCE Configuration\n */\nconst getEditorConfiguration = (target, tinyMCE, options, pluginValues) => {\n    const {\n        pluginNames,\n        pluginConfig,\n    } = pluginValues;\n\n    // Allow plugins to modify the configuration.\n    // This seems a little strange, but we must double-process the config slightly.\n\n    // First we fetch the standard configuration.\n    const instanceConfig = getStandardConfig(target, tinyMCE, options, pluginNames);\n\n    // Next we make any standard changes.\n    // Here we remove the file menu, as it doesn't offer any useful functionality.\n    // We only empty the items list so that a plugin may choose to add to it themselves later if they wish.\n    if (instanceConfig.menu.file) {\n        instanceConfig.menu.file.items = '';\n    }\n\n    // We disable the styles, backcolor, and forecolor plugins from the format menu.\n    // These are not useful for Moodle and we don't want to encourage their use.\n    if (instanceConfig.menu.format) {\n        instanceConfig.menu.format.items = instanceConfig.menu.format.items\n            // Remove forecolor and backcolor.\n            .replace(/forecolor ?/, '')\n            .replace(/backcolor ?/, '')\n\n            // Remove fontfamily for now.\n            .replace(/fontfamily ?/, '')\n\n            // Remove fontsize for now.\n            .replace(/fontsize ?/, '')\n\n            // Remove styles - it just duplicates the format menu in a way which does not respect configuration\n            .replace(/styles ?/, '')\n\n            // Remove any duplicate separators.\n            .replaceAll(/\\| *\\|/g, '|');\n    }\n\n    // Next we call the `configure` function for any plugin which defines it.\n    // We pass the current instanceConfig in here, to allow them to make certain changes to the global configuration.\n    // For example, to add themselves to any menu, toolbar, and so on.\n    // Any plugin which wishes to have configuration options must register those options here.\n    pluginConfig.filter((pluginConfig) => typeof pluginConfig.configure === 'function').forEach((pluginConfig) => {\n        const pluginInstanceOverride = pluginConfig.configure(instanceConfig, options);\n        Object.assign(instanceConfig, pluginInstanceOverride);\n    });\n\n    // Next we convert the plugin configuration into a format that TinyMCE understands.\n    Object.assign(instanceConfig, Options.getInitialPluginConfiguration(options));\n\n    return instanceConfig;\n};\n\n/**\n * Set up TinyMCE for the HTML Element.\n *\n * @param {HTMLElement} target\n * @param {Object} [options={}] The editor plugin configuration\n * @return {Promise<TinyMCE>} The TinyMCE instance\n */\nexport const setupForTarget = async(target, options = {}) => {\n    const instance = getInstanceForElement(target);\n    if (instance) {\n        return Promise.resolve(instance);\n    }\n\n    // Register a new pending promise to ensure that Behat waits for the editor setup to complete before continuing.\n    const pendingPromise = new Pending('editor_tiny/editor:setupForTarget');\n\n    // Get the list of plugins.\n    const plugins = getPlugins(options);\n\n    // Fetch the tinyMCE API, and instantiate the plugins.\n    const [tinyMCE, pluginValues] = await Promise.all([\n        getTinyMCE(),\n        importPluginList(Object.keys(plugins)),\n    ]);\n\n    // TinyMCE uses the element ID as a map key internally, even if the target has changed.\n    // In the case where we have an editor in a modal form which has been detached from the DOM, but the editor not removed,\n    // we need to manually destroy the editor.\n    // We could theoretically do this with a Mutation Observer, but in some cases the Node may be moved,\n    // or added back elsewhere in the DOM.\n    const existingEditor = tinyMCE.EditorManager.get(target.id);\n    if (existingEditor) {\n        if (existingEditor.targetElm.closest('body')) {\n            if (existingEditor.targetElm === target) {\n                pendingPromise.resolve();\n                return Promise.resolve(existingEditor);\n            } else {\n                pendingPromise.resolve();\n                throw new Error('TinyMCE instance already exists for different target with same ID');\n            }\n        } else {\n            existingEditor.destroy();\n        }\n    }\n\n    // Get the editor configuration for this editor.\n    const instanceConfig = getEditorConfiguration(target, tinyMCE, options, pluginValues);\n\n    // Initialise the editor instance for the given configuration.\n    // At this point any plugin which has configuration options registered will have them applied for this instance.\n    const [editor] = await tinyMCE.init(instanceConfig);\n\n    // Store the editor instance in the instanceMap and register a listener on removal to remove it from the map.\n    instanceMap.set(target, editor);\n    editor.on('remove', ({target}) => {\n        // Handle removal of the editor from the map on destruction.\n        instanceMap.delete(target.targetElm);\n    });\n\n    // If the editor is part of a form, also listen to the jQuery submit event.\n    // The jQuery submit event will not trigger the native submit event, and therefore the content will not be saved.\n    // We cannot rely on listening to the bubbled submit event on the document because other events on child nodes may\n    // consume the data before it is saved.\n    if (target.form) {\n        jQuery(target.form).on('submit', () => {\n            editor.save();\n        });\n    }\n\n    pendingPromise.resolve();\n    return editor;\n};\n\n/**\n * Set the default editor configuration.\n *\n * This configuration is used when an editor is initialised without any configuration.\n *\n * @param {object} [options={}]\n */\nexport const configureDefaultEditor = (options = {}) => {\n    defaultOptions = options;\n};\n"],"names":["_jquery","_interopRequireDefault","_pending","Options","obj","nodeInterop","__esModule","default","cache","_getRequireWildcardCache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_systemImportTransformerGlobalIdentifier","window","self","global","WeakMap","cacheBabelInterop","cacheNodeInterop","instanceMap","Map","defaultOptions","importPluginList","async","pluginHandlers","Promise","all","pluginList","map","pluginPath","indexOf","resolve","define","amd","reject","require","module","exports","component","loader","pluginNames","pluginConfig","Array","isArray","filter","value","_exports","getAllInstances","entries","getInstanceForElementId","elementId","getInstanceForElement","document","getElementById","element","instance","removed","remove","setupForElementId","_ref","options","target","setupForTarget","lang","querySelector","tinyMCE","langData","getTinyMCE","language","fetch","concat","M","cfg","wwwroot","langrev","then","response","json","addI18n","initialisePage","getPlugins","plugins","arguments","length","undefined","getStandardConfig","config","assign","getDefaultConfiguration","base_url","baseUrl","content_css","css","convert_urls","a11y_advanced_options","quickbars_insert_toolbar","block_formats","skin","promotion","branding","table_header_type","setup","editor","register","on","removeSubmenuItem","nestedmenu","container","getContainer","menuContainer","parentNode","appendChild","nestMenu","toolbar","addToolbarSection","addToolbarButton","addToolbarButtons","removeToolbarButton","getEditorConfiguration","pluginValues","instanceConfig","menu","file","items","format","replace","replaceAll","configure","forEach","pluginInstanceOverride","getInitialPluginConfiguration","pendingPromise","Pending","keys","existingEditor","EditorManager","id","targetElm","closest","Error","destroy","init","_ref2","delete","form","jQuery","save","configureDefaultEditor"],"mappings":"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"}