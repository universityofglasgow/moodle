define(["jquery","core/ajax","core/notification","core/templates","mod_lti/events","mod_lti/tool_proxy","mod_lti/tool_type","mod_lti/keys","core/str"],function(a,b,c,d,e,f,g,h,i){var j={REGISTRATION_URL:"#external-registration-url",EXTERNAL_REGISTRATION_CONTAINER:"#external-registration-page-container",EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER:"#external-registration-template-container",EXTERNAL_REGISTRATION_CANCEL_BUTTON:"#cancel-external-registration",TOOL_TYPE_CAPABILITIES_CONTAINER:"#tool-type-capabilities-container",TOOL_TYPE_CAPABILITIES_TEMPLATE_CONTAINER:"#tool-type-capabilities-template-container",CAPABILITIES_AGREE_CONTAINER:".capabilities-container"},k=function(){return a(j.EXTERNAL_REGISTRATION_CONTAINER).attr("data-registration-url")},l=function(){return a(j.EXTERNAL_REGISTRATION_CANCEL_BUTTON)},m=function(){return a(j.EXTERNAL_REGISTRATION_CONTAINER)},n=function(){return a(j.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER)},o=function(){return a(j.TOOL_TYPE_CAPABILITIES_CONTAINER)},p=function(){return a(j.TOOL_TYPE_CAPABILITIES_TEMPLATE_CONTAINER)},q=function(){o().addClass("loading")},r=function(){o().removeClass("loading")},s=function(){l().addClass("loading")},t=function(){l().removeClass("loading")},u=function(){o().addClass("hidden")},v=function(){o().removeClass("hidden")},w=function(){m().addClass("hidden")},x=function(){m().removeClass("hidden")},y=function(a){var b=l();b.attr("data-tool-proxy-id",a)},z=function(){var a=l();return a.attr("data-tool-proxy-id")},A=function(){var a=l();a.removeAttr("data-tool-proxy-id")},B=function(){return z()?!0:!1},C=function(a){var c={methodname:"mod_lti_get_tool_proxy_registration_request",args:{id:a}};return b.call([c])[0]},D=function(){s();var b=a.Deferred();if(B()){var d=z();f["delete"](d).done(function(){b.resolve()}).fail(function(a){b.reject(a)})}else b.resolve();return b.done(function(){I(),t()}).fail(function(b){c.exception(b),I(),t(),i.get_strings([{key:"error",component:"moodle"},{key:"failedtodeletetoolproxy",component:"mod_lti"}]).done(function(b){var c={status:b[0],message:b[1],error:!0};a(document).trigger(e.REGISTRATION_FEEDBACK,c)}).fail(c.exception)}),b},E=function(a){var b=d.render("mod_lti/tool_proxy_registration_form",a);return b.done(function(a,b){var c=n();c.append(a),d.runTemplateJS(b),c.find("form").submit(),x()}).fail(c.exception),b},F=function(a){return g.update({id:a.id,state:g.constants.state.configured})},G=function(b){var f=a.Deferred();return d.render("mod_lti/tool_type_capabilities_agree",b).done(function(a,c){var g=p();w(),v(),d.replaceNodeContents(g,a,c);var h=g.find(j.CAPABILITIES_AGREE_CONTAINER);h.on(e.CAPABILITIES_AGREE,function(){q(),F(b).always(function(){r(),g.empty(),f.resolve()})}),h.on(e.CAPABILITIES_DECLINE,function(){g.empty(),f.resolve()})}).fail(f.reject),f.done(function(){u()}).fail(c.exception),f},H=function(){var b=a.Deferred(),c=k();return""===c?b.resolve():f.create({regurl:c}).done(function(a){var c=a.id,d=a.regurl;y(c),C(c).done(function(a){a.reg_url=d,E(a).done(function(){b.resolve()}).fail(b.fail)}).fail(b.fail)}).fail(function(c){D(),a(document).trigger(e.REGISTRATION_FEEDBACK,{status:"error",message:c.message,error:!0}),b.reject(c)}),b},I=function(){B()&&A(),w();var b=n();b.empty(),a(document).trigger(e.STOP_EXTERNAL_REGISTRATION)},J=function(){a(document).on(e.START_EXTERNAL_REGISTRATION,function(){H()});var b=l();b.click(function(a){a.preventDefault(),D()}),b.keypress(function(a){a.metaKey||a.shiftKey||a.altKey||a.ctrlKey||(a.keyCode==h.ENTER||a.keyCode==h.SPACE)&&(a.preventDefault(),D())}),window.triggerExternalRegistrationComplete=function(b){var d=a.Deferred(),f={status:b.status,message:"",error:!1};if("success"==b.status){if(i.get_strings([{key:"success",component:"moodle"},{key:"successfullycreatedtooltype",component:"mod_lti"}]).done(function(a){f.status=a[0],f.message=a[1]}).fail(c.exception),d.done(function(){I(),a(document).trigger(e.REGISTRATION_FEEDBACK,f),a(document).trigger(e.NEW_TOOL_TYPE)}).fail(c.exception),B()){var h=z();g.getFromToolProxyId(h).done(function(a){if(a&&a.length){var b=a[0];b.hascapabilitygroups?G(b).always(function(){d.resolve()}):d.resolve()}else d.resolve()}).fail(function(){d.resolve()})}}else f.message=b.error,f.error=!0,d.done(function(){D().always(function(){a(document).trigger(e.REGISTRATION_FEEDBACK,f)})}).fail(c.exception),d.resolve();return d}};return{init:function(){J()}}});