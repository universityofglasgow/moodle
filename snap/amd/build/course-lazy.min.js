define(["jquery","theme_snap/util","theme_snap/section_asset_management","theme_snap/course_modules"],function(a,b,c,d){return function(e){var f=this;f.courseConfig=e;var g=function(){return 0===a("body").attr("id").indexOf("page-course-view-")},h=function(c){a("#toc-search-results").html("");var d=a("#"+c.replace("#",""));b.scrollToElement(d);var e=a("#searchpin");e.length||(e=a('<i id="searchpin"></i>')),a(d).find(".instancename").prepend(e),a(d).attr("tabindex","-1").focus()};this.setTOCVisibleSection=function(){var b=".section.main.state-visible, #coursetools.state-visible, #snap-add-new-section.state-visible",c=a(b).attr("id");a("#chapters li").removeClass("snap-visible-section"),a('#chapters a[href$="'+c+'"]').parent("li").addClass("snap-visible-section"),a(document).trigger("snapContentRevealed")},this.showSection=function(){if(g()){var b="";a(".section.main.state-visible.set-by-server").length?(b="#"+a(".section.main.state-visible.set-by-server").attr("id"),a(".section.main.state-visible.set-by-server").removeClass("set-by-server")):a(".course-content .section.main, #moodle-blocks,#coursetools, #snap-add-new-section").removeClass("state-visible");var c=location.hash.split("&"),d=c[0],e=c[1]||null;""!==d&&d!==b&&a(b).removeClass("state-visible"),"#coursetools"==d&&a("#moodle-blocks").addClass("state-visible"),null!==e?(a(d).addClass("state-visible"),h(e)):(a(d).addClass("state-visible").focus(),window.scrollTo(0,0));var f=a(".section.main.state-visible,#coursetools.state-visible,#snap-add-new-section.state-visible");f.length||(a(".section.main.current").length?a(".section.main.current").addClass("state-visible").focus():a("#section-0").addClass("state-visible").focus(),window.scrollTo(0,0)),this.setTOCVisibleSection()}};var i=function(){c.init(f),d.init(),f.courseConfig.enablecompletion&&require(["theme_snap/course_conditionals-lazy"],function(a){a(e)}),g()&&(f.showSection(),a(document).on("snapTOCReplaced",function(){f.setTOCVisibleSection()}))},j=function(){a(".section-modchooser-link").click(function(){var b=a(this).attr("data-section");a(".snap-modchooser-addlink").each(function(){var c=this.href.replace(/(section=)[0-9]+/gi,"$1"+b);a(this).attr("href",c)})})};i(),j()}});