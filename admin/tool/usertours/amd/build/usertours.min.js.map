{"version":3,"file":"usertours.min.js","sources":["../src/usertours.js"],"sourcesContent":["/**\n * User tour control library.\n *\n * @module     tool_usertours/usertours\n * @copyright  2016 Andrew Nicols <andrew@nicols.co.uk>\n */\nimport BootstrapTour from './tour';\nimport Templates from 'core/templates';\nimport log from 'core/log';\nimport notification from 'core/notification';\nimport * as tourRepository from './repository';\nimport Pending from 'core/pending';\nimport {eventTypes} from './events';\n\nlet currentTour = null;\nlet tourId = null;\n\n/**\n * Find the first matching tour.\n *\n * @param {object[]} tourDetails\n * @param {object[]} filters\n * @returns {null|object}\n */\nconst findMatchingTour = (tourDetails, filters) => {\n    return tourDetails.find(tour => filters.some(filter => {\n        if (filter && filter.filterMatches) {\n            return filter.filterMatches(tour);\n        }\n\n        return true;\n    }));\n};\n\n/**\n * Initialise the user tour for the current page.\n *\n * @method  init\n * @param   {Array}    tourDetails      The matching tours for this page.\n * @param   {Array}    filters          The names of all client side filters.\n */\nexport const init = async(tourDetails, filters) => {\n    const requirements = [];\n    filters.forEach(filter => {\n        requirements.push(import(`tool_usertours/filter_${filter}`));\n    });\n\n    const filterPlugins = await Promise.all(requirements);\n\n    const matchingTour = findMatchingTour(tourDetails, filterPlugins);\n    if (!matchingTour) {\n        return;\n    }\n\n    // Only one tour per page is allowed.\n    tourId = matchingTour.tourId;\n\n    let startTour = matchingTour.startTour;\n    if (typeof startTour === 'undefined') {\n        startTour = true;\n    }\n\n    if (startTour) {\n        // Fetch the tour configuration.\n        fetchTour(tourId);\n    }\n\n    addResetLink();\n\n    // Watch for the reset link.\n    document.querySelector('body').addEventListener('click', e => {\n        const resetLink = e.target.closest('#resetpagetour');\n        if (resetLink) {\n            e.preventDefault();\n            resetTourState(tourId);\n        }\n    });\n};\n\n/**\n * Fetch the configuration specified tour, and start the tour when it has been fetched.\n *\n * @method  fetchTour\n * @param   {Number}    tourId      The ID of the tour to start.\n */\nconst fetchTour = async tourId => {\n    const pendingPromise = new Pending(`admin_usertour_fetchTour:${tourId}`);\n\n    try {\n        // If we don't have any tour config (because it doesn't need showing for the current user), return early.\n        const response = await tourRepository.fetchTour(tourId);\n        if (response.hasOwnProperty('tourconfig')) {\n            const {html} = await Templates.renderForPromise('tool_usertours/tourstep', response.tourconfig);\n            startBootstrapTour(tourId, html, response.tourconfig);\n        }\n        pendingPromise.resolve();\n    } catch (error) {\n        pendingPromise.resolve();\n        notification.exception(error);\n    }\n};\n\nconst getPreferredResetLocation = () => {\n    let location = document.querySelector('.tool_usertours-resettourcontainer');\n    if (location) {\n        return location;\n    }\n\n    location = document.querySelector('.logininfo');\n    if (location) {\n        return location;\n    }\n\n    location = document.querySelector('footer');\n    if (location) {\n        return location;\n    }\n\n    return document.body;\n};\n\n/**\n * Add a reset link to the page.\n *\n * @method  addResetLink\n */\nconst addResetLink = () => {\n    const pendingPromise = new Pending('admin_usertour_addResetLink');\n\n    Templates.render('tool_usertours/resettour', {})\n    .then(function(html, js) {\n        // Append the link to the most suitable place on the page with fallback to legacy selectors and finally the body if\n        // there is no better place.\n        Templates.appendNodeContents(getPreferredResetLocation(), html, js);\n\n        return;\n    })\n    .catch()\n    .then(pendingPromise.resolve)\n    .catch();\n};\n\n/**\n * Start the specified tour.\n *\n * @method  startBootstrapTour\n * @param   {Number}    tourId      The ID of the tour to start.\n * @param   {String}    template    The template to use.\n * @param   {Object}    tourConfig  The tour configuration.\n * @return  {Object}\n */\nconst startBootstrapTour = (tourId, template, tourConfig) => {\n    if (currentTour && currentTour.tourRunning) {\n        // End the current tour.\n        currentTour.endTour();\n        currentTour = null;\n    }\n\n    document.addEventListener(eventTypes.tourEnded, markTourComplete);\n    document.addEventListener(eventTypes.stepRenderer, markStepShown);\n\n    // Sort out the tour name.\n    tourConfig.tourName = tourConfig.name;\n    delete tourConfig.name;\n\n    // Add the template to the configuration.\n    // This enables translations of the buttons.\n    tourConfig.template = template;\n\n    tourConfig.steps = tourConfig.steps.map(function(step) {\n        if (typeof step.element !== 'undefined') {\n            step.target = step.element;\n            delete step.element;\n        }\n\n        if (typeof step.reflex !== 'undefined') {\n            step.moveOnClick = !!step.reflex;\n            delete step.reflex;\n        }\n\n        if (typeof step.content !== 'undefined') {\n            step.body = step.content;\n            delete step.content;\n        }\n\n        return step;\n    });\n\n    currentTour = new BootstrapTour(tourConfig);\n    return currentTour.startTour();\n};\n\n/**\n * Mark the specified step as being shownd by the user.\n *\n * @method  markStepShown\n * @param   {Event} e\n */\nconst markStepShown = e => {\n    const tour = e.detail.tour;\n    const stepConfig = tour.getStepConfig(tour.getCurrentStepNumber());\n    tourRepository.markStepShown(\n        stepConfig.stepid,\n        tourId,\n        tour.getCurrentStepNumber()\n    ).catch(log.error);\n};\n\n/**\n * Mark the specified tour as being completed by the user.\n *\n * @method  markTourComplete\n * @param   {Event} e\n * @listens tool_usertours/stepRendered\n */\nconst markTourComplete = e => {\n    document.removeEventListener(eventTypes.tourEnded, markTourComplete);\n    document.removeEventListener(eventTypes.stepRenderer, markStepShown);\n\n    const tour = e.detail.tour;\n    const stepConfig = tour.getStepConfig(tour.getCurrentStepNumber());\n    tourRepository.markTourComplete(\n        stepConfig.stepid,\n        tourId,\n        tour.getCurrentStepNumber()\n    ).catch(log.error);\n};\n\n/**\n * Reset the state, and restart the the tour on the current page.\n *\n * @method  resetTourState\n * @param   {Number}    tourId      The ID of the tour to start.\n * @returns {Promise}\n */\nexport const resetTourState = tourId => tourRepository.resetTourState(tourId)\n.then(response => {\n    if (response.startTour) {\n        fetchTour(response.startTour);\n    }\n    return;\n}).catch(notification.exception);\n"],"names":["_tour","_interopRequireDefault","_templates","_log","_notification","tourRepository","obj","nodeInterop","__esModule","default","cache","_getRequireWildcardCache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_pending","_systemImportTransformerGlobalIdentifier","window","self","global","WeakMap","cacheBabelInterop","cacheNodeInterop","currentTour","tourId","_exports","init","async","tourDetails","filters","requirements","forEach","filter","push","define","amd","Promise","resolve","reject","require","concat","module","exports","component","loader","matchingTour","findMatchingTour","find","tour","some","filterMatches","all","startTour","fetchTour","addResetLink","document","querySelector","addEventListener","e","target","closest","preventDefault","resetTourState","pendingPromise","Pending","response","html","Templates","renderForPromise","tourconfig","startBootstrapTour","error","notification","exception","render","then","js","appendNodeContents","getPreferredResetLocation","location","body","catch","template","tourConfig","tourRunning","endTour","eventTypes","tourEnded","markTourComplete","stepRenderer","markStepShown","tourName","name","steps","map","step","element","reflex","moveOnClick","content","BootstrapTour","detail","stepConfig","getStepConfig","getCurrentStepNumber","stepid","log","removeEventListener"],"mappings":"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"}