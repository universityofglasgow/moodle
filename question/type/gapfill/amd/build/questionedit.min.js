define(["jquery","qtype_gapfill/Item"],function(a,b){return{init:function(){function c(a){for(var b=[],c=0,d=a.length;c<d;c++)b.push(a[c]);return b}function d(a){var b,c,d={};if(a.length){var e=a.get(0);if(window.getComputedStyle){var f=/-([a-z])/g,g=function(a,b){return b.toUpperCase()},h=function(a){return a.replace(f,g)};if(b=window.getComputedStyle(e,null))for(var i,j,k=0,l=b.length;k<l;k++)c=b[k],i=h(c),j=b.getPropertyValue(c),d[i]=j;else if(b=e.currentStyle)for(c in b)d[c]=b[c];else if(b=e.style)for(c in b)"function"!=typeof b[c]&&(d[c]=b[c]);return d}}return!1}a("#id_itemsettings_button").on("click",function(){var b=a(".editor_atto").length;if(b<1)return a("#id_error_itemsettings_button").css({display:"inline",color:"red"}),void(a("#id_error_itemsettings_button")[0].innerHTML=M.util.get_string("itemsettingserror","qtype_gapfill"));if(a("#questiontext .atto_html_button").attr("disabled","true"),a("#id_questiontexteditable").get(0).isContentEditable){a("#id_questiontexteditable").attr("contenteditable","false"),a("#fitem_id_questiontext").find("button").attr("disabled","true");var c=a("#id_questiontexteditable").css("height"),f=a("#id_questiontexteditable").css("width");a("#id_questiontexteditable").css("display","none"),a("#id_itemsettings_canvas").css(d(a("#id_questiontexteditable")));var g=a("#id_questiontexteditable").closest(".editor_atto_content_wrap");a("#id_itemsettings_canvas").appendTo(g).css("position","relative"),a("#id_itemsettings_canvas").css({display:"block",background:"lightgrey"}),a("#id_itemsettings_canvas").html(a("#id_questiontexteditable").prop("innerHTML")),a("#id_itemsettings_canvas").css({height:c,width:f}),a("#id_itemsettings_canvas").css({height:"100%",width:"100%"}),a("#id_itemsettings_button").html(M.util.get_string("editquestiontext","qtype_gapfill")),a("#id_itemsettings_canvas").height(a("#id_questiontexteditable").height()),e(a("#id_itemsettings_canvas")[0])}else a("#id_questiontexteditable").css({display:"block",backgroundColor:"white"}),a("#id_questiontexteditable").attr("contenteditable","true"),a("#id_itemsettings_canvas").css("display","none"),a("#fitem_id_questiontext").find("button").removeAttr("disabled"),a("#id_settings_popup").css("display","none"),a("#id_itemsettings_button").html(M.util.get_string("additemsettings","qtype_gapfill")),a("[class^=atto_]").removeAttr("disabled")}),a("#id_itemsettings_canvas").on("click",function(c){if(!a("#id_questiontexteditable").get(0).isContentEditable&&c.target.id.match(/^id[0-9]+_/)){var d=a("#id_delimitchars").val(),e=new b(c.target.innerHTML,d),f=e.getItemSettings(c.target);null===f||0===f.length?(a("#id_correcteditable").html(""),a("#id_incorrecteditable").html("")):(a("#id_correcteditable").html(f.correctfeedback),a("#id_incorrecteditable").html(f.incorrectfeedback)),a("label[for*='id_correct']").text(M.util.get_string("correct","qtype_gapfill")),a("label[for*='id_incorrect']").text(M.util.get_string("incorrect","qtype_gapfill")),a("#id_itemsettings_popup .atto_image_button").attr("disabled","true"),a("#id_itemsettings_popup .atto_media_button").attr("disabled","true"),a("#id_itemsettings_popup .atto_managefiles_button").attr("disabled","true");var g=M.util.get_string("additemsettings","qtype_gapfill");g+=": "+a("<div/>").html(e.stripdelim()).text(),require(["jquery","jqueryui"],function(a){a("#id_itemsettings_popup").dialog({position:{my:"right",at:"right",of:"#id_itemsettings_canvas"},height:500,width:"70%",modal:!1,title:g,buttons:[{text:"OK",click:function(){var b=e.updateJson(c);a("[class^=atto_]").removeAttr("disabled"),a("[name='itemsettings']").val(b),a(".ui-dialog-content").dialog("close"),a("#id_questiontexteditable").attr("contenteditable","true"),a("#id_itemsettings_button").click()}}]})})}});var e=function(){return function(d){var f=0,g=[];d=d&&d.parentNode?d:document.body;var h,i=c(d.childNodes);"id_questiontextfeedback"===d.id&&f>0&&(f=0);for(var j,k,l,m=a("#id_delimitchars").val(),n=m.substring(0,1),o=m.substring(1,2),p=new RegExp("(\\"+n+".*?\\"+o+")","g"),q=document.createElement("span"),r={script:"",button:"",input:"",select:"",textarea:"",option:""},s=0,t=i.length;s<t;s++)if(h=i[s],1!==h.nodeType||h.tagName.toLowerCase()in r){if(3===h.nodeType){var u=new RegExp("(\\"+n+".*?\\"+o+")","g");if(k=h.data.split(u)){j=document.createDocumentFragment();for(var v=0,w=k.length;v<w;v++)if(p.test(k[v])){l=q.cloneNode(!1),f++,l.className="item";var x=new b(k[v],a("#id_delimitchars").val());if(x.gaptext>""){for(var y=0,z=0;z<g.length;++z)g[z]===x.text&&y++;x.id="id"+f+"_"+y,l.id=x.id;var A=x.getItemSettings(x);x.striptags(A.correctfeedback)>""&&(l.className="hascorrect"),x.striptags(A.incorrectfeedback)>""&&(l.className=l.className+" hasnocorrect"),g.push(x.gaptext)}l.appendChild(document.createTextNode(k[v])),j.appendChild(l)}else j.appendChild(document.createTextNode(k[v]))}h.parentNode.replaceChild(j,h)}}else e(h)}}()}}});