{"version":3,"file":"courseindex.min.js","sources":["../src/courseindex.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * End users have asked that course indexes be collapsed by default.\n * Because of the mechanisms involved, this script accepts an argument\n * from the drawers.mustache template that determines if the course\n * indexes should be collapsed initially, or expanded by what has been\n * stored in mdl_user_preferences and local storage.\n *\n * @module     theme_hillhead40/courseindex\n * @author     Greg Pedder <greg.pedder@glasgow.ac.uk>\n * @copyright  2023 University of Glasgow\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport * as Log from 'core/log';\n\nconst Selectors = {\n    COURSE_INDEX: '[aria-controls*=\"courseindexcollapse\"]'\n};\n\nconst CourseIndex = (coursindexcollapsed) => {\n    let params = (new URL(location.href)).searchParams;\n    let courseindexcollapsed = coursindexcollapsed;\n    if (params.get('id') > 1 && courseindexcollapsed) {\n        Log.debug('CourseIndex called with params:' + params + ' coursindexcollapsed is:' + coursindexcollapsed);\n        waitForElement(Selectors.COURSE_INDEX, params.get('id'));\n    }\n\n    return;\n};\n\n/**\n * @param {HTMLElement} selector\n * @param {int} selectorId\n * @param {int} timeout\n * @returns {Promise<*|null>}\n */\nasync function waitForElement(selector, selectorId, timeout = 15000) {\n    Log.debug('waitForElement called...');\n    const start = Date.now();\n\n    while (Date.now() - start < timeout) {\n        Log.debug('searching for selector:' + selector);\n        const el = document.querySelector(selector);\n        if (el) {\n            Log.debug('Calling setCourseIndexState with selector:' + selector);\n            return setCourseIndexState(selector, selectorId);\n        }\n        await new Promise(resolve => setTimeout(resolve, 1000));\n    }\n\n    return null;\n}\n\n/**\n * This function collapses the course indexes by default. This is only ever\n * called if the user hasn't visited this course page before. Otherwise, we\n * let Moodle's JavaScript take care of things.\n * @param {HTMLElement} element\n * @param {int} courseId\n*/\nconst setCourseIndexState = (element, courseId) => {\n\n    Log.debug(`setCourseIndexState was called with element ${element} and courseId ${courseId}.`);\n\n    if (document.querySelectorAll(element).length == 0) {\n        Log.debug('Page is missing the course index section, no need to continue.');\n        return false;\n    }\n\n    const courseIndexSectionItems = document.querySelectorAll(Selectors.COURSE_INDEX);\n    Log.debug('Collapsing all course indexes...');\n    courseIndexSectionItems.forEach((indexSectionItem) => {\n        $(indexSectionItem.click());\n    });\n};\n\nexport const init = (coursindexcollapsed) => {\n    new CourseIndex(coursindexcollapsed);\n};"],"names":["Selectors","CourseIndex","coursindexcollapsed","params","URL","location","href","searchParams","courseindexcollapsed","get","Log","debug","waitForElement","selector","selectorId","timeout","start","Date","now","document","querySelector","setCourseIndexState","Promise","resolve","setTimeout","element","courseId","querySelectorAll","length","courseIndexSectionItems","forEach","indexSectionItem","click"],"mappings":"69DA+BMA,uBACY,yCAGZC,YAAc,SAACC,yBACbC,OAAU,IAAIC,IAAIC,SAASC,MAAOC,aAClCC,qBAAuBN,oBACvBC,OAAOM,IAAI,MAAQ,GAAKD,uBACxBE,IAAIC,MAAM,kCAAoCR,OAAS,2BAA6BD,4EACpFU,CAAeZ,uBAAwBG,OAAOM,IAAI,sGAY1D,iBAA8BI,SAAUC,mJAAYC,mDAAU,KAC1DL,IAAIC,MAAM,4BACJK,MAAQC,KAAKC,kBAEZD,KAAKC,MAAQF,MAAQD,oCACxBL,IAAIC,MAAM,0BAA4BE,WAC3BM,SAASC,cAAcP,wCAE9BH,IAAIC,MAAM,6CAA+CE,mCAClDQ,oBAAoBR,SAAUC,4CAEnC,IAAIQ,SAAQ,SAAAC,gBAAWC,WAAWD,QAAS,8EAG9C,yGAULF,oBAAsB,SAACI,QAASC,aAElChB,IAAIC,4DAAqDc,iCAAwBC,eAEhC,GAA7CP,SAASQ,iBAAiBF,SAASG,cACnClB,IAAIC,MAAM,mEACH,MAGLkB,wBAA0BV,SAASQ,iBAAiB3B,wBAC1DU,IAAIC,MAAM,oCACVkB,wBAAwBC,SAAQ,SAACC,sCAC3BA,iBAAiBC,2BAIP,SAAC9B,yBACbD,YAAYC"}