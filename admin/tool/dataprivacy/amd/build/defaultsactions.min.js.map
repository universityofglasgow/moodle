{"version":3,"file":"defaultsactions.min.js","sources":["../src/defaultsactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for data registry defaults actions.\n *\n * @module     tool_dataprivacy/defaultsactions\n * @copyright  2018 Jun Pataleta\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/str',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/templates'],\nfunction($, Ajax, Notification, Str, ModalFactory, ModalEvents, Templates) {\n\n    /**\n     * List of action selectors.\n     *\n     * @type {{EDIT_LEVEL_DEFAULTS: string}}\n     * @type {{NEW_ACTIVITY_DEFAULTS: string}}\n     * @type {{EDIT_ACTIVITY_DEFAULTS: string}}\n     * @type {{DELETE_ACTIVITY_DEFAULTS: string}}\n     */\n    var ACTIONS = {\n        EDIT_LEVEL_DEFAULTS: '[data-action=\"edit-level-defaults\"]',\n        NEW_ACTIVITY_DEFAULTS: '[data-action=\"new-activity-defaults\"]',\n        EDIT_ACTIVITY_DEFAULTS: '[data-action=\"edit-activity-defaults\"]',\n        DELETE_ACTIVITY_DEFAULTS: '[data-action=\"delete-activity-defaults\"]'\n    };\n\n    /** @type {{INHERIT: Number}} **/\n    var INHERIT = -1;\n\n    /**\n     * DefaultsActions class.\n     */\n    var DefaultsActions = function() {\n        this.registerEvents();\n    };\n\n    /**\n     * Register event listeners.\n     */\n    DefaultsActions.prototype.registerEvents = function() {\n        $(ACTIONS.EDIT_LEVEL_DEFAULTS).click(function(e) {\n            e.preventDefault();\n\n            var button = $(this);\n            var contextLevel = button.data('contextlevel');\n            var category = button.data('category');\n            var purpose = button.data('purpose');\n\n            // Get options.\n            var requests = [\n                {methodname: 'tool_dataprivacy_get_category_options', args: {}},\n                {methodname: 'tool_dataprivacy_get_purpose_options', args: {}}\n            ];\n\n            var promises = Ajax.call(requests);\n            var titlePromise = Str.get_string('editdefaults', 'tool_dataprivacy', $('#defaults-header').text());\n            $.when(promises[0], promises[1], titlePromise).then(function(categoryResponse, purposeResponse, title) {\n                var categories = categoryResponse.options;\n                var purposes = purposeResponse.options;\n                showDefaultsFormModal(title, contextLevel, category, purpose, null, categories, purposes, null);\n\n                return true;\n            }).catch(Notification.exception);\n        });\n\n        $(ACTIONS.NEW_ACTIVITY_DEFAULTS).click(function(e) {\n            e.preventDefault();\n\n            var button = $(this);\n            var contextLevel = button.data('contextlevel');\n\n            // Get options.\n            var requests = [\n                {methodname: 'tool_dataprivacy_get_category_options', args: {}},\n                {methodname: 'tool_dataprivacy_get_purpose_options', args: {}},\n                {methodname: 'tool_dataprivacy_get_activity_options', args: {'nodefaults': true}}\n            ];\n\n            var promises = Ajax.call(requests);\n            var titlePromise = Str.get_string('addnewdefaults', 'tool_dataprivacy');\n\n            $.when(promises[0], promises[1], promises[2], titlePromise).then(\n                function(categoryResponse, purposeResponse, activityResponse, title) {\n                    var categories = categoryResponse.options;\n                    var purposes = purposeResponse.options;\n                    var activities = activityResponse.options;\n\n                    showDefaultsFormModal(title, contextLevel, null, null, null, categories, purposes, activities);\n\n                    return true;\n\n                }).catch(Notification.exception);\n            }\n        );\n\n        $(ACTIONS.EDIT_ACTIVITY_DEFAULTS).click(function(e) {\n            e.preventDefault();\n\n            var button = $(this);\n            var contextLevel = button.data('contextlevel');\n            var category = button.data('category');\n            var purpose = button.data('purpose');\n            var activity = button.data('activityname');\n\n            // Get options.\n            var requests = [\n                {methodname: 'tool_dataprivacy_get_category_options', args: {}},\n                {methodname: 'tool_dataprivacy_get_purpose_options', args: {}},\n                {methodname: 'tool_dataprivacy_get_activity_options', args: {}}\n            ];\n\n            var promises = Ajax.call(requests);\n            var titlePromise = Str.get_string('editmoduledefaults', 'tool_dataprivacy');\n\n            $.when(promises[0], promises[1], promises[2], titlePromise).then(\n                function(categoryResponse, purposeResponse, activityResponse, title) {\n                    var categories = categoryResponse.options;\n                    var purposes = purposeResponse.options;\n                    var activities = activityResponse.options;\n\n                    showDefaultsFormModal(title, contextLevel, category, purpose, activity, categories, purposes, activities);\n\n                    return true;\n\n                }).catch(Notification.exception);\n            }\n        );\n\n        $(ACTIONS.DELETE_ACTIVITY_DEFAULTS).click(function(e) {\n            e.preventDefault();\n\n            var button = $(this);\n            var contextLevel = button.data('contextlevel');\n            var activity = button.data('activityname');\n            var activityDisplayName = button.data('activitydisplayname');\n            // Set category and purpose to inherit (-1).\n            var category = INHERIT;\n            var purpose = INHERIT;\n\n            ModalFactory.create({\n                title: Str.get_string('deletedefaults', 'tool_dataprivacy', activityDisplayName),\n                body: Templates.render('tool_dataprivacy/delete_activity_defaults', {\"activityname\": activityDisplayName}),\n                type: ModalFactory.types.SAVE_CANCEL,\n                large: true\n            }).then(function(modal) {\n                modal.setSaveButtonText(Str.get_string('delete'));\n\n                // Handle save event.\n                modal.getRoot().on(ModalEvents.save, function() {\n                    setContextDefaults(contextLevel, category, purpose, activity, false);\n                });\n\n                // Handle hidden event.\n                modal.getRoot().on(ModalEvents.hidden, function() {\n                    // Destroy when hidden.\n                    modal.destroy();\n                });\n\n                modal.show();\n\n                return true;\n            }).catch(Notification.exception);\n        });\n    };\n\n    /**\n     * Prepares and renders the modal for setting the defaults for the given context level/plugin.\n     *\n     * @param {String} title The modal's title.\n     * @param {Number} contextLevel The context level to set defaults for.\n     * @param {Number} category The current category ID.\n     * @param {Number} purpose The current purpose ID.\n     * @param {String} activity The plugin name of the activity. Optional.\n     * @param {Array} categoryOptions The list of category options.\n     * @param {Array} purposeOptions The list of purpose options.\n     * @param {Array} activityOptions The list of activity options. Optional.\n     */\n    function showDefaultsFormModal(title, contextLevel, category, purpose, activity,\n                                   categoryOptions, purposeOptions, activityOptions) {\n\n        if (category !== null) {\n            categoryOptions.forEach(function(currentValue) {\n                if (currentValue.id === category) {\n                    currentValue.selected = true;\n                }\n            });\n        }\n\n        if (purpose !== null) {\n            purposeOptions.forEach(function(currentValue) {\n                if (currentValue.id === purpose) {\n                    currentValue.selected = true;\n                }\n            });\n        }\n\n        var templateContext = {\n            \"contextlevel\": contextLevel,\n            \"categoryoptions\": categoryOptions,\n            \"purposeoptions\": purposeOptions\n        };\n\n        // Check the activityOptions parameter that was passed.\n        if (activityOptions !== null && activityOptions.length) {\n            // Check the activity parameter that was passed.\n            if (activity === null) {\n                // We're setting a new defaults for a module.\n                templateContext.newactivitydefaults = true;\n\n            } else {\n                // Edit mode. Set selection.\n                activityOptions.forEach(function(currentValue) {\n                    if (activity === currentValue.name) {\n                        currentValue.selected = true;\n                    }\n                });\n            }\n\n            templateContext.modemodule = true;\n            templateContext.activityoptions = activityOptions;\n        }\n\n        ModalFactory.create({\n            title: title,\n            body: Templates.render('tool_dataprivacy/category_purpose_form', templateContext),\n            type: ModalFactory.types.SAVE_CANCEL,\n            large: true\n        }).then(function(modal) {\n\n            // Handle save event.\n            modal.getRoot().on(ModalEvents.save, function() {\n                var activity = $('#activity');\n                var activityVal = typeof activity !== 'undefined' ? activity.val() : null;\n                var override = $('#override');\n                var overrideVal = typeof override !== 'undefined' ? override.is(':checked') : false;\n\n                setContextDefaults($('#contextlevel').val(), $('#category').val(), $('#purpose').val(), activityVal, overrideVal);\n            });\n\n            // Handle hidden event.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                // Destroy when hidden.\n                modal.destroy();\n            });\n\n            modal.show();\n\n            return modal;\n        }).catch(Notification.exception);\n    }\n\n    /**\n     * Calls a the tool_dataprivacy_set_context_defaults WS function.\n     *\n     * @param {Number} contextLevel The context level.\n     * @param {Number} category The category ID.\n     * @param {Number} purpose The purpose ID.\n     * @param {String} activity The plugin name of the activity module.\n     * @param {Boolean} override Whether to override custom instances.\n     */\n    function setContextDefaults(contextLevel, category, purpose, activity, override) {\n        var request = {\n            methodname: 'tool_dataprivacy_set_context_defaults',\n            args: {\n                'contextlevel': contextLevel,\n                'category': category,\n                'purpose': purpose,\n                'override': override,\n                'activity': activity\n            }\n        };\n\n        Ajax.call([request])[0].done(function(data) {\n            if (data.result) {\n                window.location.reload();\n            }\n        });\n    }\n\n    return /** @alias module:tool_dataprivacy/defaultsactions */ {\n        // Public variables and functions.\n\n        /**\n         * Initialise the module.\n         *\n         * @method init\n         * @return {DefaultsActions}\n         */\n        'init': function() {\n            return new DefaultsActions();\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","ModalFactory","ModalEvents","Templates","ACTIONS","DefaultsActions","this","registerEvents","showDefaultsFormModal","title","contextLevel","category","purpose","activity","categoryOptions","purposeOptions","activityOptions","forEach","currentValue","id","selected","templateContext","contextlevel","categoryoptions","purposeoptions","length","newactivitydefaults","name","modemodule","activityoptions","create","body","render","type","types","SAVE_CANCEL","large","then","modal","getRoot","on","save","activityVal","val","override","overrideVal","is","setContextDefaults","hidden","destroy","show","catch","exception","request","methodname","args","call","done","data","result","window","location","reload","prototype","click","e","preventDefault","button","promises","titlePromise","get_string","text","when","categoryResponse","purposeResponse","categories","options","purposes","nodefaults","activityResponse","activities","activityDisplayName","activityname","setSaveButtonText","init"],"mappings":"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"}