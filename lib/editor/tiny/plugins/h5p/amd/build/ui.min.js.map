{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny H5P Content configuration.\n *\n * @module      tiny_h5p/commands\n * @copyright   2022 Andrew Lyons <andrew@nicols.co.uk>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {displayFilepicker} from 'editor_tiny/utils';\nimport {component} from './common';\nimport {getPermissions} from './options';\n\nimport Config from 'core/config';\nimport {getList} from 'core/normalise';\nimport {renderForPromise} from 'core/templates';\nimport Modal from 'tiny_h5p/modal';\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport Pending from 'core/pending';\n\nlet openingSelection = null;\n\nexport const handleAction = (editor) => {\n    openingSelection = editor.selection.getBookmark();\n    displayDialogue(editor);\n};\n\n/**\n * Get the template context for the dialogue.\n *\n * @param {Editor} editor\n * @param {object} data\n * @returns {object} data\n */\nconst getTemplateContext = (editor, data) => {\n    const permissions = getPermissions(editor);\n\n    const canUpload = permissions.upload ?? false;\n    const canEmbed = permissions.embed ?? false;\n    const canUploadAndEmbed = canUpload && canEmbed;\n\n    return Object.assign({}, {\n        elementid: editor.id,\n        canUpload,\n        canEmbed,\n        canUploadAndEmbed,\n        showOptions: false,\n        fileURL: data?.url ?? '',\n    }, data);\n};\n\n/**\n * Get the URL from the submitted form.\n *\n * @param {FormNode} form\n * @param {string} submittedUrl\n * @param {object} permissions\n * @returns {URL|null}\n */\nconst getUrlFromSubmission = (form, submittedUrl, permissions) => {\n    if (!submittedUrl || (!submittedUrl.startsWith(Config.wwwroot) && !isValidUrl(submittedUrl))) {\n        return null;\n    }\n\n    // Generate a URL Object for the submitted URL.\n    const url = new URL(submittedUrl);\n\n    if (permissions?.upload) {\n        if (form.querySelector('[name=\"download\"]').checked) {\n            url.searchParams.append('export', 1);\n        }\n    }\n\n    if (permissions?.embed) {\n        if (form.querySelector('[name=\"embed\"]').checked) {\n            url.searchParams.append('embed', 1);\n        }\n    }\n    if (form.querySelector('[name=\"copyright\"]').checked) {\n        url.searchParams.append('copyright', 1);\n    }\n\n    return url;\n};\n\n/**\n * Verify if this could be a h5p URL.\n *\n * @param {string} url Url to verify\n * @return {boolean} whether this is a valid URL.\n */\nconst isValidUrl = (url) => {\n    const pattern = new RegExp('^(https?:\\\\/\\\\/)?' + // Protocol.\n        '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|' + // Domain name.\n        '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))' + // OR ip (v4) address.\n        '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'); // Port and path.\n    return !!pattern.test(url);\n};\n\nconst handleDialogueSubmission = async(editor, modal, data) => {\n    const pendingPromise = new Pending('tiny_h5p:handleDialogueSubmission');\n\n    const form = getList(modal.getRoot())[0].querySelector('form');\n    if (!form) {\n        // The form couldn't be found, which is weird.\n        // This should not happen.\n        // Display the dialogue again.\n        modal.destroy();\n        displayDialogue(editor, Object.assign({}, data));\n        pendingPromise.resolve();\n        return;\n    }\n\n    // Get the URL from the submitted form.\n    const submittedUrl = form.querySelector('input[name=\"url\"]').value;\n    const url = getUrlFromSubmission(form, submittedUrl, getPermissions(editor));\n\n    if (!url) {\n        // The URL is invalid.\n        // Fill it in and represent the dialogue with an error.\n        modal.destroy();\n        displayDialogue(editor, Object.assign({}, data, {\n            url: submittedUrl,\n            invalidUrl: true,\n        }));\n        pendingPromise.resolve();\n        return;\n    }\n\n    const content = await renderForPromise(`${component}/content`, {\n        url: url.toString(),\n    });\n\n    editor.selection.moveToBookmark(openingSelection);\n    editor.execCommand('mceInsertContent', false, content.html);\n    editor.selection.moveToBookmark(openingSelection);\n    pendingPromise.resolve();\n};\n\nconst getCurrentH5PData = (currentH5P) => {\n    const data = {};\n    let url;\n    try {\n        url = new URL(currentH5P.textContent);\n    } catch (error) {\n        return data;\n    }\n\n    if (url.searchParams.has('export')) {\n        data.download = true;\n        data.showOptions = true;\n        url.searchParams.delete('export');\n    }\n\n    if (url.searchParams.has('embed')) {\n        data.embed = true;\n        data.showOptions = true;\n        url.searchParams.delete('embed');\n    }\n\n    if (url.searchParams.has('copyright')) {\n        data.copyright = true;\n        data.showOptions = true;\n        url.searchParams.delete('copyright');\n    }\n\n    data.url = url.toString();\n\n    return data;\n};\n\nconst displayDialogue = async(editor, data = {}) => {\n    const selection = editor.selection.getNode();\n    const currentH5P = selection.closest('.h5p-placeholder');\n    if (currentH5P) {\n        Object.assign(data, getCurrentH5PData(currentH5P));\n    }\n\n    const modal = await ModalFactory.create({\n        type: Modal.TYPE,\n        templateContext: getTemplateContext(editor, data),\n        large: true,\n    });\n    modal.show();\n\n    const $root = modal.getRoot();\n    const root = $root[0];\n    $root.on(ModalEvents.save, (event, modal) => {\n        handleDialogueSubmission(editor, modal, data);\n    });\n\n    root.addEventListener('click', (e) => {\n        const filepickerButton = e.target.closest('[data-target=\"filepicker\"]');\n        if (filepickerButton) {\n            displayFilepicker(editor, 'h5p').then((params) => {\n                if (params.url !== '') {\n                    const input = root.querySelector('form input[name=\"url\"]');\n                    input.value = params.url;\n                }\n                return params;\n            })\n                .catch();\n        }\n    });\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","_config","_modal","_modal_events","_modal_factory","_pending","openingSelection","_exports","handleAction","editor","selection","getBookmark","displayDialogue","getTemplateContext","data","_permissions$upload","_permissions$embed","_data$url","permissions","getPermissions","canUpload","upload","canEmbed","embed","canUploadAndEmbed","Object","assign","elementid","id","showOptions","fileURL","url","isValidUrl","RegExp","test","handleDialogueSubmission","async","modal","pendingPromise","Pending","form","getList","getRoot","querySelector","destroy","resolve","submittedUrl","value","getUrlFromSubmission","startsWith","Config","wwwroot","URL","checked","searchParams","append","invalidUrl","content","renderForPromise","concat","component","toString","moveToBookmark","execCommand","html","getCurrentH5PData","currentH5P","textContent","error","has","download","delete","copyright","arguments","length","undefined","getNode","closest","ModalFactory","create","type","Modal","TYPE","templateContext","large","show","$root","root","on","ModalEvents","save","event","addEventListener","e","target","displayFilepicker","then","params","catch"],"mappings":"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"}