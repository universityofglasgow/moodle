define(["jquery","core/notification","core/ajax","core/templates","core/str","theme_snap/util"],function(a,b,c,d,e,f){var g=!1,h=!1,i=!1;return a(document).ready(function(){a("#snap-pm-logout").click(function(){h=!0})}),{ifErrorShowBestMsg:function(c,j,k){var l=a.Deferred(),m=function(c){var d=a.Deferred();if(k)b.alert(M.util.get_string("error","moodle"),k,M.util.get_string("ok","moodle"));else if(c.backtrace)b.exception(c);else{var e;if(c.error)e=c.error,c.stacktrace&&(e="<div>"+e+"<pre>"+c.stacktrace+"</pre></div>");else{if(!c.errorcode||!c.message)return d.resolve(!1),d.promise();e=c.message}b.alert(M.util.get_string("error","moodle"),e,M.util.get_string("ok","moodle"))}return f.whenTrue(function(){var b=a(".moodle-dialogue-base").is(":visible");return b},function(){d.resolve(!0)},!0),d.promise()};if(g)return l.resolve(!0),l.promise();if(h)return l.resolve(!0),l.promise();if("object"!=typeof c)try{var n=JSON.parse(c);c=n}catch(o){}if("undefined"==typeof c)return!1;if(c.errorcode&&"sitepolicynotagreed"===c.errorcode){var p=M.cfg.wwwroot+"/user/policy.php";return window.location!=p&&!i&&a("#primary-nav").is(":visible")?(window.location=p,i=!0,g=!0,l.resolve(!0)):l.resolve(!1),l.promise()}if(c.error||c.errorcode){if(M.snapTheme.forcePassChange){var q=M.cfg.wwwroot+"/login/change_password.php";return a("#snap-pm-content").length&&(e.get_string("forcepwdwarningpersonalmenu","theme_snap",q).then(function(a){var b={message:a,extraclasses:"force-pwd-warning"};return d.render("core/notification_warning",b)}).then(function(b){a("#snap-pm-content").html("<br />"+b),l.resolve(!0)}),a("#snap-pm-content").is(":visible"))?(g=!0,l.promise()):(window.location!=q&&(window.location=q),g=!0,l.resolve(!0),l.promise())}return j=j?j:"",a.ajax({type:"POST",async:!0,data:{sesskey:M.cfg.sesskey,failedactionmsg:j},url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_loginstatus"}).then(function(d){return g?(l.resolve(!0),l.promise()):d.loggedin?m(c):(a("<style>.confirmation-dialogue .confirmation-buttons input:nth-of-type(2), .moodle-dialogue-base.moodle-dialogue-confirm button.yui3-button.closebutton{ display : none }</style>").appendTo("head"),b.confirm(d.loggedouttitle,d.loggedoutmsg,d.loggedoutcontinue," ",function(){window.location=M.cfg.wwwroot+"/login/index.php"}),g=!0,void 0)})}return l.resolve(!1),l.promise()}}});