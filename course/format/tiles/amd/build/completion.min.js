/**
 * Load the format_tiles JavaScript for the course edit settings page /course/edit.php?id=xxx
 *
 * @module      format_tiles/completion
 * @copyright   2018 David Watson {@link http://evolutioncode.uk}
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("format_tiles/completion",["jquery","core/templates","core/config","core/ajax","core/str","core_course/manual_completion_toggle"],(function($,Templates,config,ajax,str,coreManualCompletion){var courseId,dataKeys_numberOutOf="data-numoutof",dataKeys_section="data-section",Selector_launchModuleModal='[data-action="launch-tiles-module-modal"]',Selector_launchResourceModal='[data-action="launch-tiles-resource-modal"]',Selector_activity="li.activity",Selector_section="li.section.main",Selector_togglecompletion='[data-action="toggle-manual-completion"]',Selector_tileId="#tile-",Selector_progressIndicatorId="#tileprogress-",Selector_tile=".tile",Selector_spacer=".spacer",Selector_availabilityinfo=".availabilityinfo",isBlurred=!1,progressTemplateData=function(tileId,numComplete,outOf,asPercent){var data={tileid:tileId,numComplete:numComplete,numOutOf:outOf,showAsPercent:asPercent,percent:outOf>0?Math.round(numComplete/outOf*100):0,percentCircumf:106.8,percentOffset:outOf>0?Math.round((outOf-numComplete)/outOf*106.8):0,isComplete:!1,isSingleDigit:!1,hastilephoto:$(Selector_tileId+tileId).hasClass("phototile")};return data.isOverall=0===tileId?1:0,outOf>0&&numComplete>=outOf&&(data.isComplete=!0),data.percent<10&&(data.isSingleDigit=!0),data},_triggerCompletionChangedEvent=function(sectionNum,cmid){$(document).trigger("format-tiles-completion-changed",{section:sectionNum,cmid:cmid})},_updateSectionsInfo=function(sections,overallcomplete,overalloutof){sections.forEach((function(sec){var tile=$(Selector_tileId+sec.sectionnum);sec.isavailable&&tile.hasClass("tile-restricted")?tile.removeClass("tile-restricted"):sec.isavailable||tile.addClass("tile-restricted"),sec.isclickable&&!tile.hasClass("tile-clickable")?tile.addClass("tile-clickable"):!sec.isclickable&&tile.hasClass("tile-clickable")&&tile.removeClass("tile-clickable"),sec.iscomplete?tile.addClass("is-complete"):tile.removeClass("is-complete");var sectionNum,tileProgressIndicator,newTileProgressValue,newValue,outOf,progressIndicator=$(Selector_progressIndicatorId+sec.sectionnum);sectionNum=sec.sectionnum,tileProgressIndicator=progressIndicator,(newTileProgressValue=sec.numcomplete)<0||newTileProgressValue>tileProgressIndicator.attr(dataKeys_numberOutOf)||sectionNum&&Templates.render("format_tiles/progress",progressTemplateData(sectionNum,newTileProgressValue,parseInt(tileProgressIndicator.attr(dataKeys_numberOutOf)),tileProgressIndicator.hasClass("percent"))).done((function(html){tileProgressIndicator.replaceWith(html)})),newValue=overallcomplete,outOf=overalloutof,Templates.render("format_tiles/progress",progressTemplateData(0,newValue,outOf,!0)).done((function(html){$("#tileprogress-0").replaceWith(html).fadeOut(0).animate({opacity:1},500)}));var availabilityInfoDiv=tile.find(Selector_availabilityinfo);availabilityInfoDiv.length>0&&sec.isavailable&&!sec.availabilitymessage?availabilityInfoDiv.fadeOut():!sec.isavailable&&sec.availabilitymessage&&(availabilityInfoDiv.length>0?(availabilityInfoDiv.html="NEW"+sec.availabilitymessage,availabilityInfoDiv.fadeIn()):Templates.render("format_tiles/availability_info",{availabilitymessage:sec.availabilitymessage,visible:!0}).done((function(html){progressIndicator.replaceWith(html)})))}))};return{init:function(courseIdInit){courseId=courseIdInit,$(document).ready((function(){var loadingString="...";str.get_strings([{key:"loading",component:"format_tiles"}]).done((function(s){loadingString=s[0]+"  ..."})),$("body").on("click",Selector_togglecompletion,(function(e){var currentTarget=$(e.currentTarget);currentTarget.closest(".section").hasClass("subtiles")&&currentTarget.replaceWith('<div class="spinner-grow spinner-grow-sm text-secondary mt-2 mr-2 pull-right" role="status"><span class="sr-only">'+loadingString+"</span></div>")}));var pageContent=$("#page-content");0===pageContent.length&&(pageContent=$("#region-main")),pageContent.on("click",Selector_launchModuleModal+", "+Selector_launchResourceModal,(function(e){var clickedActivity=$(e.currentTarget).closest(Selector_activity);if(clickedActivity.hasClass("completeonview")){var sectionNum=clickedActivity.closest(Selector_section).attr(dataKeys_section),cmid=clickedActivity.attr("data-cmid");_triggerCompletionChangedEvent(sectionNum?parseInt(sectionNum):0,cmid?parseInt(cmid):0)}})),$(window).on("focus",(function(){if(isBlurred){var openSection=$("li.section.state-visible").attr("data-section");isBlurred=!1,_triggerCompletionChangedEvent(openSection?parseInt(openSection):0,0)}})),$(window).on("blur",(function(){isBlurred=!0})),coreManualCompletion.init()}))},triggerCompletionChangedEvent:function(sectionNum,cmid){_triggerCompletionChangedEvent(sectionNum,cmid)},updateTileInformation:function(sectionNumbers){try{void 0===(sectionNums=sectionNumbers)&&(sectionNums=$(Selector_tile).not(Selector_spacer).map((function(i,t){return parseInt($(t).attr(dataKeys_section))})).toArray()),ajax.call([{methodname:"format_tiles_get_section_information",args:{courseid:courseId,sectionnums:sectionNums}}])[0].done((function(res){_updateSectionsInfo(res.sections,res.overall.complete,res.overall.outof)})).fail((function(err){require(["core/log"],(function(log){log.debug("Failed to get section information to check completion status of section"),log.debug(err)}))}))}catch(err){require(["core/log"],(function(log){log.debug(err)}))}var sectionNums},updateSectionsInfo:function(sections,overallcomplete,overalloutof){_updateSectionsInfo(sections,overallcomplete,overalloutof)}}}));

//# sourceMappingURL=completion.min.js.map