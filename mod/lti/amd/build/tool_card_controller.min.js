define(["jquery","core/ajax","core/notification","core/templates","mod_lti/tool_type","mod_lti/events","mod_lti/keys"],function(a,b,c,d,e,f,g){var h={DELETE_BUTTON:".delete",NAME_ELEMENT:".name",DESCRIPTION_ELEMENT:".description",CAPABILITIES_CONTAINER:".capabilities-container",ACTIVATE_BUTTON:".tool-card-footer a.activate"},i=2e3,j=function(a){return a.find(h.DELETE_BUTTON)},k=function(a){return a.find(h.NAME_ELEMENT)},l=function(a){return a.find(h.DESCRIPTION_ELEMENT)},m=function(a){return a.find(h.ACTIVATE_BUTTON)},n=function(a){return m(a).length?!0:!1},o=function(a){return a.find(h.CAPABILITIES_CONTAINER)},p=function(a){return o(a).length?!0:!1},q=function(a){return a.attr("data-type-id")},r=function(a){a.removeClass("announcement loading success fail capabilities")},s=function(a){r(a),a.addClass("announcement loading")},t=function(a){a.removeClass("announcement loading")},u=function(b){var c=a.Deferred();return r(b),b.addClass("announcement success"),setTimeout(function(){b.removeClass("announcement success"),c.resolve()},i),c},v=function(b){var c=a.Deferred();return r(b),b.addClass("announcement fail"),setTimeout(function(){b.removeClass("announcement fail"),c.resolve()},i),c},w=function(b){var d=q(b);if(""===d)return a.Deferred().resolve();s(b);var f=e["delete"](d);return f.done(function(){t(b),u(b).done(function(){b.remove()}).fail(c.exception)}),f.fail(function(){v(b)}),f},x=function(a,b){a.attr("data-val-snapshot",b)},y=function(a){return a.attr("data-val-snapshot")},z=function(a){var b=l(a);if(!b.hasClass("loading")){var c=b.text().trim();x(b,c)}},A=function(b){var d=q(b);if(""===d)return a.Deferred().resolve();var f=l(b);if(f.hasClass("loading"))return a.Deferred().resolve();var g=f.text().trim(),h=y(f);if(h==g)return a.Deferred().resolve();f.addClass("loading");var i=e.update({id:d,description:g});return i.done(function(a){f.removeClass("loading"),f.text(a.description)}).fail(c.exception),i.fail(function(){f.removeClass("loading")}),i},B=function(a){var b=k(a);if(!b.hasClass("loading")){var c=b.text().trim();x(b,c)}},C=function(b){var c=q(b);if(""===c)return a.Deferred().resolve();var d=k(b);if(d.hasClass("loading"))return a.Deferred().resolve();var f=d.text().trim(),g=y(d);if(g==f)return a.Deferred().resolve();d.addClass("loading");var h=e.update({id:c,name:f});return h.done(function(a){d.removeClass("loading"),d.text(a.name)}),h.fail(function(){d.removeClass("loading")}),h},D=function(b){var c=q(b);if(""===c)return a.Deferred().resolve();s(b);var f=e.update({id:c,state:e.constants.state.configured});return f.done(function(c){t(b);var e=u(b),f=d.render("mod_lti/tool_card",c);a.when(f,e).then(function(a){var c=a[0],e=a[1];d.replaceNode(b,c,e)})}),f.fail(function(){t(b),v(b)}),f},E=function(a){a.addClass("announcement capabilities")},F=function(a){a.removeClass("announcement capabilities")},G=function(a){p(a)?E(a):D(a)},H=function(a){var b=j(a);b.click(function(b){b.preventDefault(),w(a)}),b.keypress(function(a){a.metaKey||a.shiftKey||a.altKey||a.ctrlKey||(a.keyCode==g.ENTER||a.keyCode==g.SPACE)&&(a.preventDefault(),b.click())});var c=l(a);c.focus(function(b){b.preventDefault(),z(a)}),c.blur(function(b){b.preventDefault(),A(a)}),c.keypress(function(a){a.metaKey||a.shiftKey||a.altKey||a.ctrlKey||a.keyCode==g.ENTER&&(a.preventDefault(),c.blur())});var d=k(a);if(d.focus(function(b){b.preventDefault(),B(a)}),d.blur(function(b){b.preventDefault(),C(a)}),d.keypress(function(a){a.metaKey||a.shiftKey||a.altKey||a.ctrlKey||a.keyCode==g.ENTER&&(a.preventDefault(),d.blur())}),n(a)){var e=m(a);e.click(function(b){b.preventDefault(),G(a)}),e.keypress(function(a){a.metaKey||a.shiftKey||a.altKey||a.ctrlKey||(a.keyCode==g.ENTER||a.keyCode==g.SPACE)&&(a.preventDefault(),e.click())})}if(p(a)){var h=o(a);h.on(f.CAPABILITIES_AGREE,function(){D(a)}),h.on(f.CAPABILITIES_DECLINE,function(){F(a)})}};return{init:function(a){H(a)}}});