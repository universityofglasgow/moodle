# Introduction and Goals



## Requirements Overview 

This describes the requirements for the staff-facing side of the new GCAT development.

## General description

The code is organised as a conventional Moodle 'local' plugin. The facilities in lib.php are used to tie the plugin into the Moodle navigation. It appears in the 'More..' tab/menu of each Moodle course. This link maps to the index.php file which is located in the ui/dist folder (more about this later) with a single parameter - the course id. 

The user interface is coded in ['Vue.js'](https://vuejs.org/), in particular it utlises the [Vue CLI](https://cli.vuejs.org/) 'Vue standard tooling'.  See the [vue.md](vue.md) file for more details. 

The index.php file is quite simple. It contains the usual Moodle boilerplate - header, footer, login and capability checks, and so on. It loads a number of javascript libraries - these consist of both a Moodle AMD module defined in the plugin and the javascript generated by the Vue tooling. The actual page content contains only a div which will be controlled by Vue. 

As Vue runs entirely client-side, its interaction with Moodle is via web services. Normal Moodle web service calls are used. Each custom web service is given its own class in 'classes/external'. Most of the non-UI processing originates with these web services. 

The classes/ directory also contains a number of classes that contain static shared functions. These functions should be comprehensively commented. 

# Organisation of code

* The plugin is written as a Moodle "local plugin". See https://moodledev.io/docs/apis/plugintypes/local
* The basic organisation is to code the user interface in Javascript and the "business logic" in PHP.
* The user interface is primarily developed using the [Vue CLI](https://cli.vuejs.org/) javascript library and tooling
* The user interface access the backend using web services. This leverages Moodle's standard web service library. See https://moodledev.io/docs/apis/subsystems/external
* Some 'glue logic' is coded as a Moodle AMD module to allow the Vue code to access Moodle's javascript modules (e.g. strings, ajax, notifications). 

## Interfaces

In general, the plugin will access existing Moodle APIs and database tables. Some of these are as follows...

* The Gradebook tables and API are used to access a number of items:
    * Gradeable items (e.g. grades activities, manual grades)
    * Gradebook structure (grade category tree structure and containing grade items)
    * Grade category settings (aggregation schema)
    * Grade item settings (hidden, overridden and so on)
* The Moodle course module API to discover details about individual activities
* Moodle Assignment database tables / API. Assignment is a special case in that it we need to support hidden grading, workflow status and the activity manipulating its own grades. 
* Data will be uploaded through the UI both manually and by CSV upload
* The plugin has its own data structures and these will either be directly accessible and/or through an API (TBD) for student dashboard and/or reporting. 

### Linking to moodle

The plugin uses Moodle standard navigation APIs to add the link to 'UofG Grades' into each course's "More..." menu.

# Detailed code layout

## "Backend" implementation

The backend / business logic is written as PHP classes and is primarily exposed through normal Moodle external APIs (web services). These are supported by utility classes for commonly/repeatedly used functions. 

The current web service functions are as follows:

| API Function         | Description
|----------------------|---------------------------------------------------------------------------- |
| get_activities       | Given the course id a tree-structured list of activities (organised by grade category structure) is returned. This is primarily used to structure selection UI to select current, active grade item. |
| get_capture_page     | Given the ID of the selected activity this returns all the data needed to display the current table of the grade capture page. This includes all the students who can access the selected activity. |
| get_grade_item       | Returns full details of the selected grad item. 
| get_levelonecategories | Lists the top level grade categories for the initial selection (e.g. Summative / Formative)


## User interface

The user interface is written entirely in Vue.js.  This is effectively allows new HTML elements to be created as what Vue calls "components". These contain all logic and presentation to render that element. 
Properties and events are fully supported.

This implies a hierarchy of functionality. The components leverage Moodle ajax calls to interact with the backend. 

The current Components are as follows:

| Component            | Description
|----------------------|--------------------------------------------------------------|
| [App](../ui/src/App.vue) | Top level of UI. Called from the plugin's index.php |
| [CaptureAggregation](../ui/src/views/CaptureAggregation.vue) | Container for the capture and aggregation screens |
| [TabsNav](../ui/src/components/TabsNav.vue) | Shows tabs to select Grade capture, Aggregation and Settings |
| [LevelOneSelect](../ui/src/components/LevelOneSelect.vue) | Shows a drop down to select the top level grade category (Note that if there are none an error is displayed) |
| [ActivityTree](../ui/src/components/ActivityTree.vue) | Constructs a tree structure of grade categories and grade-items. User selects current item. View changes to the selected item until clicked again |
| [CaptureTable](../ui/src/components/CaptureTable.vue) | Paginated table of users and grades during capture |
| [NameFilter](../ui/src/components/NameFilter.vue) | Replicates Moodle's standard initial letter name filter in Vue |
| [InitialBar](../ui/src/components/InitialBar.vue) | Used by NameFilter - shows one line of letters |
| [PagingBar](../ui/src/components/PagingBar.vue) | Allows page to be selected when sufficient students to paginate table |
