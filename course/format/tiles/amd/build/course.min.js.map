{"version":3,"file":"course.min.js","sources":["../src/course.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/* eslint space-before-function-paren: 0 */\n\n/**\n * Main Javascript module for format_tiles for when user is *NOT* editing.\n * See course_edit for if they are editing.\n * Handles the UI changes when tiles are selected and anything else not\n * covered by the specific modules\n *\n * @module      format_tiles/course\n * @copyright   2018 David Watson {@link http://evolutioncode.uk}\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\"jquery\", \"core/templates\", \"core/ajax\", \"format_tiles/browser_storage\",\n        \"core/notification\", \"core/str\", \"format_tiles/tile_fitter\"],\n    function ($, Templates, ajax, browserStorage, Notification, str, tileFitter) {\n        \"use strict\";\n\n        var isMobile;\n        var loadingIconHtml;\n        var stringStore = [];\n        var scrollFuncLock = false;\n        var sectionIsOpen = false;\n        var HEADER_BAR_HEIGHT = 60; // This varies by theme and version so will be reset once pages loads below.\n        var reopenLastVisitedSection = false;\n        var courseId;\n        var resizeLocked = false;\n        var enableCompletion;\n\n         // Keep a record of which tile is currently open.\n        var openTile = 0;\n\n        var Selector = {\n            BODY: \"body\",\n            PAGE: \"#page\",\n            TILE: \".tile\",\n            TILEID: \"#tile-\",\n            MOVEABLE_SECTION: \".moveablesection\",\n            FILTER_BUTTON: \".filterbutton\",\n            TILE_LOADING_ICON: \".tile-loading-icon\",\n            TILE_LOADING_ICON_ID: \"#loading-icon-\",\n            TILE_COLLAPSED: \".tile-collapsed\",\n            TILE_CLICKABLE: \".tile-clickable\",\n            TILES: \"ul.tiles\",\n            ACTIVITY: \".activity\",\n            ACTIVITY_NAME: \".activityname\",\n            INSTANCE_NAME: \".instancename\",\n            SPACER: \".spacer\",\n            SECTION_MOVEABLE: \".moveablesection\",\n            SECTION_ID: \"#section-\",\n            SECTION_TITLE: \".sectiontitle\",\n            SECTION_MAIN: \".section.main\",\n            SECTION_BUTTONS: \".sectionbuttons\",\n            CLOSE_SEC_BTN: \".closesectionbtn\",\n            HIDE_SEC0_BTN: \"#buttonhidesec0\",\n            SECTION_ZERO: \"#section-0\",\n            MOODLE_VIDEO: \".mediaplugin.mediaplugin_videojs\",\n            LAUNCH_STANDARD: '[data-action=\"launch-tiles-standard\"]',\n            MANUAL_COMPLETION: '[data-action=\"toggle-manual-completion\"]',\n            TOOLTIP: \"[data-toggle=tooltip]\",\n            MATHJAX_EQUATION: \".filter_mathjaxloader_equation\"\n        };\n        var ClassNames = {\n            SELECTED: \"selected\",\n            OPEN: \"open\",\n            CLOSED: \"closed\",\n            LAUNCH_CM_MODAL: \"launch-tiles-cm-modal\",\n            STATE_VISIBLE: 'state-visible', // This is a Snap theme class. Was added to make this format cooperate better with it.\n            HAS_OPEN_TILE: 'format-tiles-tile-open'\n        };\n\n        var Event = {\n            CLICK: \"click\",\n            KEYDOWN: \"keydown\",\n            SCROLL: \"scroll\"\n        };\n\n        var CSS = {\n            DISPLAY: \"display\",\n            Z_INDEX: \"z-index\",\n            HEIGHT: \"height\",\n            BG_COLOUR: \"background-color\"\n        };\n        var Keyboard = {\n            ESCAPE: 27,\n            TAB: 9,\n            RETURN: 13\n        };\n\n        const OVERLAY_ID = 'format_tiles_overlay';\n\n        /**\n         * If we have embedded video in section, stop it.\n         * Runs when section is closed.\n         * @param {number} section where the video is.\n         */\n        var stopVideoPlaying = function(section) {\n            var contentSection = $(Selector.SECTION_ID + section);\n\n            // First iframes (e.g. embedded YouTube).\n            contentSection.find(\"iframe\").each(function (index, iframe) {\n                iframe = $(iframe);\n                // Remove the src from the iframe but keep it in case the section is re-opened.\n                if (iframe.attr('src')) {\n                    iframe.attr('data-src', iframe.attr(\"src\"));\n                    iframe.attr('src', \"\");\n                }\n            });\n\n            // Then Moodle media player.\n            var mediaPlayers = contentSection.find(Selector.MOODLE_VIDEO);\n            if (mediaPlayers.length > 0) {\n                contentSection.html(\"\");\n            }\n        };\n\n        /**\n         * When JS navigation is being used, when a user un-selects a tile, we have to un-fade other tiles\n         * @param {number} sectionToFocus if we want to focus a tile after closing, which one\n         */\n        var cancelTileSelections = function (sectionToFocus) {\n            $(Selector.MOVEABLE_SECTION).each(function (index, sec) {\n                sec = $(sec);\n                if (sec.is(\":visible\")) {\n                    stopVideoPlaying(sec.attr(\"data-section\"));\n                    sec.slideUp().removeClass(ClassNames.STATE_VISIBLE); // Excludes section 0.\n                }\n            });\n            $(Selector.TILE).removeClass(ClassNames.SELECTED).css(CSS.Z_INDEX, \"\").css(CSS.BG_COLOUR, \"\");\n            $(\".section \" + ClassNames.SELECTED).removeClass(ClassNames.SELECTED).css(CSS.Z_INDEX, \"\");\n\n            if (sectionToFocus !== undefined && sectionToFocus !== 0) {\n                $(Selector.TILEID + sectionToFocus).focus();\n            }\n            $(Selector.TILE_LOADING_ICON).fadeOut(300, function () {\n                $(Selector.TILE_LOADING_ICON).html(\"\");\n            });\n            sectionIsOpen = false;\n            openTile = 0;\n            $(Selector.BODY).removeClass(ClassNames.HAS_OPEN_TILE);\n            overlay.fadeOut(300);\n        };\n\n        const overlay = $('#' + OVERLAY_ID);\n\n        /**\n         * Used where the user clicks the window overlay but we want the active click to be behind the\n         * overlay e.g. the tile or custom menu item behind it.  So we get the co-ordinates of the click\n         * on the overlay and then repeat the click at that spot ignoring the overlay\n         * @param {object} e the click event object\n         */\n        var clickItemBehind = function (e) {\n            var clickedItem = $(e.currentTarget);\n            if (clickedItem.attr(\"id\") === OVERLAY_ID) {\n                // We need to know what is behind the modal, so hide it for an instant to find out.\n                clickedItem.hide();\n                var BottomElement = $(document.elementFromPoint(e.clientX, e.clientY));\n                clickedItem.show();\n                if (BottomElement.hasClass(\"filterbutton\") || BottomElement.hasClass(\"list-group-item\")) {\n                    // Must ba a filter button clicked or a nav drawer item.\n                    BottomElement.click();\n                } else {\n                    // Must be a tile clicked.\n                    var clickedTile = BottomElement.closest(Selector.TILE);\n                    if (clickedTile) {\n                        clickedTile.click();\n                    }\n                }\n            }\n        };\n\n        /**\n         * Set the HTML for a course section to the correct div in the page\n         * @param {Object} contentArea the jquery object for the content area\n         * @param {String} content the HTML\n         * @param {String} js Any additional JS for the new HTML.\n         * @returns {boolean} success\n         */\n        var setCourseContentHTML = function (contentArea, content, js) {\n            if (content) {\n                contentArea.html(content);\n                $(Selector.TILE_LOADING_ICON).fadeOut(300, function () {\n                    $(Selector.TILE_LOADING_ICON).html(\"\");\n                });\n\n                if (contentArea.attr(\"id\") !== Selector.SECTION_ZERO) {\n                    // Trap the tab key navigation in the content bearing section.\n                    // Until the user clicks the close button.\n                    // When user reaches last item, send them back to first.\n                    // And vice versa if going backwards.\n\n                    var activities = contentArea.find(Selector.ACTIVITY).not(Selector.SPACER);\n                    contentArea.on(Event.KEYDOWN, function (e) {\n                        if (e.keyCode === Keyboard.ESCAPE) {\n                            // Close open tile, and return focus to closed tile, for screen reader user.\n                            browserStorage.setLastVisitedSection(0);\n                            cancelTileSelections(0);\n                            $(Selector.TILEID + contentArea.attr('data-section')).focus();\n                        }\n                    });\n                    activities.on(Event.KEYDOWN, function (e) {\n                        if (e.keyCode === Keyboard.RETURN) {\n                            var toClick = $(e.currentTarget).find(\"a\");\n                            if (toClick.hasClass(ClassNames.LAUNCH_CM_MODAL)) {\n                                toClick.click();\n                            } else if (toClick.attr(\"href\") !== undefined) {\n                                window.location = toClick.attr(\"href\");\n                            }\n                        }\n                    });\n                    if (!isMobile) {\n                        activities.last().on(Event.KEYDOWN, function (e) {\n                            if (e.keyCode === Keyboard.TAB && !e.shiftKey\n                                    && $(e.relatedTarget).closest(Selector.SECTION_MAIN).attr(\"id\") !== contentArea.attr(\"id\")) {\n                                // RelatedTarget is the item we tabbed to.\n                                // If we reached here, the item we are on is not a member of the section we were in.\n                                // (I.e. we are trying to tab out of the bottom of section) so move tab back to first item instead.\n                                setTimeout(function () {\n                                    // Allow very short delay so we dont skip forward on the basis of our last key press.\n                                    contentArea.find(Selector.SECTION_TITLE).focus();\n                                    contentArea.find(Selector.SECTION_BUTTONS).css(\"top\", \"\");\n                                }, 200);\n                            }\n                        });\n                        contentArea.find(Selector.SECTION_TITLE).on(Event.KEYDOWN, function (e) {\n                            if (e.keyCode === Keyboard.TAB && e.shiftKey\n                                    && $(e.relatedTarget).closest(Selector.SECTION_MAIN).attr(\"id\") !== contentArea.attr(\"id\")) {\n                                // See explanation previous block.\n                                // Here we are trying to tab backwards out of the top of our section.\n                                // So take us to last item instead.\n                                setTimeout(function () {\n                                    activities.last().focus();\n                                }, 200);\n                            }\n                        });\n                    }\n                }\n\n                if (!isMobile) {\n                    // Activate tooltips for completion toggle and any \"restricted\" items in this content.\n                    setTimeout(function () {\n                        // Manual forms, auto icons and \"Restricted until ...\" etc.\n                        try {\n                            const tooltipItems = contentArea.find(\".badge-info\");\n                            if (tooltipItems.length > 0 && typeof tooltipItems.tooltip == 'function') {\n                                tooltipItems.tooltip();\n                            }\n                        } catch (err) {\n                            require([\"core/log\"], function(log) {\n                                log.debug(err);\n                            });\n                        }\n                    }, 500);\n                }\n                // As we have just loaded new content, ensure that we initialise videoJS media player if required.\n                if (contentArea.find(Selector.MOODLE_VIDEO).length !== 0) {\n                    require([\"media_videojs/loader\"], function(videoJS) {\n                        videoJS.setUp();\n                    });\n                }\n\n                // Some modules e.g. mod_unilabel need JS initialising when added to the page.\n                if (js && js.length) {\n                    contentArea.append(js);\n                }\n\n                setTimeout(() => {\n                    // If subtile title is long, it overlaps background image.\n                    // Check heights to see if any subtile backgrounds need dimming.\n                    // Allow short delay for content to be added first.\n                    const MAX_HEIGHT = 110;\n                    contentArea.find(\n                        Selector.ACTIVITY_NAME).each((i, el) => {\n                        el = $(el);\n                        if (el.height() > MAX_HEIGHT) {\n                            el.closest(Selector.INSTANCE_NAME).addClass('opaque-bg');\n                        }\n                    });\n                }, 100);\n\n                applyMathJax(contentArea);\n                return true;\n            }\n            return false;\n        };\n\n        /**\n         * Find Mathjax equations in a content area and queue them for processing.\n         * @param {Object} contentArea the jquery object for the content area\n         */\n        const applyMathJax = function(contentArea) {\n            if (typeof window.MathJax !== \"undefined\") {\n                try {\n                    const mathJaxElems = contentArea.find(Selector.MATHJAX_EQUATION);\n                    if (mathJaxElems.length) {\n                        mathJaxElems.each((i, node) => {\n                            window.MathJax.Hub.Queue([\"Typeset\", window.MathJax.Hub, node]);\n                        });\n                    }\n                } catch (err) {\n                    require([\"core/log\"], function(log) {\n                        log.debug(err);\n                    });\n                }\n            }\n        };\n\n        /**\n         * Expand a content containing section (e.g. on tile click)\n         * @param {object} contentArea\n         * @param {number} tileId to expand\n         */\n        var expandSection = function (contentArea, tileId) {\n            const tile = $(\"#tile-\" + tileId);\n            var expandAndScroll = function () {\n                // Scroll to the top of content bearing section\n                // we have to wait until possible reOrg and slide down totally before calling this, else co-ords are wrong.\n                var scrollTo = (tile.offset().top) - $(Selector.TILES).offset().top + HEADER_BAR_HEIGHT;\n                if (scrollTo === $(window).scrollTop) {\n                    // Scroll by at least one pixel otherwise z-index on selected tile is not changed.\n                    // Until mouse moves.\n                    scrollTo += 1;\n                }\n                contentArea.find(Selector.SECTION_TITLE).focus();\n                // If user tries to scroll during animation, stop animation.\n                var events = \"mousedown wheel DOMMouseScroll mousewheel keyup touchmove\";\n                const page = $(Selector.PAGE);\n                page.on(events, function () {\n                    page.stop();\n                });\n\n                page.animate({scrollTop: scrollTo}, \"slow\", \"swing\", function () {\n                    // Animation complete, remove stop handler.\n                    page.off(events, function () {\n                        page.stop();\n                    });\n                });\n                sectionIsOpen = true;\n                openTile = tileId;\n\n                // For users with screen readers, move focus to the first item within the tile.\n                contentArea.find(Selector.ACTIVITY).first().focus();\n\n                // If we have any iframes in the section which were previous emptied out, re-populate.\n                // This will happen if we have previously closed a section with videos in, and they were muted.\n                const iframes = contentArea.find(\"iframe\");\n                if (iframes.length > 0) {\n                    iframes.each(function (index, iframe) {\n                        iframe = $(iframe);\n                        // If iframe has no src, add it from data-src.\n                        if (iframe.attr('src') === '' && iframe.attr('data-src') !== undefined) {\n                            iframe.attr('src', iframe.attr(\"data-src\"));\n                        }\n                    });\n\n                    if (enableCompletion) {\n                        // Some iframes may load content set to mark as complete on view.\n                        // So maybe need to update tile completion info. E.g. applies with H5P filter.\n                        setTimeout(() => {\n                            $(document).trigger('format-tiles-completion-changed', {\n                                section: tileId\n                            });\n                        }, 1000);\n                    }\n                }\n            };\n\n            /**\n             * Make sure that the section close and edit buttons always appear at the top of the section on scroll\n             */\n            var holdSectionButtonPosition = function () {\n                var buttons = contentArea.find(Selector.SECTION_BUTTONS);\n                $(window).on(Event.SCROLL, function () {\n                    if (!scrollFuncLock && sectionIsOpen) {\n                        scrollFuncLock = true;\n                        buttons.fadeOut(300);\n                        setTimeout(function () {\n                            var windowTop = $(window).scrollTop();\n                            var desiredNewPositionInSection = (windowTop - contentArea.offset().top + 50);\n                            if (desiredNewPositionInSection > 0\n                                    && desiredNewPositionInSection < contentArea.outerHeight() - 100) {\n                                desiredNewPositionInSection = (windowTop - contentArea.offset().top + 50);\n                                buttons.css(\"top\", desiredNewPositionInSection);\n                            } else if (desiredNewPositionInSection < 0) {\n                                buttons.css(\"top\", 0);\n                            }\n                            if (windowTop > contentArea.offset().top + contentArea.outerHeight() - 50) {\n                                // We have scrolled down and content bottom has gone out of the top of window.\n                                buttons.css(\"top\", 0);\n                            } else if (contentArea.offset().top > windowTop + $(window).outerHeight()) {\n                                // We have scrolled up and  content bottom has gone out of the bottom of window.\n                                buttons.css(\"top\", 0);\n                            }\n                            buttons.fadeIn(300, function () {\n                                // Release lock on this function.\n                                scrollFuncLock = false;\n                            });\n                        }, 500);\n                    }\n                });\n            };\n\n            contentArea.addClass(ClassNames.STATE_VISIBLE);\n            overlay.fadeIn(300);\n            tile.addClass(ClassNames.SELECTED);\n            $(Selector.BODY).addClass(ClassNames.HAS_OPEN_TILE);\n            contentArea.slideDown(350, function () {\n                // Wait until we have finished sliding down before we work out where the top is for scroll.\n                expandAndScroll();\n                holdSectionButtonPosition();\n            });\n            openTile = tileId;\n        };\n\n        /**\n         * We find out what section is open, collapse them all, then run the re-org.\n         * Finally we re-open the section.\n         * This is to ensure that the content bearing section is on the row under the tile clicked.\n         * It is run at page load and again if window is re-sized etc.\n         * @param {boolean} delayBefore do we want a delay before we re-org.  This allows e.g. browser resizing to complete.\n         * @param {boolean} fitTilesToScreenWidth whether we need to resize the tiles window while tiles are closed.\n         * @returns {Promise}\n         */\n        var reOrgSections = function (delayBefore, fitTilesToScreenWidth) {\n            var dfd = new $.Deferred();\n            var openedSection = $(\".moveablesection:visible\");\n            var openedSectionNum = 0;\n            if (openedSection.length > 0) {\n                openedSectionNum = openedSection.attr(\"data-section\");\n                cancelTileSelections(0);\n            }\n            var reOrgFunc = function(delayBefore) {\n                tileFitter.runReOrg(delayBefore)\n                    .done(function(result) {\n                        if (openedSectionNum !== 0) {\n                            expandSection(openedSection, openedSectionNum);\n                        }\n                        dfd.resolve(result);\n                    })\n                    .fail(function(result) {\n                        if (openedSectionNum !== 0) {\n                            expandSection(openedSection, openedSectionNum);\n                        }\n                        dfd.reject(result);\n                    });\n            };\n\n            if (fitTilesToScreenWidth) {\n                setTimeout(function() {\n                    tileFitter.resizeTilesDivWidth(courseId).done(function() {\n                        reOrgFunc(false);\n                    }, delayBefore);\n                });\n\n            } else {\n                reOrgFunc(delayBefore);\n            }\n            return dfd.promise();\n        };\n\n        var failedLoadSectionNotify = function(sectionNum, failResult, contentArea) {\n            if (failResult) {\n                // Notify the user and invite them to refresh.  We did get a \"failResult\" from server,\n                // So it looks like we do have a connection and can launch this.\n                Notification.confirm(\n                    stringStore.sectionerrortitle,\n                    stringStore.sectionerrorstring,\n                    stringStore.refresh,\n                    stringStore.cancel,\n                    function () {\n                        window.location.reload();\n                    },\n                    null\n                );\n                contentArea.html(\"\"); // Clear loading icon.\n            } else {\n                // It looks like we may not have a connection so we can't launch notifications.\n                // We can warn the user like this instead.\n                setCourseContentHTML(contentArea, \"<p>\" + stringStore.noconnectionerror + \"</p>\", '');\n                setTimeout(function () {\n                    expandSection(contentArea, sectionNum);\n                }, 500);\n            }\n            require([\"core/log\"], function(log) {\n                log.debug(failResult);\n            });\n            throw new Error(\"Not successful retrieving tile content by AJAX for section \" + sectionNum);\n        };\n\n        /**\n         * For a given section, get the content from the server, add it to the store and maybe UI and maybe show it\n         * @param {number} courseId the id for the affected course\n         * @param {number} sectionNum the section number we are wanting to populate\n         * @return {Promise} promise to resolve when the ajax call returns.\n         */\n        var getSectionContentFromServer = function (courseId, sectionNum) {\n            return ajax.call([{\n                methodname: \"format_tiles_get_single_section_page_html\",\n                args: {\n                    courseid: courseId,\n                    sectionid: sectionNum,\n                    setjsusedsession: true\n                }\n            }])[0];\n        };\n\n        /**\n         * If the user had section zero collapsed in this course previously, collapse it now\n         */\n        var setSectionZeroFromUserPref = function () {\n            var buttonHideSecZero = $(Selector.HIDE_SEC0_BTN);\n            var sectionZero = $(Selector.SECTION_ZERO);\n            if (browserStorage.storageEnabledLocal()) {\n                // Collapse section zero if user had it collapsed before - relies on local storage so only if enabled.\n                if (browserStorage.getSecZeroCollapseStatus() === true) {\n                    sectionZero.slideUp(0);\n                    buttonHideSecZero.addClass(ClassNames.CLOSED).removeClass(ClassNames.OPEN); // Button image.\n                } else {\n                    sectionZero.slideDown(300);\n                    buttonHideSecZero.addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED); // Button image.\n                }\n            } else {\n                // Storage not available so we dont know if sec zero was previously collapsed - expand it.\n                buttonHideSecZero.addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED);\n                sectionZero.slideDown(300);\n            }\n        };\n\n        /**\n         * To be called when a tile is clicked. Get content from server or storage and display or store it.\n         * @param {number} courseId courseId the id of this course.\n         * @param {object} thisTile jquery the tile object clicked.\n         * @param {number} dataSection the id number of the tile.\n         */\n        var populateAndExpandSection = function(courseId, thisTile, dataSection) {\n            $(Selector.TILE).removeClass(ClassNames.SELECTED);\n            openTile = dataSection;\n            // Then close all open secs.\n            // Timed to finish in 200 so that it completes well before the opening next.\n            $(Selector.MOVEABLE_SECTION).each(function (index, sec) {\n                sec = $(sec);\n                if (sec.is(\":visible\")) {\n                    stopVideoPlaying(sec.attr(\"data-section\"));\n                    sec.slideUp(200).removeClass(ClassNames.STATE_VISIBLE); // Excludes section 0.\n                }\n            });\n            // Log the fact we viewed the section.\n            ajax.call([{\n                methodname: \"format_tiles_log_tile_click\", args: {\n                    courseid: courseId,\n                    sectionid: dataSection\n                }\n            }])[0].fail(Notification.exception);\n            // Get the content - use locally stored content first if available.\n            var relatedContentArea = $(Selector.SECTION_ID + dataSection);\n            if (relatedContentArea.find(Selector.ACTIVITY).length > 0) {\n                // There is already some content on the screen so display immediately.\n                expandSection(relatedContentArea, dataSection);\n\n                // Still contact the server in case content has changed (e.g. restrictions now satisfied).\n                getSectionContentFromServer(courseId, dataSection).done(function (response) {\n                    setCourseContentHTML(relatedContentArea, $(response.html).html(), response.js);\n                });\n            } else {\n                relatedContentArea.html(loadingIconHtml);\n                // Get from server.\n                getSectionContentFromServer(courseId, dataSection).done(function (response) {\n                    setCourseContentHTML(relatedContentArea, $(response.html).html(), response.js);\n                    expandSection(relatedContentArea, dataSection);\n                }).fail(function (failResult) {\n                    failedLoadSectionNotify(dataSection, failResult, relatedContentArea);\n                    cancelTileSelections(dataSection);\n                });\n            }\n            browserStorage.setLastVisitedSection(dataSection);\n        };\n\n        return {\n            init: function (\n                courseIdInit,\n                useJavascriptNav, // Set by site admin see settings.php.\n                isMobileInit,\n                sectionNum,\n                useFilterButtons,\n                assumeDataStoreConsent, // Set by site admin see settings.php.\n                reopenLastSectionInit, // Set by site admin see settings.php.\n                userId,\n                fitTilesToWidth,\n                enableCompletionInit\n            ) {\n                courseId = courseIdInit;\n                isMobile = isMobileInit;\n                // Some args are strings or ints but we prefer bool.  Change to bool now as they are passed on elsewhere.\n                reopenLastVisitedSection = reopenLastSectionInit === \"1\";\n                useFilterButtons = useFilterButtons === 1;\n                assumeDataStoreConsent = assumeDataStoreConsent === \"1\";\n                enableCompletion = enableCompletionInit === \"1\";\n                 // We want to initialise the browser storage JS module for storing user settings.\n                browserStorage.init(\n                    courseId,\n                    false,\n                    sectionNum,\n                    assumeDataStoreConsent,\n                    userId\n                );\n                $(document).ready(function () {\n                    var pageContent = $(\"#page-content\");\n                    if (pageContent.length === 0) {\n                        // Some themes e.g. RemUI do not have a #page-content div, so use #region-main.\n                        pageContent = $(\"#region-main\");\n                    }\n\n                    // If we are being told to launch a section number from the URL, use that.\n                    if (sectionNum !== 0) {\n                        openTile = sectionNum;\n                    } else {\n                        // Don't use the URL param - check local storage instead.\n                        if (reopenLastVisitedSection && browserStorage.storageEnabledLocal) {\n                            openTile = browserStorage.getLastVisitedSection();\n                            // If user is not on mobile, retrieve last visited section id from browser storage (if present).\n                            // And click it.\n                        }\n                    }\n                    if (openTile !== 0) {\n                        tileFitter.init(courseId, openTile, fitTilesToWidth, false);\n                    } else {\n                        // Set focus to the first tile (not section zero).\n                        $(Selector.TILEID + \"1\").focus();\n                        tileFitter.init(courseId, null, fitTilesToWidth, false);\n                    }\n                    var windowWidth = $(window).outerWidth();\n\n                    if (useJavascriptNav) {\n                        // User is not editing but is usingJS nav to view.\n\n                         // On a tile click, decide what to do an do it.\n                         // (Collapse if already expanded, or expand it and fill with content).\n                        pageContent.on(Event.CLICK, Selector.TILE_CLICKABLE, function (e) {\n                            // Prevent the link being followed to reload the PHP page as we are using JS instead.\n                            if (!useJavascriptNav) {\n                                return;\n                            }\n                            e.preventDefault();\n                            // If other tiles have loading icons, fade them out (on the tile not the content sec).\n                            $(Selector.TILE_LOADING_ICON).fadeOut(300, function () {\n                                $(Selector.TILE_LOADING_ICON).html();\n                            });\n                            var thisTile = $(e.currentTarget).closest(Selector.TILE);\n                            var dataSection = parseInt(thisTile.attr(\"data-section\"));\n                            if (thisTile.hasClass(ClassNames.SELECTED)) {\n                                // This tile is already expanded so collapse it.\n                                cancelTileSelections(dataSection);\n                                browserStorage.setLastVisitedSection(0);\n                                overlay.fadeOut(300);\n                            } else {\n                                populateAndExpandSection(courseId, thisTile, dataSection);\n                            }\n                        });\n\n                        overlay.on(Event.CLICK, function(e) {\n                            cancelTileSelections(0);\n                            browserStorage.setLastVisitedSection(0);\n                            clickItemBehind(e);\n                        });\n\n                        // When window is re-sized, content sections under the tiles may be in wrong place.\n                        // So remove them and re-initialise them.\n                        // Collapse the selected section before doing this.\n                        // Otherwise the re-organisation won't work as the tiles' flow will be out when they are analysed.\n                        $(window).on(\"resize\", function () {\n                            // On iOS resize events are triggered often on scroll because the address bar hides itself.\n                            // Avoid this using windowWidth here.\n                            if (resizeLocked || windowWidth === $(window).outerWidth()) {\n                                return;\n                            }\n                            resizeLocked = true;\n\n                            // We wait for a short time before doing anything, as user may still be dragging window size change.\n                            // We don't want to react to say 20 resize events happening over a single drag.\n                            setTimeout(function() {\n                                // First assume that we are going to resize, but we have checks to make below.\n                                var resizeRequired = true;\n\n                                // If we have an iframe in the section in fullscreen, ignore this resize event.\n                                // It was probably caused when user pressed the full screen button.\n                                // This could be a Moodle media player div, or a YouTube embed or other.\n                                var openContentSection = $(\".moveablesection:visible\");\n                                if (openContentSection.length !== 0) {\n                                    var iframes = openContentSection.find(\"iframe\");\n                                    if (iframes.length !== 0) {\n                                        iframes.each(function (index, player) {\n                                            player = $(player);\n                                            if (player.outerWidth() > openContentSection.outerWidth()) {\n                                                // Video is present and playing full screen so don't react to resize event.\n                                                resizeRequired = false;\n                                            }\n                                        });\n                                    }\n                                }\n                                if (resizeRequired) {\n                                    // Set global for comparison next time.\n                                    windowWidth = $(window).outerWidth();\n                                    reOrgSections(true, fitTilesToWidth);\n                                }\n                                resizeLocked = false;\n                            }, 600);\n                        });\n\n                        // When user clicks to close a section using cross at top right in section.\n                        pageContent.on(Event.CLICK, Selector.CLOSE_SEC_BTN, function (e) {\n                            cancelTileSelections($(e.currentTarget).attr(\"data-section\"));\n                        });\n\n                        setSectionZeroFromUserPref();\n                        // Most filter button related JS is in filter_buttons.js module which is required below.\n\n                    }\n\n                    // If this event is triggered, user has updated a completion check box.\n                    // We need to retrieve section content from server in case availability of items has changed.\n                    $(document).on('format-tiles-completion-changed', function(e, data) {\n                        const allSectionNums = $(Selector.TILE).not(Selector.SPACER).map((i, t) => {\n                            return parseInt($(t).attr('data-section'));\n                        }).toArray();\n                        // Need to include sec zero as may have completion tracked items.\n                        allSectionNums.push(0);\n                        const isSingleSectionPage = $('ul#single_section_tiles').length > 0;\n                        const requests = ajax.call([\n                            {\n                                methodname: \"format_tiles_get_single_section_page_html\",\n                                args: {\n                                    courseid: courseId,\n                                    sectionid: data.section,\n                                    setjsusedsession: !isSingleSectionPage\n                                }\n                            },\n                            {\n                                methodname: \"format_tiles_get_section_information\",\n                                args: {\n                                    courseid: courseId,\n                                    sectionnums: allSectionNums\n                                }\n                            }\n                        ]);\n                        requests[0]\n                            .done((response) => {\n                                setCourseContentHTML($(Selector.SECTION_ID + data.section), $(response.html).html(), response.js);\n                            })\n                            .catch(err => {\n                                require([\"core/log\"], function(log) {\n                                    log.debug(err);\n                                });\n                            });\n                        requests[1]\n                            .done((response) => {\n                                require([\"format_tiles/completion\"], function (completion) {\n                                    completion.updateSectionsInfo(\n                                        response.sections, response.overall.complete, response.overall.outof\n                                    );\n                                });\n\n                            })\n                            .catch(err => {\n                                require([\"core/log\"], function(log) {\n                                    log.debug(err);\n                                });\n                            });\n                    });\n\n                    if (enableCompletion) {\n                        // We use pageContent for listener here, as completion button is replaced by core JS when it's clicked.\n                        // We wait half a second to enable the completion change to be registered first.\n                        pageContent.on(Event.CLICK, Selector.MANUAL_COMPLETION, function(e) {\n                            const currentTarget = $(e.currentTarget);\n                            const sectionNum = currentTarget.closest(Selector.SECTION_MAIN).attr(\"data-section\");\n                            const cmid = currentTarget.attr(\"data-cmid\");\n                            require([\"format_tiles/completion\"], function (completion) {\n                                setTimeout(() => {\n                                    completion.triggerCompletionChangedEvent(\n                                        sectionNum ? parseInt(sectionNum) : 0,\n                                        cmid ? parseInt(cmid) : 0\n                                    );\n                                }, 500);\n                            });\n                        });\n                    }\n\n                    const sectionZero = $(Selector.SECTION_ZERO);\n\n                    // When the user presses the button to collapse or expand Section zero (section at the top of the course).\n                    pageContent.on(Event.CLICK, Selector.HIDE_SEC0_BTN, function (e) {\n                        if (sectionZero.css(CSS.DISPLAY) === \"none\") {\n                            // Sec zero is collapsed so expand it on user click.\n                            sectionZero.slideDown(250);\n                            $(e.currentTarget).addClass(ClassNames.OPEN).removeClass(ClassNames.CLOSED);\n                            browserStorage.setSecZeroCollapseStatus(\"collapsed\");\n                        } else {\n                            // Sec zero is expanded so collapse it on user click.\n                            sectionZero.slideUp(250);\n                            $(e.currentTarget).addClass(ClassNames.CLOSED).removeClass(ClassNames.OPEN);\n                            browserStorage.setSecZeroCollapseStatus(\"expanded\");\n                        }\n                    });\n\n                    if (useFilterButtons) {\n                        require([\"format_tiles/filter_buttons\"], function (filterButtons) {\n                            filterButtons.init(courseId, browserStorage.storageEnabledLocal);\n                        });\n                        if (useJavascriptNav) {\n                            pageContent.on(Event.CLICK, Selector.FILTER_BUTTON, function () {\n                                cancelTileSelections(0);\n                                reOrgSections(true, false);\n                            });\n                        }\n\n                    }\n                    // If theme is displaying the .tiles_coursenav class items, show items with this class.\n                    // They will be hidden otherwise.\n                    // They are hidden when initially rendered from PHP as we only want them shown if browser supports JS.\n                    // See lib.php extend_course_navigation.\n                    $(\".tiles_coursenav\").removeClass(\"hidden\");\n\n                    // Render the loading icon and store its HTML globally so that we can use it where needed later.\n                    Templates.render(\"format_tiles/loading\", {}).done(function (html) {\n                        loadingIconHtml = html;\n                    });\n\n                     // Get these strings now, in case we need them.\n                    // E.g. after we lose connection and cannot display content on a user tile click.\n                    var stringKeys = [\n                        {key: \"sectionerrortitle\", component: \"format_tiles\"},\n                        {key: \"sectionerrorstring\", component: \"format_tiles\"},\n                        {key: \"refresh\"},\n                        {key: \"cancel\", component: \"moodle\"},\n                        {key: \"noconnectionerror\", component: \"format_tiles\"},\n                        {key: \"show\"},\n                        {key: \"hide\"},\n                        {key: \"other\", component: \"format_tiles\"}\n                    ];\n                    str.get_strings(stringKeys).done(function (s) {\n                        s.forEach(function(str, index) {\n                            if (str) {\n                                stringStore[stringKeys[index].key] = str;\n                            } else {\n                                stringStore[stringKeys[index].key] = 'Error.';\n                                require([\"core/log\"], function(log) {\n                                    log.debug(`Format tiles get_strings error ${index}`);\n                                    log.debug(s);\n                                });\n                            }\n                        });\n                    })\n                    .fail(function(err) {\n                        require([\"core/log\"], function(log) {\n                            log.debug(err);\n                        });\n                    });\n\n                    // If a mobile user clicks an embedded video activity, we don't show them a modal.\n                    // It won't work well. Instead we direct them to the original site e.g. YouTube.\n                    if (isMobile) {\n                        pageContent.on(Event.CLICK, Selector.ACTIVITY + \".video a\", function(e) {\n                            var target = $(e.currentTarget);\n                            var url = target.closest(Selector.ACTIVITY).attr(\"data-url-secondary\");\n                            if (url !== undefined) {\n                                e.preventDefault();\n                                e.stopPropagation();\n                                var cm = target.closest(Selector.ACTIVITY);\n                                ajax.call([{\n                                    methodname: \"format_tiles_log_mod_view\", args: {\n                                        courseid: courseId,\n                                        cmid: cm.attr(\"data-cmid\")\n                                    }\n                                }])[0].done(function () {\n                                    window.location = url;\n                                });\n                            }\n                        });\n                    } else {\n                        // If user is NOT on mobile device.\n\n                        // If return is pressed while an item is in focus, click the item.\n                        // This is to make the tiles keyboard navigable for users using screen readers.\n                        // User tabbing between tiles is handled by tabindex in the HTML.\n                        // Once the tile is clicked, the expand tile function will move focus to the first content item.\n                        // On escape key, we clear all selections and collapse tiles (handled above not here).\n                        $(Selector.TILE).on(Event.KEYDOWN, function (e) {\n                            if (e.keyCode === Keyboard.RETURN) { // Return key pressed.\n                                $(e.currentTarget).click();\n                            }\n                        });\n\n                        // Move focus to the first tile in the course (not sec zero contents if present).\n                        // $(\"ul.tiles .tile\").first().focus();\n                    }\n                });\n            }\n        };\n    }\n);"],"names":["define","$","Templates","ajax","browserStorage","Notification","str","tileFitter","isMobile","loadingIconHtml","courseId","enableCompletion","stringStore","scrollFuncLock","sectionIsOpen","reopenLastVisitedSection","resizeLocked","openTile","Selector","ClassNames","Event","CSS","Keyboard","stopVideoPlaying","section","contentSection","find","each","index","iframe","attr","length","html","cancelTileSelections","sectionToFocus","sec","is","slideUp","removeClass","css","undefined","focus","fadeOut","overlay","setCourseContentHTML","contentArea","content","js","activities","not","on","e","keyCode","setLastVisitedSection","toClick","currentTarget","hasClass","click","window","location","last","shiftKey","relatedTarget","closest","setTimeout","tooltipItems","tooltip","err","require","log","debug","videoJS","setUp","append","i","el","height","addClass","applyMathJax","MathJax","mathJaxElems","node","Hub","Queue","expandSection","tileId","tile","fadeIn","slideDown","buttons","scrollTo","offset","top","scrollTop","events","page","stop","animate","off","first","iframes","document","trigger","expandAndScroll","windowTop","desiredNewPositionInSection","outerHeight","reOrgSections","delayBefore","fitTilesToScreenWidth","dfd","Deferred","openedSection","openedSectionNum","reOrgFunc","runReOrg","done","result","resolve","fail","reject","resizeTilesDivWidth","promise","getSectionContentFromServer","sectionNum","call","methodname","args","courseid","sectionid","setjsusedsession","populateAndExpandSection","thisTile","dataSection","exception","relatedContentArea","response","failResult","confirm","sectionerrortitle","sectionerrorstring","refresh","cancel","reload","noconnectionerror","Error","failedLoadSectionNotify","init","courseIdInit","useJavascriptNav","isMobileInit","useFilterButtons","assumeDataStoreConsent","reopenLastSectionInit","userId","fitTilesToWidth","enableCompletionInit","ready","pageContent","storageEnabledLocal","getLastVisitedSection","windowWidth","outerWidth","preventDefault","parseInt","clickedItem","hide","BottomElement","elementFromPoint","clientX","clientY","show","clickedTile","clickItemBehind","resizeRequired","openContentSection","player","buttonHideSecZero","sectionZero","getSecZeroCollapseStatus","setSectionZeroFromUserPref","data","allSectionNums","map","t","toArray","push","isSingleSectionPage","requests","sectionnums","catch","completion","updateSectionsInfo","sections","overall","complete","outof","cmid","triggerCompletionChangedEvent","setSecZeroCollapseStatus","filterButtons","render","stringKeys","key","component","get_strings","s","forEach","target","url","stopPropagation","cm"],"mappings":"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"}