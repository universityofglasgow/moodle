/**
 * Grade item selector.
 *
 * @copyright  2019 Frédéric Massart
 * @author     Frédéric Massart <fred@branchup.tech>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/str","core/notification","block_xp/throttler","block_xp/resource-selector"],(function($,Ajax,Str,Notification,Throttler,ResourceSelector){var lastCourseId=null,lastResources=[];function GradeItemResourceSelector(container,searchTermFieldNode){ResourceSelector.prototype.constructor.apply(this,[container,this.filterFunction.bind(this),searchTermFieldNode]),this.resources=lastResources,this.courseId=lastCourseId,this.throttler=new Throttler(200),this.setMinChars(0)}return GradeItemResourceSelector.prototype=Object.create(ResourceSelector.prototype),GradeItemResourceSelector.prototype.constructor=GradeItemResourceSelector,GradeItemResourceSelector.prototype.initForCourse=function(courseId){this.courseId!=courseId?(this.displaySearching(),this.courseId=courseId,this.fetchAllForCourse(courseId).then(function(resources){this.courseId==courseId&&(this.resources=resources,this.displayResults(this.resources),function(courseId,resources){lastCourseId=courseId,lastResources=resources}(this.courseId,this.resources))}.bind(this)).fail(function(){lastCourseId=null,lastResources=[],this.resources=[],this.displayEmptyResults()}.bind(this))):this.displayResults(this.resources)},GradeItemResourceSelector.prototype.fetchAllForCourse=function(courseId){var calls=[{methodname:"local_xp_search_grade_items",args:{courseid:courseId,query:"*"}}];return Ajax.call(calls)[0].then((function(results){return Str.get_strings([{component:"local_xp",key:"categoryn",param:""},{component:"local_xp",key:"maxn",param:""}]).then((()=>results.map((gradeitem=>{var catpath=gradeitem.categories.map((c=>c.name)).join(" > ");return{_isgradeitem:!0,subname:"".concat(M.util.get_string("maxn","local_xp",gradeitem.max))+"".concat(gradeitem.categories.length?" - ".concat(catpath):""),name:gradeitem.name,gradeitem:gradeitem}}))))})).fail((err=>(Notification.exception(err),[])))},GradeItemResourceSelector.prototype.filterFunction=function(term){return(term=(term||"").toLowerCase())?this.resources.filter((function(gi){return gi.name.toLowerCase().indexOf(term)>-1})):this.resources},GradeItemResourceSelector}));

//# sourceMappingURL=grade-item-resource-selector.min.js.map