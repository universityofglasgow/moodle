{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny Equation UI.\n *\n * @module      tiny_equation/ui\n * @copyright   2022 Huong Nguyen <huongnv13@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport EquationModal from 'tiny_equation/modal';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {getLibraries, getTexDocsUrl} from 'tiny_equation/options';\nimport {notifyFilterContentUpdated} from 'core/event';\nimport * as TinyEquationRepository from 'tiny_equation/repository';\nimport {displayException} from 'core/notification';\nimport {debounce} from 'core/utils';\nimport Selectors from 'tiny_equation/selectors';\nimport {getSourceEquation, getCurrentEquationData, setEquation} from 'tiny_equation/equation';\n\nlet currentForm;\nlet lastCursorPos = 0;\n\n/**\n * Handle action\n * @param {TinyMCE} editor\n */\nexport const handleAction = (editor) => {\n    displayDialogue(editor);\n};\n\n/**\n * Display the equation editor\n * @param {TinyMCE} editor\n * @returns {Promise<void>}\n */\nconst displayDialogue = async(editor) => {\n    let data = {};\n    const currentEquationData = getCurrentEquationData(editor);\n    if (currentEquationData) {\n        Object.assign(data, currentEquationData);\n    }\n    const modalPromises = await ModalFactory.create({\n        type: EquationModal.TYPE,\n        templateContext: getTemplateContext(editor, data),\n        large: true,\n    });\n\n    modalPromises.show();\n    const $root = await modalPromises.getRoot();\n    const root = $root[0];\n    currentForm = root.querySelector(Selectors.elements.form);\n\n    $root.on(ModalEvents.hidden, () => {\n        modalPromises.destroy();\n    });\n\n    $root.on(ModalEvents.shown, () => {\n        const library = root.querySelector(Selectors.elements.library);\n        TinyEquationRepository.filterEquation(1, library.innerHTML).then(async data => {\n            library.innerHTML = data.content;\n            updatePreview();\n            notifyFilter(library);\n            return data;\n        }).catch(displayException);\n    });\n\n    root.addEventListener('click', (e) => {\n        const libraryItem = e.target.closest(Selectors.elements.libraryItem);\n        const submitAction = e.target.closest(Selectors.actions.submit);\n        const textArea = e.target.closest('.tiny_equation_equation');\n        if (libraryItem) {\n            e.preventDefault();\n            selectLibraryItem(libraryItem);\n        }\n        if (submitAction) {\n            e.preventDefault();\n            setEquation(currentForm, editor);\n            modalPromises.destroy();\n        }\n        if (textArea) {\n            debounce(updatePreview(), 500);\n        }\n    });\n\n    root.addEventListener('keyup', (e) => {\n        const textArea = e.target.closest(Selectors.elements.equationTextArea);\n        if (textArea) {\n            debounce(updatePreview(), 500);\n        }\n    });\n\n    root.addEventListener('keydown', (e) => {\n        const libraryItem = e.target.closest(Selectors.elements.libraryItem);\n        if (libraryItem) {\n            if (e.keyCode == 37 || e.keyCode == 39) {\n                groupNavigation(e);\n            }\n        }\n    });\n};\n\n/**\n * Get template context.\n * @param {TinyMCE} editor\n * @param {Object} data\n * @returns {Object}\n */\nconst getTemplateContext = (editor, data) => {\n    const libraries = getLibraries(editor);\n    const texDocsUrl = getTexDocsUrl(editor);\n\n    return Object.assign({}, {\n        elementid: editor.id,\n        libraries: libraries,\n        texdocsurl: texDocsUrl,\n        delimiters: Selectors.delimiters,\n    }, data);\n};\n\n/**\n * Handle select library item.\n * @param {Object} libraryItem\n */\nconst selectLibraryItem = (libraryItem) => {\n    const tex = libraryItem.getAttribute('data-tex');\n    const input = currentForm.querySelector(Selectors.elements.equationTextArea);\n    let oldValue;\n    let newValue;\n    let focusPoint = 0;\n\n    oldValue = input.value;\n\n    newValue = oldValue.substring(0, lastCursorPos);\n    if (newValue.charAt(newValue.length - 1) !== ' ') {\n        newValue += ' ';\n    }\n    newValue += tex;\n    focusPoint = newValue.length;\n\n    if (oldValue.charAt(lastCursorPos) !== ' ') {\n        newValue += ' ';\n    }\n    newValue += oldValue.substring(lastCursorPos, oldValue.length);\n\n    input.value = newValue;\n    input.focus();\n\n    input.selectionStart = input.selectionEnd = focusPoint;\n\n    updatePreview();\n};\n\n/**\n * Update the preview section.\n */\nconst updatePreview = () => {\n    const textarea = currentForm.querySelector(Selectors.elements.equationTextArea);\n    const preview = currentForm.querySelector(Selectors.elements.preview);\n    const prefix = '';\n    const cursorLatex = Selectors.cursorLatex;\n    const isChar = /[a-zA-Z{]/;\n    let currentPos = textarea.selectionStart;\n    let equation = textarea.value;\n\n    // Move the cursor so it does not break expressions.\n    // Start at the very beginning.\n    if (!currentPos) {\n        currentPos = 0;\n    }\n\n    if (getSourceEquation()) {\n        currentPos = equation.length;\n    }\n\n    // First move back to the beginning of the line.\n    while (equation.charAt(currentPos) === '\\\\' && currentPos >= 0) {\n        currentPos -= 1;\n    }\n    if (currentPos !== 0) {\n        if (equation.charAt(currentPos - 1) != '{') {\n            // Now match to the end of the line.\n            while (isChar.test(equation.charAt(currentPos)) &&\n                    currentPos < equation.length &&\n                    isChar.test(equation.charAt(currentPos - 1))) {\n                currentPos += 1;\n            }\n        }\n    }\n    // Save the cursor position - for insertion from the library.\n    lastCursorPos = currentPos;\n    equation = prefix + equation.substring(0, currentPos) + cursorLatex + equation.substring(currentPos);\n\n    equation = Selectors.delimiters.start + ' ' + equation + ' ' + Selectors.delimiters.end;\n    TinyEquationRepository.filterEquation(1, equation).then((data) => {\n        preview.innerHTML = data.content;\n        notifyFilter(preview);\n\n        return data;\n    }).catch(displayException);\n};\n\n/**\n * Notify the filters about the modified nodes\n * @param {Element} element\n */\nconst notifyFilter = (element) => {\n    notifyFilterContentUpdated(element);\n};\n\n/**\n * Callback handling the keyboard navigation in the groups of the library.\n * @param {Event} e\n */\nconst groupNavigation = (e) => {\n    e.preventDefault();\n\n    const current = e.target.closest(Selectors.elements.libraryItem);\n    const parent = current.parentNode; // This must be the <div> containing all the buttons of the group.\n    const buttons = Array.prototype.slice.call(parent.querySelectorAll(Selectors.elements.libraryItem));\n    const direction = e.keyCode !== 37 ? 1 : -1;\n    let index = buttons.indexOf(current);\n    let nextButton;\n\n    if (index < 0) {\n        index = 0;\n    }\n\n    index += direction;\n    if (index < 0) {\n        index = buttons.length - 1;\n    } else if (index >= buttons.length) {\n        index = 0;\n    }\n    nextButton = buttons[index];\n    nextButton.focus();\n};\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","currentForm","_modal","_modal_factory","_modal_events","TinyEquationRepository","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_selectors","lastCursorPos","_exports","handleAction","editor","displayDialogue","async","data","currentEquationData","getCurrentEquationData","assign","modalPromises","ModalFactory","create","type","EquationModal","TYPE","templateContext","getTemplateContext","large","show","$root","getRoot","root","querySelector","Selectors","elements","form","on","ModalEvents","hidden","destroy","shown","library","filterEquation","innerHTML","then","content","updatePreview","notifyFilter","catch","displayException","addEventListener","e","libraryItem","target","closest","submitAction","actions","submit","textArea","preventDefault","selectLibraryItem","setEquation","debounce","equationTextArea","keyCode","groupNavigation","libraries","getLibraries","texDocsUrl","getTexDocsUrl","elementid","id","texdocsurl","delimiters","tex","getAttribute","input","oldValue","newValue","focusPoint","value","substring","charAt","length","focus","selectionStart","selectionEnd","textarea","preview","cursorLatex","isChar","currentPos","equation","getSourceEquation","test","start","end","element","notifyFilterContentUpdated","current","parent","parentNode","buttons","Array","slice","querySelectorAll","direction","nextButton","index","indexOf"],"mappings":"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"}