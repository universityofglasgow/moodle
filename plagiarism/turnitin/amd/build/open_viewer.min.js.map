{"version":3,"file":"open_viewer.min.js","sources":["../src/open_viewer.js"],"sourcesContent":["/**\n * Javascript controller for opening the originality report viewreport\n\n * @copyright 2019 Turnitin\n * @author Charlotte Spinks <cspinks@turnitin.com>\n * @module plagiarism_turnitin/open_viewer\n */\n\ndefine(['jquery'], function($) {\n    return {\n        origreport_open: function() {\n            var that = this;\n            $(document).on('click', '.pp_origreport_open', function() {\n                var classList = $(this).attr('class').replace(/\\s+/,' ').split(' ');\n\n                for (var i = 0; i < classList.length; i++) {\n                    if (classList[i].indexOf('origreport_') !== -1 && classList[i] != 'pp_origreport_open') {\n                        var classStr = classList[i].split(\"_\");\n                        that.openDV(\"origreport\", classStr[1], classStr[2]);\n                    }\n                }\n             });\n        },\n\n        grademark_open: function() {\n            var that = this;\n            $(document).on('click', '.pp_grademark_open', function() {\n                var classList = $(this).attr('class').replace(/\\s+/,' ').split(' ');\n\n                for (var i = 0; i < classList.length; i++) {\n                    if (classList[i].indexOf('grademark_') !== -1 && classList[i] != 'pp_grademark_open') {\n                        var classStr = classList[i].split(\"_\");\n                        that.openDV(\"grademark\", classStr[1], classStr[2]);\n                    }\n                }\n            });\n        },\n\n        // Open the DV in a new window in such a way as to not be blocked by popups.\n        openDV: function(dvtype, submissionid, coursemoduleid) {\n          var that = this;\n          var dvWindow = window.open('', 'turnitin_viewer');\n\n          var loading = '<div class=\"tii_dv_loading\" style=\"text-align:center;\">';\n          var icon = '/plagiarism/turnitin/pix/turnitin-icon.png';\n          loading += '<img src=\"' + M.cfg.wwwroot + icon +'\" style=\"width:100px; height: 100px\">';\n          loading += '<p style=\"font-family: Arial, Helvetica, sans-serif;\">' + M.str.plagiarism_turnitin.loadingdv + '</p>';\n          loading += '</div>';\n          $(dvWindow.document.body).html(loading);\n\n          // Get html to launch DV.\n          $.ajax({\n              type: \"POST\",\n              url: M.cfg.wwwroot + \"/plagiarism/turnitin/ajax.php\",\n              dataType: \"json\",\n              data: {\n                  action: \"get_dv_html\",\n                  submissionid: submissionid,\n                  dvtype: dvtype,\n                  cmid: coursemoduleid,\n                  sesskey: M.cfg.sesskey\n              },\n              success: function(data) {\n                  $(dvWindow.document.body).html(loading + data);\n                  dvWindow.document.forms[0].submit();\n                  dvWindow.document.close();\n\n                  that.checkDVClosed(submissionid, coursemoduleid, dvWindow);\n              }\n          });\n        },\n\n        checkDVClosed: function(submissionid, coursemoduleid, dvWindow) {\n            var that = this;\n\n            if (dvWindow.closed) {\n                that.refreshScores(submissionid, coursemoduleid);\n            } else {\n                setTimeout( function(){\n                    that.checkDVClosed(submissionid, coursemoduleid, dvWindow);\n                }, 500);\n            }\n        },\n\n        refreshScores: function(submission_id, coursemoduleid) {\n            var refreshStartTime = new Date().getTime();\n            $.ajax({\n                type: \"POST\",\n                url: M.cfg.wwwroot + \"/plagiarism/turnitin/ajax.php\",\n                dataType: \"json\",\n                data: {\n                    action: \"update_grade\",\n                    submission: submission_id,\n                    cmid: coursemoduleid,\n                    sesskey: M.cfg.sesskey\n                },\n                success: function() {\n                    var requestDuration = new Date().getTime() - refreshStartTime;\n                    if (requestDuration < 3000 || !$('.turnitin_score_refresh_alert').length) {\n                        window.location = window.location + '';\n                    } else {\n                        $('.turnitin_score_refresh_alert').show();\n                    }\n                }\n            });\n        }\n    };\n});\n"],"names":["define","$","origreport_open","that","this","document","on","classList","attr","replace","split","i","length","indexOf","classStr","openDV","grademark_open","dvtype","submissionid","coursemoduleid","dvWindow","window","open","loading","M","cfg","wwwroot","str","plagiarism_turnitin","loadingdv","body","html","ajax","type","url","dataType","data","action","cmid","sesskey","success","forms","submit","close","checkDVClosed","closed","refreshScores","setTimeout","submission_id","refreshStartTime","Date","getTime","submission","location","show"],"mappings":"AAQAA,yCAAO,CAAC,WAAW,SAASC,SACjB,CACHC,gBAAiB,eACTC,KAAOC,KACXH,EAAEI,UAAUC,GAAG,QAAS,uBAAuB,mBACvCC,UAAYN,EAAEG,MAAMI,KAAK,SAASC,QAAQ,MAAM,KAAKC,MAAM,KAEtDC,EAAI,EAAGA,EAAIJ,UAAUK,OAAQD,QACW,IAAzCJ,UAAUI,GAAGE,QAAQ,gBAAyC,sBAAhBN,UAAUI,GAA4B,KAChFG,SAAWP,UAAUI,GAAGD,MAAM,KAClCP,KAAKY,OAAO,aAAcD,SAAS,GAAIA,SAAS,SAMhEE,eAAgB,eACRb,KAAOC,KACXH,EAAEI,UAAUC,GAAG,QAAS,sBAAsB,mBACtCC,UAAYN,EAAEG,MAAMI,KAAK,SAASC,QAAQ,MAAM,KAAKC,MAAM,KAEtDC,EAAI,EAAGA,EAAIJ,UAAUK,OAAQD,QACU,IAAxCJ,UAAUI,GAAGE,QAAQ,eAAwC,qBAAhBN,UAAUI,GAA2B,KAC9EG,SAAWP,UAAUI,GAAGD,MAAM,KAClCP,KAAKY,OAAO,YAAaD,SAAS,GAAIA,SAAS,SAO/DC,OAAQ,SAASE,OAAQC,aAAcC,oBACjChB,KAAOC,KACPgB,SAAWC,OAAOC,KAAK,GAAI,mBAE3BC,QAAU,0DAEdA,SAAW,aAAeC,EAAEC,IAAIC,QAArB,kFACXH,SAAW,yDAA2DC,EAAEG,IAAIC,oBAAoBC,UAAY,OAC5GN,SAAW,SACXtB,EAAEmB,SAASf,SAASyB,MAAMC,KAAKR,SAG/BtB,EAAE+B,KAAK,CACHC,KAAM,OACNC,IAAKV,EAAEC,IAAIC,QAAU,gCACrBS,SAAU,OACVC,KAAM,CACFC,OAAQ,cACRnB,aAAcA,aACdD,OAAQA,OACRqB,KAAMnB,eACNoB,QAASf,EAAEC,IAAIc,SAEnBC,QAAS,SAASJ,MACdnC,EAAEmB,SAASf,SAASyB,MAAMC,KAAKR,QAAUa,MACzChB,SAASf,SAASoC,MAAM,GAAGC,SAC3BtB,SAASf,SAASsC,QAElBxC,KAAKyC,cAAc1B,aAAcC,eAAgBC,cAK3DwB,cAAe,SAAS1B,aAAcC,eAAgBC,cAC9CjB,KAAOC,KAEPgB,SAASyB,OACT1C,KAAK2C,cAAc5B,aAAcC,gBAEjC4B,YAAY,WACR5C,KAAKyC,cAAc1B,aAAcC,eAAgBC,YAClD,MAIX0B,cAAe,SAASE,cAAe7B,oBAC/B8B,kBAAmB,IAAIC,MAAOC,UAClClD,EAAE+B,KAAK,CACHC,KAAM,OACNC,IAAKV,EAAEC,IAAIC,QAAU,gCACrBS,SAAU,OACVC,KAAM,CACFC,OAAQ,eACRe,WAAYJ,cACZV,KAAMnB,eACNoB,QAASf,EAAEC,IAAIc,SAEnBC,QAAS,YACiB,IAAIU,MAAOC,UAAYF,iBACvB,MAAShD,EAAE,iCAAiCW,OAC9DS,OAAOgC,SAAWhC,OAAOgC,SAAW,GAEpCpD,EAAE,iCAAiCqD"}