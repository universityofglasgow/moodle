{"version":3,"file":"grade-item-resource-selector.min.js","sources":["../src/grade-item-resource-selector.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Grade item selector.\n *\n * @copyright  2019 Frédéric Massart\n * @author     Frédéric Massart <fred@branchup.tech>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/str', 'core/notification', 'block_xp/throttler', 'block_xp/resource-selector'],\n    function($, Ajax, Str, Notification, Throttler, ResourceSelector) {\n\n        var lastCourseId = null;\n        var lastResources = [];\n\n        /**\n         * Save local cache.\n         *\n         * @param {Number} courseId The course ID.\n         * @param {Array} resources The resources.\n         */\n        function saveLocalCache(courseId, resources) {\n            lastCourseId = courseId;\n            lastResources = resources;\n        }\n\n        /**\n         * Grade item selector.\n         *\n         * @param {String|jQuery} container The container of the contents.\n         * @param {jQuery} searchTermFieldNode The input field in which the use searches.\n         */\n        function GradeItemResourceSelector(container, searchTermFieldNode) {\n            ResourceSelector.prototype.constructor.apply(this, [container, this.filterFunction.bind(this), searchTermFieldNode]);\n            this.resources = lastResources;\n            this.courseId = lastCourseId;\n            this.throttler = new Throttler(200);\n            this.setMinChars(0);\n        }\n\n        GradeItemResourceSelector.prototype = Object.create(ResourceSelector.prototype);\n        GradeItemResourceSelector.prototype.constructor = GradeItemResourceSelector;\n\n        GradeItemResourceSelector.prototype.initForCourse = function(courseId) {\n            if (this.courseId == courseId) {\n            // The course has not changed, display the contents right away.\n                this.displayResults(this.resources);\n                return;\n            }\n\n            this.displaySearching();\n            this.courseId = courseId;\n            this.fetchAllForCourse(courseId)\n                .then(\n                    function(resources) {\n                        if (this.courseId != courseId) {\n                        // We switched course in the meantime, ignore.\n                            return;\n                        }\n                        this.resources = resources;\n                        this.displayResults(this.resources);\n                        saveLocalCache(this.courseId, this.resources);\n                    }.bind(this)\n                )\n                .fail(function() {\n                    lastCourseId = null;\n                    lastResources = [];\n                    this.resources = [];\n                    this.displayEmptyResults();\n                }.bind(this));\n        };\n\n        GradeItemResourceSelector.prototype.fetchAllForCourse = function(courseId) {\n            var searchargs = {\n                courseid: courseId,\n                query: '*'\n            };\n\n            var calls = [\n                {\n                    methodname: 'local_xp_search_grade_items',\n                    args: searchargs\n                }\n            ];\n\n            return Ajax.call(calls)[0].then(function(results) {\n            // Initially, we used get_strings with the params, but because of MDL-67434,\n            // we're better off making sure that the strings are in cache, and then calling\n            // the synchronous method.\n                return Str.get_strings([\n                    {\n                        component: 'local_xp',\n                        key: 'categoryn',\n                        param: ''\n                    },\n                    {\n                        component: 'local_xp',\n                        key: 'maxn',\n                        param: ''\n                    },\n                ]).then(() => {\n                    return results.map(gradeitem => {\n                        var catpath = gradeitem.categories.map(c => c.name).join(' > ');\n                        return {\n                            _isgradeitem: true,\n                            subname: `${M.util.get_string('maxn', 'local_xp', gradeitem.max)}` +\n                                 `${gradeitem.categories.length ? ` - ${catpath}` : ''}`,\n                            name: gradeitem.name,\n                            gradeitem: gradeitem\n                        };\n                    });\n                });\n            }).fail(err => {\n                Notification.exception(err);\n                return [];\n            });\n        };\n\n        GradeItemResourceSelector.prototype.filterFunction = function(term) {\n            term = (term || '').toLowerCase();\n            if (!term) {\n                return this.resources;\n            }\n            return this.resources.filter(function(gi) {\n                return gi.name.toLowerCase().indexOf(term) > -1;\n            });\n        };\n\n        return GradeItemResourceSelector;\n    });\n"],"names":["define","$","Ajax","Str","Notification","Throttler","ResourceSelector","lastCourseId","lastResources","GradeItemResourceSelector","container","searchTermFieldNode","prototype","constructor","apply","this","filterFunction","bind","resources","courseId","throttler","setMinChars","Object","create","initForCourse","displaySearching","fetchAllForCourse","then","displayResults","saveLocalCache","fail","displayEmptyResults","calls","methodname","args","courseid","query","call","results","get_strings","component","key","param","map","gradeitem","catpath","categories","c","name","join","_isgradeitem","subname","M","util","get_string","max","length","err","exception","term","toLowerCase","filter","gi","indexOf"],"mappings":";;;;;;;AAuBAA,+CAAO,CAAC,SAAU,YAAa,WAAY,oBAAqB,qBAAsB,+BAClF,SAASC,EAAGC,KAAMC,IAAKC,aAAcC,UAAWC,sBAExCC,aAAe,KACfC,cAAgB,YAmBXC,0BAA0BC,UAAWC,qBAC1CL,iBAAiBM,UAAUC,YAAYC,MAAMC,KAAM,CAACL,UAAWK,KAAKC,eAAeC,KAAKF,MAAOJ,2BAC1FO,UAAYV,mBACZW,SAAWZ,kBACXa,UAAY,IAAIf,UAAU,UAC1BgB,YAAY,UAGrBZ,0BAA0BG,UAAYU,OAAOC,OAAOjB,iBAAiBM,WACrEH,0BAA0BG,UAAUC,YAAcJ,0BAElDA,0BAA0BG,UAAUY,cAAgB,SAASL,UACrDJ,KAAKI,UAAYA,eAMhBM,wBACAN,SAAWA,cACXO,kBAAkBP,UAClBQ,KACG,SAAST,WACDH,KAAKI,UAAYA,gBAIhBD,UAAYA,eACZU,eAAeb,KAAKG,oBAvCjBC,SAAUD,WAC9BX,aAAeY,SACfX,cAAgBU,UAsCJW,CAAed,KAAKI,SAAUJ,KAAKG,aACrCD,KAAKF,OAEVe,KAAK,WACFvB,aAAe,KACfC,cAAgB,QACXU,UAAY,QACZa,uBACPd,KAAKF,aAvBFa,eAAeb,KAAKG,YA0BjCT,0BAA0BG,UAAUc,kBAAoB,SAASP,cAMzDa,MAAQ,CACR,CACIC,WAAY,8BACZC,KARS,CACbC,SAAUhB,SACViB,MAAO,cAUJlC,KAAKmC,KAAKL,OAAO,GAAGL,MAAK,SAASW,gBAI9BnC,IAAIoC,YAAY,CACnB,CACIC,UAAW,WACXC,IAAK,YACLC,MAAO,IAEX,CACIF,UAAW,WACXC,IAAK,OACLC,MAAO,MAEZf,MAAK,IACGW,QAAQK,KAAIC,gBACXC,QAAUD,UAAUE,WAAWH,KAAII,GAAKA,EAAEC,OAAMC,KAAK,aAClD,CACHC,cAAc,EACdC,QAAS,UAAGC,EAAEC,KAAKC,WAAW,OAAQ,WAAYV,UAAUW,gBACpDX,UAAUE,WAAWU,oBAAeX,SAAY,IACxDG,KAAMJ,UAAUI,KAChBJ,UAAWA,mBAIxBd,MAAK2B,MACJrD,aAAasD,UAAUD,KAChB,OAIfhD,0BAA0BG,UAAUI,eAAiB,SAAS2C,aAC1DA,MAAQA,MAAQ,IAAIC,eAIb7C,KAAKG,UAAU2C,QAAO,SAASC,WAC3BA,GAAGd,KAAKY,cAAcG,QAAQJ,OAAS,KAHvC5C,KAAKG,WAObT"}