define(["jquery","core/ajax","theme_snap/util","theme_snap/ajax_notification"],function(a,b,c,d){var e=function(b,c){b.find(".snap-asset-completion-tracking").html(c),a(document).trigger("snapModuleCompletionChange",b)},f=function(){a(".course-content").on("submit","form.togglecompletion",function(c){c.preventDefault();var f=a(this);if(!f.hasClass("ajaxing")){var g=a(f).find('input[name="id"]').val(),h=a(f).find('input[name="completionstate"]').val(),i=a(f).parents("li.snap-asset").first();f.addClass("ajaxing"),b.call([{methodname:"theme_snap_course_module_completion",args:{id:g,completionstate:h},done:function(a){d.ifErrorShowBestMsg(a).done(function(b){f.removeClass("ajaxing"),b||e(i,a.completionhtml)})},fail:function(a){d.ifErrorShowBestMsg(a).then(function(){f.removeClass("ajaxing")})}}],!0,!0)}})},g=function(a,b){a.find(".pagemod-content").slideToggle("fast",function(){a.is(".state-expanded")?(a.attr("aria-expanded","true"),a.find(".pagemod-content").focus()):(a.attr("aria-expanded","false"),a.focus())}),b&&e(a,b)},h=function(){var b=".modtype_page .instancename,.pagemod-readmore,.pagemod-content .snap-action-icon";a(document).on("click",b,function(b){var f=a(this).closest(".modtype_page");c.scrollToElement(f);var h=f.hasClass("state-expanded");f.toggleClass("state-expanded");var i=f.find(".pagemod-readmore"),j=f.find(".pagemod-content");if(1==j.data("content-loaded")){g(f);var k=M.cfg.wwwroot+"/theme/snap/rest.php?action=read_page&contextid="+i.data("pagemodcontext");h||a.ajax({type:"GET",async:!0,url:k,success:function(a){d.ifErrorShowBestMsg(a).done(function(b){b||e(f,a.completionhtml)})}})}else if(h)g(f);else{f.find(".contentafterlink").prepend('<div class="ajaxstatus alert alert-info">'+M.str.theme_snap.loading+"</div>");var l=M.cfg.wwwroot+"/theme/snap/rest.php?action=get_page&contextid="+i.data("pagemodcontext");a.ajax({type:"GET",async:!0,url:l,success:function(a){d.ifErrorShowBestMsg(a).done(function(b){b||(j.prepend(a.html),j.data("content-loaded",1),f.find(".contentafterlink .ajaxstatus").remove(),g(f,a.completionhtml))})}})}b.preventDefault()})},i=function(b){var c=function(b,c){var d=a("#snap-light-box");return 0===d.length&&(a(b).append('<div id="snap-light-box" tabindex="-1"><div id="snap-light-box-content"></div><a id="snap-light-box-close" class="pull-right snap-action-icon snap-icon-close" href="#"><small>Close</small></a></div>'),a("#snap-light-box-close").click(function(a){a.preventDefault(),a.stopPropagation(),f(),"function"==typeof c&&c()}),d=a("#snap-light-box")),d},f=function(){var a=c();a.remove()},g=function(b,d,e){d=d?d:a("body");var f=c(d,e);if(b){var g=a("#snap-light-box-content");g.html(""),g.append(b)}f.addClass("state-visible")},h=a("body"),i='<div class="loadingstat three-quarters">'+Y.Escape.html(M.util.get_string("loading","theme_snap"))+"</div>";g(i,h,function(){a(b).attr("tabindex","-1").focus(),a(b).removeAttr("tabindex")}),a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_media&contextid="+a(b).data("modcontext"),success:function(c){d.ifErrorShowBestMsg(c).done(function(d){d||(g(c.html,h),e(a(b),c.completionhtml),a(document).trigger("snapContentRevealed"),a("#snap-light-box").focus())})}})};return{init:function(){h(),f(),a(document).on("click","[data-action=hide],[data-action=show]",function(){a(this).closest("li.activity").toggleClass("draft")}),a(document).on("click",'.js-snap-media .snap-asset-link [href*="/mod/resource/view.php?id="]',function(b){i(a(this).closest(".snap-resource")),b.preventDefault()}),a(document).on("click",".snap-resource-card .snap-resource",function(b){var c=a(b.target),d="_self",e=a(c).closest(".snap-resource").find(".snap-asset-link a"),f="";e.length>0&&(f=a(e).attr("href"));var g=".snap-asset-completion-tracking, .snap-asset-actions, .contentafterlink a, .ally-actions",h=a(c).closest(g).length;if(!h){if(a(this).hasClass("js-snap-media"))i(this);else{if(""===f)return;"_blank"===a(e).attr("target")&&(d="_blank"),window.open(f,d)}b.preventDefault()}})}}});